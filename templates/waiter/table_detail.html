{% extends "base.html" %}

{% block title %}Mesa {{ table.number }} - Mesero{% endblock %}

{% block content %}
<div class="container-fluid tablet-friendly">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-table"></i> Mesa {{ table.number }}</h2>
        <a href="{{ url_for('waiter.tables') }}" class="btn btn-outline-secondary btn-touch">
            <i class="bi bi-arrow-left"></i> Volver a Mesas
        </a>
    </div>
    
    <div class="row">
        <!-- Order Section -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        {% if is_tab %}
                        <h5><i class="bi bi-receipt-cutoff"></i> Tab Abierto</h5>
                        <span class="badge bg-info">{{ current_sale.customer_name }}</span>
                        {% else %}
                        <h5><i class="bi bi-clipboard-check"></i> Pedido Actual</h5>
                        {% if current_sale %}
                        <span class="badge bg-warning">En Progreso</span>
                        {% else %}
                        <span class="badge bg-success">Nueva Mesa</span>
                        {% endif %}
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    {% if current_sale and current_sale.sale_items %}
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th>Cantidad</th>
                                    <th>Precio</th>
                                    <th>Total</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="sale-items">
                                {% for item in current_sale.sale_items %}
                                <tr data-item-id="{{ item.id }}">
                                    <td>{{ item.product.name }}</td>
                                    <td>
                                        <div class="d-flex align-items-center justify-content-center">
                                            <button class="btn btn-sm btn-outline-secondary me-2" onclick="updateQuantity({{ item.id }}, {{ item.quantity - 1 }})" {% if item.quantity <= 1 %}disabled{% endif %}>
                                                <i class="bi bi-dash"></i>
                                            </button>
                                            <span class="fw-bold" id="quantity-{{ item.id }}">{{ item.quantity }}</span>
                                            <button class="btn btn-sm btn-outline-secondary ms-2" onclick="updateQuantity({{ item.id }}, {{ item.quantity + 1 }})">
                                                <i class="bi bi-plus"></i>
                                            </button>
                                        </div>
                                    </td>
                                    <td>RD$ {{ "%.2f"|format(item.unit_price) }}</td>
                                    <td id="item-total-{{ item.id }}">RD$ {{ "%.2f"|format(item.total_price) }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-danger" onclick="removeItem({{ item.id }})">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <div class="d-grid gap-2">
                                {% if not is_tab %}
                                <button class="btn btn-info btn-touch" onclick="sendToKitchen()">
                                    <i class="bi bi-send"></i> Enviar a Cocina
                                </button>
                                {% endif %}
                                <button class="btn btn-warning btn-touch" onclick="showSplitBillModal()">
                                    <i class="bi bi-scissors"></i> Dividir Cuenta
                                </button>
                                <button class="btn btn-danger btn-touch" onclick="cancelTable()">
                                    <i class="bi bi-x-circle"></i> Cancelar {{ 'Tab' if is_tab else 'Pedido' }}
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6>Total {{ 'del Tab' if is_tab else 'del Pedido' }}</h6>
                                    {% if is_tab %}
                                    <h4 class="text-primary" id="tab-total">RD$ {{ "%.2f"|format(current_sale.sale_items|sum(attribute='total_price')) }}</h4>
                                    {% else %}
                                    <h4 class="text-primary">RD$ {{ "%.2f"|format(current_sale.total) }}</h4>
                                    {% endif %}
                                    {% if is_tab %}
                                    <button class="btn btn-info btn-touch w-100 mt-2" onclick="closeTab()">
                                        <i class="bi bi-cash-stack"></i> Cerrar Tab y Cobrar
                                    </button>
                                    {% else %}
                                    <button class="btn btn-success btn-touch w-100 mt-2" onclick="closeTable()">
                                        <i class="bi bi-check-circle"></i> Cerrar Mesa
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-clipboard text-muted" style="font-size: 3rem;"></i>
                        <h5 class="text-muted mt-3">No hay productos en el pedido</h5>
                        <p class="text-muted">Agrega productos del men√∫ para comenzar</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Menu Section -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-grid"></i> Men√∫</h5>
                </div>
                <div class="card-body">
                    <!-- Category Tabs for Waiter -->
                    <div class="nav nav-pills flex-column mb-3" id="waiter-category-tabs">
                        {% for category in categories %}
                        <button class="nav-link {% if loop.first %}active{% endif %} mb-2 btn-touch" 
                                data-bs-toggle="pill" 
                                data-bs-target="#waiter-category-{{ category.id }}">
                            {{ category.name }}
                        </button>
                        {% endfor %}
                    </div>
                    
                    <!-- Product Lists for Waiter -->
                    <div class="tab-content">
                        {% for category in categories %}
                        <div class="tab-pane fade {% if loop.first %}show active{% endif %}" 
                             id="waiter-category-{{ category.id }}">
                            <div id="waiter-products-{{ category.id }}">
                                <!-- Products will be loaded via JavaScript -->
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Split Bill Modal -->
<div class="modal fade" id="splitBillModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-scissors me-2"></i>Dividir Cuenta</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Split Type Selection -->
                <div class="mb-4">
                    <label class="form-label fw-bold">Tipo de Divisi√≥n</label>
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="splitType" id="splitTypeEqual" value="equal" checked>
                        <label class="btn btn-outline-primary" for="splitTypeEqual">
                            <i class="bi bi-pie-chart"></i> Equitativa
                        </label>
                        
                        <input type="radio" class="btn-check" name="splitType" id="splitTypeItems" value="by_items">
                        <label class="btn btn-outline-primary" for="splitTypeItems">
                            <i class="bi bi-list-check"></i> Por Items
                        </label>
                        
                        <input type="radio" class="btn-check" name="splitType" id="splitTypeCustom" value="custom">
                        <label class="btn btn-outline-primary" for="splitTypeCustom">
                            <i class="bi bi-sliders"></i> Personalizada
                        </label>
                    </div>
                </div>

                <!-- Equal Split Options -->
                <div id="equalSplitOptions" class="split-options">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        Divide el total de la cuenta equitativamente entre todas las personas.
                    </div>
                    <div class="mb-3">
                        <label for="numPeople" class="form-label">N√∫mero de Personas</label>
                        <input type="number" class="form-control form-control-lg" id="numPeople" min="2" max="10" value="2">
                    </div>
                    <div id="equalSplitPreview" class="card bg-light">
                        <div class="card-body">
                            <h6 class="card-title">Vista Previa</h6>
                            <p class="mb-0">Cada persona pagar√°: <strong id="amountPerPerson">RD$ 0.00</strong></p>
                        </div>
                    </div>
                </div>

                <!-- By Items Split Options -->
                <div id="byItemsSplitOptions" class="split-options d-none">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        Asigna items espec√≠ficos a cada persona. Todos los items deben ser asignados.
                    </div>
                    <div class="mb-3">
                        <label class="form-label">N√∫mero de Divisiones</label>
                        <input type="number" class="form-control" id="numSplits" min="2" max="5" value="2" onchange="generateItemSplits()">
                    </div>
                    <div id="itemSplitsContainer"></div>
                </div>

                <!-- Custom Split Options -->
                <div id="customSplitOptions" class="split-options d-none">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        Define porcentajes o montos espec√≠ficos para cada persona.
                    </div>
                    <div class="mb-3">
                        <label class="form-label">M√©todo de Divisi√≥n</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="customMethod" id="customMethodPercent" value="percentage" checked>
                            <label class="btn btn-outline-secondary" for="customMethodPercent">Porcentajes</label>
                            
                            <input type="radio" class="btn-check" name="customMethod" id="customMethodAmount" value="amount">
                            <label class="btn btn-outline-secondary" for="customMethodAmount">Montos Fijos</label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">N√∫mero de Divisiones</label>
                        <input type="number" class="form-control" id="numCustomSplits" min="2" max="5" value="2" onchange="generateCustomSplits()">
                    </div>
                    <div id="customSplitsContainer"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="confirmSplitBill()">
                    <i class="bi bi-check-circle me-2"></i>Dividir Cuenta
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentSale = {% if current_sale %}{{ current_sale.id }}{% else %}null{% endif %};
const tableId = {{ table.id }};
const isTab = {% if is_tab %}true{% else %}false{% endif %};
const csrfToken = "{{ csrf_token() }}";

// Load products for category
function loadWaiterProducts(categoryId) {
    fetch(`/api/products?category_id=${categoryId}`)
        .then(response => response.json())
        .then(products => {
            const container = document.getElementById(`waiter-products-${categoryId}`);
            container.innerHTML = '';
            
            products.forEach(product => {
                // Determine stock status
                let stockBadge = '';
                let isDisabled = false;
                let cardStyle = '';
                
                if (product.product_type === 'consumible') {
                    stockBadge = '<span class="badge bg-info">Disponible</span>';
                    isDisabled = false;
                } else if (product.stock <= 0) {
                    stockBadge = '<span class="badge bg-danger">Agotado</span>';
                    isDisabled = true;
                    cardStyle = 'opacity: 0.5; cursor: not-allowed;';
                } else if (product.stock <= product.min_stock) {
                    stockBadge = `<span class="badge bg-warning text-dark">Stock: ${product.stock} ‚ö†Ô∏è</span>`;
                } else {
                    stockBadge = `<span class="badge bg-success">Stock: ${product.stock} ‚úì</span>`;
                }
                
                const productCard = `
                    <div class="card mb-2 product-card" ${isDisabled ? '' : `onclick="addProductToOrder(${product.id}, '${product.name}', ${product.price})"`}
                         style="${cardStyle}">
                        <div class="card-body text-center py-3">
                            <h6 class="card-title mb-1">${product.name}</h6>
                            <p class="card-text text-primary fw-bold">RD$ ${product.price.toFixed(2)}</p>
                            <div class="mt-2">${stockBadge}</div>
                        </div>
                    </div>
                `;
                container.innerHTML += productCard;
            });
        });
}

// Add product to current order
async function addProductToOrder(productId, productName, price) {
    if (!currentSale) {
        // Create new sale
        try {
            const response = await fetch('/api/sales', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    table_id: tableId
                })
            });
            
            if (response.ok) {
                const sale = await response.json();
                currentSale = sale.id;
                
                // Update table status to occupied
                await fetch(`/api/tables/${tableId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        status: 'occupied'
                    })
                });
            } else {
                alert('Error creando el pedido');
                return;
            }
        } catch (error) {
            alert('Error de conexi√≥n');
            return;
        }
    }
    
    // Add item to sale (works for both regular sales and tabs)
    try {
        const response = await fetch(`/api/sales/${currentSale}/items`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                product_id: productId,
                quantity: 1
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            // Reload page to show updated order
            location.reload();
        } else {
            alert(data.error || 'Error agregando producto');
        }
    } catch (error) {
        alert('Error de conexi√≥n');
        console.error('Add product error:', error);
    }
}

// Send order to kitchen with durable order status tracking
async function sendToKitchen() {
    if (!currentSale) {
        alert('No hay pedido para enviar a cocina');
        return;
    }
    
    if (confirm('¬øConfirmas enviar este pedido a cocina?')) {
        try {
            // Use the proper kitchen workflow API
            const response = await fetch(`/api/sales/${currentSale}/send-to-kitchen`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            if (response.ok) {
                const result = await response.json();
                
                // Show success message with order status
                alert(`‚úÖ ${result.message}\n\n` +
                      `üìã Estado del Pedido: ${result.order_status}\n` +
                      `üçΩÔ∏è Total: RD$ ${result.total.toFixed(2)}\n\n` +
                      `El pedido ahora est√° en la cola de la cocina.`);
                
                // Update the button to show current order status
                const kitchenBtn = document.querySelector('[onclick="sendToKitchen()"]');
                if (kitchenBtn) {
                    const originalText = kitchenBtn.innerHTML;
                    kitchenBtn.innerHTML = '<i class="bi bi-check-circle"></i> Enviado a Cocina';
                    kitchenBtn.disabled = true;
                    kitchenBtn.classList.remove('btn-info');
                    kitchenBtn.classList.add('btn-success');
                    
                    // Add order status indicator
                    const statusBadge = document.createElement('div');
                    statusBadge.className = 'mt-2';
                    statusBadge.innerHTML = `<span class="badge bg-warning">Estado: ${result.order_status}</span>`;
                    kitchenBtn.parentNode.appendChild(statusBadge);
                }
                
                // Add order status display to the order section
                const orderHeader = document.querySelector('.card-header h5');
                if (orderHeader && !document.getElementById('order-status-badge')) {
                    const statusBadge = document.createElement('span');
                    statusBadge.id = 'order-status-badge';
                    statusBadge.className = 'badge bg-info ms-2';
                    statusBadge.textContent = `Estado: ${result.order_status}`;
                    orderHeader.appendChild(statusBadge);
                }
                
            } else {
                const error = await response.json();
                alert('Error enviando pedido a cocina: ' + (error.error || 'Error desconocido'));
            }
        } catch (error) {
            alert('Error de conexi√≥n enviando pedido a cocina');
            console.error('Kitchen send error:', error);
        }
    }
}

// Split bill functionality
let splitBillModal;
let saleItems = {% if current_sale and current_sale.sale_items %}{{ current_sale.sale_items | tojson }}{% else %}[]{% endif %};

function showSplitBillModal() {
    if (!currentSale) {
        alert('No hay pedido para dividir');
        return;
    }
    
    if (!saleItems || saleItems.length === 0) {
        alert('No hay items en el pedido para dividir');
        return;
    }
    
    // Initialize modal
    splitBillModal = new bootstrap.Modal(document.getElementById('splitBillModal'));
    
    // Setup event listeners for split type changes
    document.querySelectorAll('input[name="splitType"]').forEach(radio => {
        radio.addEventListener('change', function() {
            switchSplitType(this.value);
        });
    });
    
    // Setup event listeners for custom method changes
    document.querySelectorAll('input[name="customMethod"]').forEach(radio => {
        radio.addEventListener('change', function() {
            generateCustomSplits();
        });
    });
    
    // Setup event listener for numPeople changes
    document.getElementById('numPeople').addEventListener('input', updateEqualSplitPreview);
    
    // Initialize with equal split
    switchSplitType('equal');
    updateEqualSplitPreview();
    
    splitBillModal.show();
}

function switchSplitType(type) {
    // Hide all option sections
    document.querySelectorAll('.split-options').forEach(div => {
        div.classList.add('d-none');
    });
    
    // Show selected option section
    if (type === 'equal') {
        document.getElementById('equalSplitOptions').classList.remove('d-none');
        updateEqualSplitPreview();
    } else if (type === 'by_items') {
        document.getElementById('byItemsSplitOptions').classList.remove('d-none');
        generateItemSplits();
    } else if (type === 'custom') {
        document.getElementById('customSplitOptions').classList.remove('d-none');
        generateCustomSplits();
    }
}

function updateEqualSplitPreview() {
    const numPeople = parseInt(document.getElementById('numPeople').value) || 2;
    const total = getSaleTotal();
    const amountPerPerson = total / numPeople;
    
    document.getElementById('amountPerPerson').textContent = `RD$ ${amountPerPerson.toFixed(2)}`;
}

function getSaleTotal() {
    {% if is_tab %}
    // For tabs, calculate from items
    return {% if current_sale %}{{ current_sale.sale_items|sum(attribute='total_price') }}{% else %}0{% endif %};
    {% else %}
    // For regular sales, use total
    return {{ current_sale.total if current_sale else 0 }};
    {% endif %}
}

function generateItemSplits() {
    const numSplits = parseInt(document.getElementById('numSplits').value) || 2;
    const container = document.getElementById('itemSplitsContainer');
    container.innerHTML = '';
    
    for (let i = 0; i < numSplits; i++) {
        const splitDiv = document.createElement('div');
        splitDiv.className = 'card mb-3';
        splitDiv.innerHTML = `
            <div class="card-header">
                <strong>Divisi√≥n ${i + 1}</strong>
            </div>
            <div class="card-body">
                <div class="mb-2">
                    <label class="form-label">Nombre del Cliente</label>
                    <input type="text" class="form-control split-customer-name" placeholder="Cliente ${i + 1}" data-split-index="${i}">
                </div>
                <div class="mb-2">
                    <label class="form-label">Items Asignados</label>
                    <div class="form-check-list split-items-list" data-split-index="${i}">
                        ${generateItemCheckboxes(i)}
                    </div>
                </div>
                <div class="split-total text-end">
                    <strong>Total: <span id="split-${i}-total">RD$ 0.00</span></strong>
                </div>
            </div>
        `;
        container.appendChild(splitDiv);
    }
    
    // Add event listeners to checkboxes
    document.querySelectorAll('.item-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateItemSplitTotals);
    });
}

function generateItemCheckboxes(splitIndex) {
    if (!saleItems || saleItems.length === 0) {
        return '<p class="text-muted">No hay items disponibles</p>';
    }
    
    return saleItems.map(item => `
        <div class="form-check">
            <input class="form-check-input item-checkbox" type="checkbox" 
                   id="item-${item.id}-split-${splitIndex}" 
                   value="${item.id}" 
                   data-split-index="${splitIndex}"
                   data-item-price="${item.total_price}">
            <label class="form-check-label" for="item-${item.id}-split-${splitIndex}">
                ${item.product.name} (x${item.quantity}) - RD$ ${item.total_price.toFixed(2)}
            </label>
        </div>
    `).join('');
}

function updateItemSplitTotals() {
    const numSplits = parseInt(document.getElementById('numSplits').value) || 2;
    
    for (let i = 0; i < numSplits; i++) {
        let total = 0;
        document.querySelectorAll(`.item-checkbox[data-split-index="${i}"]:checked`).forEach(checkbox => {
            total += parseFloat(checkbox.dataset.itemPrice);
        });
        
        const totalElement = document.getElementById(`split-${i}-total`);
        if (totalElement) {
            totalElement.textContent = `RD$ ${total.toFixed(2)}`;
        }
    }
}

function generateCustomSplits() {
    const numSplits = parseInt(document.getElementById('numCustomSplits').value) || 2;
    const method = document.querySelector('input[name="customMethod"]:checked')?.value || 'percentage';
    const container = document.getElementById('customSplitsContainer');
    const total = getSaleTotal();
    
    container.innerHTML = '';
    
    for (let i = 0; i < numSplits; i++) {
        const splitDiv = document.createElement('div');
        splitDiv.className = 'card mb-2';
        splitDiv.innerHTML = `
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label">Nombre del Cliente</label>
                        <input type="text" class="form-control custom-customer-name" placeholder="Cliente ${i + 1}" data-split-index="${i}">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">${method === 'percentage' ? 'Porcentaje (%)' : 'Monto (RD$)'}</label>
                        <input type="number" class="form-control custom-split-value" 
                               data-split-index="${i}" 
                               min="0" 
                               ${method === 'percentage' ? 'max="100"' : ''}
                               step="${method === 'percentage' ? '0.1' : '0.01'}"
                               placeholder="${method === 'percentage' ? '50' : total / numSplits}">
                    </div>
                </div>
            </div>
        `;
        container.appendChild(splitDiv);
    }
}

async function confirmSplitBill() {
    const splitType = document.querySelector('input[name="splitType"]:checked').value;
    
    let requestData = {
        split_type: splitType,
        csrf_token: csrfToken
    };
    
    try {
        if (splitType === 'equal') {
            const numPeople = parseInt(document.getElementById('numPeople').value);
            if (numPeople < 2) {
                alert('El n√∫mero de personas debe ser al menos 2');
                return;
            }
            requestData.num_people = numPeople;
            
        } else if (splitType === 'by_items') {
            const numSplits = parseInt(document.getElementById('numSplits').value);
            const splits = [];
            
            for (let i = 0; i < numSplits; i++) {
                const customerName = document.querySelector(`.split-customer-name[data-split-index="${i}"]`)?.value || `Cliente ${i + 1}`;
                const checkedItems = Array.from(document.querySelectorAll(`.item-checkbox[data-split-index="${i}"]:checked`))
                    .map(cb => parseInt(cb.value));
                
                if (checkedItems.length === 0) {
                    alert(`La divisi√≥n ${i + 1} no tiene items asignados`);
                    return;
                }
                
                splits.push({
                    customer_name: customerName,
                    items: checkedItems
                });
            }
            
            // Validate all items are assigned exactly once
            const allItemIds = saleItems.map(item => item.id);
            const assignedIds = splits.flatMap(s => s.items);
            
            if (assignedIds.length !== allItemIds.length) {
                alert('Todos los items deben ser asignados a una divisi√≥n');
                return;
            }
            
            requestData.splits = splits;
            
        } else if (splitType === 'custom') {
            const numSplits = parseInt(document.getElementById('numCustomSplits').value);
            const method = document.querySelector('input[name="customMethod"]:checked').value;
            const splits = [];
            const total = getSaleTotal();
            
            for (let i = 0; i < numSplits; i++) {
                const customerName = document.querySelector(`.custom-customer-name[data-split-index="${i}"]`)?.value || `Cliente ${i + 1}`;
                const value = parseFloat(document.querySelector(`.custom-split-value[data-split-index="${i}"]`)?.value);
                
                if (!value || value <= 0) {
                    alert(`Debe especificar un valor v√°lido para la divisi√≥n ${i + 1}`);
                    return;
                }
                
                const split = { customer_name: customerName };
                
                if (method === 'percentage') {
                    split.percentage = value;
                } else {
                    split.amount = value;
                }
                
                splits.push(split);
            }
            
            // Validate totals
            if (method === 'percentage') {
                const totalPercent = splits.reduce((sum, s) => sum + s.percentage, 0);
                if (Math.abs(totalPercent - 100) > 0.01) {
                    alert(`Los porcentajes deben sumar 100%. Total actual: ${totalPercent.toFixed(2)}%`);
                    return;
                }
            } else {
                const totalAmount = splits.reduce((sum, s) => sum + s.amount, 0);
                if (Math.abs(totalAmount - total) > 0.01) {
                    alert(`Los montos deben sumar el total (RD$ ${total.toFixed(2)}). Total actual: RD$ ${totalAmount.toFixed(2)}`);
                    return;
                }
            }
            
            requestData.splits = splits;
        }
        
        // Confirm with user
        if (!confirm(`¬øConfirma dividir esta cuenta en ${splitType === 'equal' ? requestData.num_people : requestData.splits.length} partes?`)) {
            return;
        }
        
        // Make API request
        const response = await fetch(`/api/sales/${currentSale}/split`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            splitBillModal.hide();
            
            // Show success message
            let message = `‚úÖ Cuenta dividida exitosamente en ${result.splits.length} partes:\n\n`;
            result.splits.forEach((split, i) => {
                message += `${i + 1}. ${split.customer_name}: RD$ ${split.total.toFixed(2)} (${split.items_count} items)\n`;
            });
            message += `\nLas ventas han sido creadas y est√°n listas para ser facturadas por el cajero.`;
            
            alert(message);
            
            // Redirect back to tables
            window.location.href = "{{ url_for('waiter.tables') }}";
        } else {
            alert(`Error dividiendo cuenta: ${result.error || 'Error desconocido'}`);
        }
        
    } catch (error) {
        console.error('Error splitting bill:', error);
        alert('Error de conexi√≥n al dividir cuenta');
    }
}

// Send table to cashier for finalization
async function closeTable() {
    if (!currentSale) {
        alert('No hay pedido para cerrar');
        return;
    }
    
    // Get current sale total for confirmation
    const saleTotal = document.querySelector('h4.text-primary')?.textContent || 'RD$ 0.00';
    
    if (confirm(`¬øConfirmas enviar esta mesa al cajero para finalizaci√≥n?\n\nTotal del pedido: ${saleTotal}\n\nEl cajero se encargar√° de:\n- Generar NCF\n- Procesar el pago\n- Finalizar la venta`)) {
        try {
            // Use the proper table close endpoint for cashier handoff
            const response = await fetch(`/api/tables/${tableId}/close`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'finalize'  // Indicate this is for finalization
                })
            });
            
            if (response.ok) {
                const result = await response.json();
                
                if (result.requires_finalization) {
                    // Table handed off successfully to cashier
                    alert(`‚úÖ Mesa ${tableId} enviada al cajero exitosamente!\n\n` +
                          `üßæ ID de Venta: ${result.sale_id}\n` +
                          `üí∞ Total: ${saleTotal}\n\n` +
                          `El cajero debe usar el ID de venta ${result.sale_id} para finalizar el pedido con NCF y pago.`);
                } else {
                    alert(result.message || 'Mesa enviada al cajero exitosamente.');
                }
                
                // Return to tables view
                window.location.href = "{{ url_for('waiter.tables') }}";
            } else {
                const error = await response.json();
                if (error.error && error.error.includes('meseros deben entregar')) {
                    alert('‚úã Solo los cajeros pueden finalizar ventas.\n\nEsta mesa ha sido preparada para que un cajero la finalice con NCF y procesamiento de pago.');
                } else {
                    alert(error.error || 'Error enviando mesa al cajero');
                }
            }
        } catch (error) {
            alert('Error de conexi√≥n enviando mesa al cajero');
            console.error('Close table error:', error);
        }
    }
}

// Cancel table and clear sale
async function cancelTable() {
    if (!currentSale) {
        // No sale, just mark table available
        await fetch(`/api/tables/${tableId}/status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                status: 'available'
            })
        });
        window.location.href = "{{ url_for('waiter.tables') }}";
        return;
    }
    
    if (confirm('¬øConfirmas cancelar el pedido y liberar la mesa?')) {
        try {
            const response = await fetch(`/api/tables/${tableId}/close`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'cancel'
                })
            });
            
            if (response.ok) {
                alert('Pedido cancelado y mesa liberada.');
                window.location.href = "{{ url_for('waiter.tables') }}";
            } else {
                const error = await response.json();
                alert(error.error || 'Error cancelando pedido');
            }
        } catch (error) {
            alert('Error de conexi√≥n');
        }
    }
}

// Update item quantity
async function updateQuantity(itemId, newQuantity) {
    if (newQuantity <= 0) {
        // If quantity would be 0 or negative, remove the item instead
        removeItem(itemId);
        return;
    }
    
    // Add visual feedback while updating
    const quantitySpan = document.getElementById(`quantity-${itemId}`);
    const originalBg = quantitySpan?.style.backgroundColor;
    if (quantitySpan) {
        quantitySpan.style.backgroundColor = '#fff3cd';
        quantitySpan.style.transition = 'background-color 0.3s ease';
    }
    
    try {
        const response = await fetch(`/api/sales/${currentSale}/items/${itemId}/quantity`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                quantity: newQuantity
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            
            // Update the UI with new values
            if (quantitySpan) {
                quantitySpan.textContent = result.new_quantity;
                // Brief success highlight
                quantitySpan.style.backgroundColor = '#d1e7dd';
                setTimeout(() => {
                    quantitySpan.style.backgroundColor = originalBg || '';
                }, 1000);
            }
            
            const itemTotalElement = document.getElementById(`item-total-${itemId}`);
            if (itemTotalElement) {
                itemTotalElement.textContent = `RD$ ${result.new_item_total.toFixed(2)}`;
            }
            
            // Update the sale total display
            const saleTotalElement = document.querySelector('h4.text-primary');
            if (saleTotalElement) {
                saleTotalElement.textContent = `RD$ ${result.new_sale_total.toFixed(2)}`;
            }
            
            // Update button states and onclick handlers
            const itemRow = document.querySelector(`tr[data-item-id="${itemId}"]`);
            if (itemRow) {
                const minusBtn = itemRow.querySelector('.btn-outline-secondary[onclick*="updateQuantity"]');
                const plusBtn = itemRow.querySelectorAll('.btn-outline-secondary[onclick*="updateQuantity"]')[1];
                
                if (minusBtn) {
                    minusBtn.disabled = result.new_quantity <= 1;
                    minusBtn.setAttribute('onclick', `updateQuantity(${itemId}, ${result.new_quantity - 1})`);
                }
                if (plusBtn) {
                    plusBtn.setAttribute('onclick', `updateQuantity(${itemId}, ${result.new_quantity + 1})`);
                }
            }
            
        } else {
            const error = await response.json();
            if (quantitySpan) {
                quantitySpan.style.backgroundColor = '#f8d7da'; // Error highlight
                setTimeout(() => {
                    quantitySpan.style.backgroundColor = originalBg || '';
                }, 2000);
            }
            alert(error.error || 'Error actualizando cantidad');
        }
    } catch (error) {
        if (quantitySpan) {
            quantitySpan.style.backgroundColor = '#f8d7da'; // Error highlight
            setTimeout(() => {
                quantitySpan.style.backgroundColor = originalBg || '';
            }, 2000);
        }
        alert('Error de conexi√≥n');
        console.error('Update quantity error:', error);
    }
}

// Remove item from order
async function removeItem(itemId) {
    if (confirm('¬øEliminar este producto del pedido?')) {
        try {
            const response = await fetch(`/api/sales/${currentSale}/items/${itemId}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                const result = await response.json();
                
                // Remove the item row from the table in real-time
                const itemRow = document.querySelector(`tr[data-item-id="${itemId}"]`);
                if (itemRow) {
                    // Add a fade-out animation
                    itemRow.style.transition = 'opacity 0.3s ease-out';
                    itemRow.style.opacity = '0';
                    
                    setTimeout(() => {
                        itemRow.remove();
                        
                        // Update the sale total display
                        if (result.new_total !== undefined) {
                            const saleTotalElement = document.querySelector('h4.text-primary');
                            if (saleTotalElement) {
                                saleTotalElement.textContent = `RD$ ${result.new_total.toFixed(2)}`;
                            }
                        }
                        
                        // Check if this was the last item
                        const remainingItems = document.querySelectorAll('#sale-items tr[data-item-id]');
                        if (remainingItems.length === 0) {
                            // Show empty state
                            const tableBody = document.getElementById('sale-items');
                            const emptyRow = document.createElement('tr');
                            emptyRow.innerHTML = `
                                <td colspan="5" class="text-center py-4 text-muted">
                                    <i class="bi bi-clipboard" style="font-size: 2rem;"></i>
                                    <div class="mt-2">No hay productos en el pedido</div>
                                    <small>Agrega productos del men√∫ para comenzar</small>
                                </td>
                            `;
                            tableBody.appendChild(emptyRow);
                        }
                    }, 300);
                } else {
                    // Fallback to page reload if we can't find the row
                    location.reload();
                }
            } else {
                const error = await response.json();
                alert(error.error || 'Error eliminando producto');
            }
        } catch (error) {
            alert('Error de conexi√≥n');
            console.error('Remove item error:', error);
        }
    }
}

// Close tab and prepare for payment
async function closeTab() {
    if (!currentSale) {
        alert('No hay tab abierto');
        return;
    }
    
    if (confirm('¬øConfirmas cerrar el tab y enviar a caja para cobrar?')) {
        try {
            const response = await fetch(`/api/tabs/${currentSale}/close`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    csrf_token: csrfToken
                })
            });
            
            const data = await response.json();
            
            if (response.ok && data.success) {
                alert(`Tab cerrado. Total: RD$ ${data.total.toFixed(2)}\n\nEnv√≠a al cliente a caja para pagar.`);
                window.location.href = "{{ url_for('waiter.tables') }}";
            } else {
                alert(data.error || 'Error cerrando tab');
            }
        } catch (error) {
            alert('Error de conexi√≥n');
            console.error('Close tab error:', error);
        }
    }
}

// Load initial products
document.addEventListener('DOMContentLoaded', function() {
    const firstCategory = document.querySelector('[data-bs-toggle="pill"]');
    if (firstCategory) {
        const categoryId = firstCategory.getAttribute('data-bs-target').replace('#waiter-category-', '');
        loadWaiterProducts(categoryId);
    }
    
    // Load products when switching categories
    document.addEventListener('shown.bs.tab', function(e) {
        if (e.target.getAttribute('data-bs-toggle') === 'pill') {
            const categoryId = e.target.getAttribute('data-bs-target').replace('#waiter-category-', '');
            loadWaiterProducts(categoryId);
        }
    });
});
</script>
{% endblock %}