{% extends "base.html" %}

{% block title %}Mesa {{ table.number }} - Mesero{% endblock %}

{% block content %}
<div class="container-fluid tablet-friendly">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-table"></i> Mesa {{ table.number }}</h2>
        <a href="{{ url_for('waiter.tables') }}" class="btn btn-outline-secondary btn-touch">
            <i class="bi bi-arrow-left"></i> Volver a Mesas
        </a>
    </div>
    
    <div class="row">
        <!-- Order Section -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5><i class="bi bi-clipboard-check"></i> Pedido Actual</h5>
                        {% if current_sale %}
                        <span class="badge bg-warning">En Progreso</span>
                        {% else %}
                        <span class="badge bg-success">Nueva Mesa</span>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    {% if current_sale and current_sale.sale_items %}
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th>Cantidad</th>
                                    <th>Precio</th>
                                    <th>Total</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="sale-items">
                                {% for item in current_sale.sale_items %}
                                <tr data-item-id="{{ item.id }}">
                                    <td>{{ item.product.name }}</td>
                                    <td>
                                        <div class="d-flex align-items-center justify-content-center">
                                            <button class="btn btn-sm btn-outline-secondary me-2" onclick="updateQuantity({{ item.id }}, {{ item.quantity - 1 }})" {% if item.quantity <= 1 %}disabled{% endif %}>
                                                <i class="bi bi-dash"></i>
                                            </button>
                                            <span class="fw-bold" id="quantity-{{ item.id }}">{{ item.quantity }}</span>
                                            <button class="btn btn-sm btn-outline-secondary ms-2" onclick="updateQuantity({{ item.id }}, {{ item.quantity + 1 }})">
                                                <i class="bi bi-plus"></i>
                                            </button>
                                        </div>
                                    </td>
                                    <td>RD$ {{ "%.2f"|format(item.unit_price) }}</td>
                                    <td id="item-total-{{ item.id }}">RD$ {{ "%.2f"|format(item.total_price) }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-danger" onclick="removeItem({{ item.id }})">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <div class="d-grid gap-2">
                                <button class="btn btn-info btn-touch" onclick="sendToKitchen()">
                                    <i class="bi bi-send"></i> Enviar a Cocina
                                </button>
                                <button class="btn btn-danger btn-touch" onclick="cancelTable()">
                                    <i class="bi bi-x-circle"></i> Cancelar Pedido
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6>Total del Pedido</h6>
                                    <h4 class="text-primary">RD$ {{ "%.2f"|format(current_sale.total) }}</h4>
                                    <button class="btn btn-success btn-touch w-100" onclick="closeTable()">
                                        <i class="bi bi-check-circle"></i> Cerrar Mesa
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-clipboard text-muted" style="font-size: 3rem;"></i>
                        <h5 class="text-muted mt-3">No hay productos en el pedido</h5>
                        <p class="text-muted">Agrega productos del men√∫ para comenzar</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Menu Section -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-grid"></i> Men√∫</h5>
                </div>
                <div class="card-body">
                    <!-- Category Tabs for Waiter -->
                    <div class="nav nav-pills flex-column mb-3" id="waiter-category-tabs">
                        {% for category in categories %}
                        <button class="nav-link {% if loop.first %}active{% endif %} mb-2 btn-touch" 
                                data-bs-toggle="pill" 
                                data-bs-target="#waiter-category-{{ category.id }}">
                            {{ category.name }}
                        </button>
                        {% endfor %}
                    </div>
                    
                    <!-- Product Lists for Waiter -->
                    <div class="tab-content">
                        {% for category in categories %}
                        <div class="tab-pane fade {% if loop.first %}show active{% endif %}" 
                             id="waiter-category-{{ category.id }}">
                            <div id="waiter-products-{{ category.id }}">
                                <!-- Products will be loaded via JavaScript -->
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentSale = {% if current_sale %}{{ current_sale.id }}{% else %}null{% endif %};
const tableId = {{ table.id }};

// Load products for category
function loadWaiterProducts(categoryId) {
    fetch(`/api/products?category_id=${categoryId}`)
        .then(response => response.json())
        .then(products => {
            const container = document.getElementById(`waiter-products-${categoryId}`);
            container.innerHTML = '';
            
            products.forEach(product => {
                const productCard = `
                    <div class="card mb-2 product-card" onclick="addProductToOrder(${product.id}, '${product.name}', ${product.price})">
                        <div class="card-body text-center py-3">
                            <h6 class="card-title mb-1">${product.name}</h6>
                            <p class="card-text text-primary fw-bold">RD$ ${product.price.toFixed(2)}</p>
                        </div>
                    </div>
                `;
                container.innerHTML += productCard;
            });
        });
}

// Add product to current order
async function addProductToOrder(productId, productName, price) {
    if (!currentSale) {
        // Create new sale
        try {
            const response = await fetch('/api/sales', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    table_id: tableId
                })
            });
            
            if (response.ok) {
                const sale = await response.json();
                currentSale = sale.id;
                
                // Update table status to occupied
                await fetch(`/api/tables/${tableId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        status: 'occupied'
                    })
                });
            } else {
                alert('Error creando el pedido');
                return;
            }
        } catch (error) {
            alert('Error de conexi√≥n');
            return;
        }
    }
    
    // Add item to sale
    try {
        const response = await fetch(`/api/sales/${currentSale}/items`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                product_id: productId,
                quantity: 1
            })
        });
        
        if (response.ok) {
            // Reload page to show updated order
            location.reload();
        } else {
            alert('Error agregando producto');
        }
    } catch (error) {
        alert('Error de conexi√≥n');
    }
}

// Send order to kitchen with durable order status tracking
async function sendToKitchen() {
    if (!currentSale) {
        alert('No hay pedido para enviar a cocina');
        return;
    }
    
    if (confirm('¬øConfirmas enviar este pedido a cocina?')) {
        try {
            // Use the proper kitchen workflow API
            const response = await fetch(`/api/sales/${currentSale}/send-to-kitchen`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            if (response.ok) {
                const result = await response.json();
                
                // Show success message with order status
                alert(`‚úÖ ${result.message}\n\n` +
                      `üìã Estado del Pedido: ${result.order_status}\n` +
                      `üçΩÔ∏è Total: RD$ ${result.total.toFixed(2)}\n\n` +
                      `El pedido ahora est√° en la cola de la cocina.`);
                
                // Update the button to show current order status
                const kitchenBtn = document.querySelector('[onclick="sendToKitchen()"]');
                if (kitchenBtn) {
                    const originalText = kitchenBtn.innerHTML;
                    kitchenBtn.innerHTML = '<i class="bi bi-check-circle"></i> Enviado a Cocina';
                    kitchenBtn.disabled = true;
                    kitchenBtn.classList.remove('btn-info');
                    kitchenBtn.classList.add('btn-success');
                    
                    // Add order status indicator
                    const statusBadge = document.createElement('div');
                    statusBadge.className = 'mt-2';
                    statusBadge.innerHTML = `<span class="badge bg-warning">Estado: ${result.order_status}</span>`;
                    kitchenBtn.parentNode.appendChild(statusBadge);
                }
                
                // Add order status display to the order section
                const orderHeader = document.querySelector('.card-header h5');
                if (orderHeader && !document.getElementById('order-status-badge')) {
                    const statusBadge = document.createElement('span');
                    statusBadge.id = 'order-status-badge';
                    statusBadge.className = 'badge bg-info ms-2';
                    statusBadge.textContent = `Estado: ${result.order_status}`;
                    orderHeader.appendChild(statusBadge);
                }
                
            } else {
                const error = await response.json();
                alert('Error enviando pedido a cocina: ' + (error.error || 'Error desconocido'));
            }
        } catch (error) {
            alert('Error de conexi√≥n enviando pedido a cocina');
            console.error('Kitchen send error:', error);
        }
    }
}

// Split bill functionality
function splitBill() {
    alert('Funcionalidad de dividir cuenta - por implementar');
}

// Send table to cashier for finalization
async function closeTable() {
    if (!currentSale) {
        alert('No hay pedido para cerrar');
        return;
    }
    
    // Get current sale total for confirmation
    const saleTotal = document.querySelector('h4.text-primary')?.textContent || 'RD$ 0.00';
    
    if (confirm(`¬øConfirmas enviar esta mesa al cajero para finalizaci√≥n?\n\nTotal del pedido: ${saleTotal}\n\nEl cajero se encargar√° de:\n- Generar NCF\n- Procesar el pago\n- Finalizar la venta`)) {
        try {
            // Use the proper table close endpoint for cashier handoff
            const response = await fetch(`/api/tables/${tableId}/close`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'finalize'  // Indicate this is for finalization
                })
            });
            
            if (response.ok) {
                const result = await response.json();
                
                if (result.requires_finalization) {
                    // Table handed off successfully to cashier
                    alert(`‚úÖ Mesa ${tableId} enviada al cajero exitosamente!\n\n` +
                          `üßæ ID de Venta: ${result.sale_id}\n` +
                          `üí∞ Total: ${saleTotal}\n\n` +
                          `El cajero debe usar el ID de venta ${result.sale_id} para finalizar el pedido con NCF y pago.`);
                } else {
                    alert(result.message || 'Mesa enviada al cajero exitosamente.');
                }
                
                // Return to tables view
                window.location.href = "{{ url_for('waiter.tables') }}";
            } else {
                const error = await response.json();
                if (error.error && error.error.includes('meseros deben entregar')) {
                    alert('‚úã Solo los cajeros pueden finalizar ventas.\n\nEsta mesa ha sido preparada para que un cajero la finalice con NCF y procesamiento de pago.');
                } else {
                    alert(error.error || 'Error enviando mesa al cajero');
                }
            }
        } catch (error) {
            alert('Error de conexi√≥n enviando mesa al cajero');
            console.error('Close table error:', error);
        }
    }
}

// Cancel table and clear sale
async function cancelTable() {
    if (!currentSale) {
        // No sale, just mark table available
        await fetch(`/api/tables/${tableId}/status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                status: 'available'
            })
        });
        window.location.href = "{{ url_for('waiter.tables') }}";
        return;
    }
    
    if (confirm('¬øConfirmas cancelar el pedido y liberar la mesa?')) {
        try {
            const response = await fetch(`/api/tables/${tableId}/close`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'cancel'
                })
            });
            
            if (response.ok) {
                alert('Pedido cancelado y mesa liberada.');
                window.location.href = "{{ url_for('waiter.tables') }}";
            } else {
                const error = await response.json();
                alert(error.error || 'Error cancelando pedido');
            }
        } catch (error) {
            alert('Error de conexi√≥n');
        }
    }
}

// Update item quantity
async function updateQuantity(itemId, newQuantity) {
    if (newQuantity <= 0) {
        // If quantity would be 0 or negative, remove the item instead
        removeItem(itemId);
        return;
    }
    
    // Add visual feedback while updating
    const quantitySpan = document.getElementById(`quantity-${itemId}`);
    const originalBg = quantitySpan?.style.backgroundColor;
    if (quantitySpan) {
        quantitySpan.style.backgroundColor = '#fff3cd';
        quantitySpan.style.transition = 'background-color 0.3s ease';
    }
    
    try {
        const response = await fetch(`/api/sales/${currentSale}/items/${itemId}/quantity`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                quantity: newQuantity
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            
            // Update the UI with new values
            if (quantitySpan) {
                quantitySpan.textContent = result.new_quantity;
                // Brief success highlight
                quantitySpan.style.backgroundColor = '#d1e7dd';
                setTimeout(() => {
                    quantitySpan.style.backgroundColor = originalBg || '';
                }, 1000);
            }
            
            const itemTotalElement = document.getElementById(`item-total-${itemId}`);
            if (itemTotalElement) {
                itemTotalElement.textContent = `RD$ ${result.new_item_total.toFixed(2)}`;
            }
            
            // Update the sale total display
            const saleTotalElement = document.querySelector('h4.text-primary');
            if (saleTotalElement) {
                saleTotalElement.textContent = `RD$ ${result.new_sale_total.toFixed(2)}`;
            }
            
            // Update button states and onclick handlers
            const itemRow = document.querySelector(`tr[data-item-id="${itemId}"]`);
            if (itemRow) {
                const minusBtn = itemRow.querySelector('.btn-outline-secondary[onclick*="updateQuantity"]');
                const plusBtn = itemRow.querySelectorAll('.btn-outline-secondary[onclick*="updateQuantity"]')[1];
                
                if (minusBtn) {
                    minusBtn.disabled = result.new_quantity <= 1;
                    minusBtn.setAttribute('onclick', `updateQuantity(${itemId}, ${result.new_quantity - 1})`);
                }
                if (plusBtn) {
                    plusBtn.setAttribute('onclick', `updateQuantity(${itemId}, ${result.new_quantity + 1})`);
                }
            }
            
        } else {
            const error = await response.json();
            if (quantitySpan) {
                quantitySpan.style.backgroundColor = '#f8d7da'; // Error highlight
                setTimeout(() => {
                    quantitySpan.style.backgroundColor = originalBg || '';
                }, 2000);
            }
            alert(error.error || 'Error actualizando cantidad');
        }
    } catch (error) {
        if (quantitySpan) {
            quantitySpan.style.backgroundColor = '#f8d7da'; // Error highlight
            setTimeout(() => {
                quantitySpan.style.backgroundColor = originalBg || '';
            }, 2000);
        }
        alert('Error de conexi√≥n');
        console.error('Update quantity error:', error);
    }
}

// Remove item from order
async function removeItem(itemId) {
    if (confirm('¬øEliminar este producto del pedido?')) {
        try {
            const response = await fetch(`/api/sales/${currentSale}/items/${itemId}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                const result = await response.json();
                
                // Remove the item row from the table in real-time
                const itemRow = document.querySelector(`tr[data-item-id="${itemId}"]`);
                if (itemRow) {
                    // Add a fade-out animation
                    itemRow.style.transition = 'opacity 0.3s ease-out';
                    itemRow.style.opacity = '0';
                    
                    setTimeout(() => {
                        itemRow.remove();
                        
                        // Update the sale total display
                        if (result.new_total !== undefined) {
                            const saleTotalElement = document.querySelector('h4.text-primary');
                            if (saleTotalElement) {
                                saleTotalElement.textContent = `RD$ ${result.new_total.toFixed(2)}`;
                            }
                        }
                        
                        // Check if this was the last item
                        const remainingItems = document.querySelectorAll('#sale-items tr[data-item-id]');
                        if (remainingItems.length === 0) {
                            // Show empty state
                            const tableBody = document.getElementById('sale-items');
                            const emptyRow = document.createElement('tr');
                            emptyRow.innerHTML = `
                                <td colspan="5" class="text-center py-4 text-muted">
                                    <i class="bi bi-clipboard" style="font-size: 2rem;"></i>
                                    <div class="mt-2">No hay productos en el pedido</div>
                                    <small>Agrega productos del men√∫ para comenzar</small>
                                </td>
                            `;
                            tableBody.appendChild(emptyRow);
                        }
                    }, 300);
                } else {
                    // Fallback to page reload if we can't find the row
                    location.reload();
                }
            } else {
                const error = await response.json();
                alert(error.error || 'Error eliminando producto');
            }
        } catch (error) {
            alert('Error de conexi√≥n');
            console.error('Remove item error:', error);
        }
    }
}

// Load initial products
document.addEventListener('DOMContentLoaded', function() {
    const firstCategory = document.querySelector('[data-bs-toggle="pill"]');
    if (firstCategory) {
        const categoryId = firstCategory.getAttribute('data-bs-target').replace('#waiter-category-', '');
        loadWaiterProducts(categoryId);
    }
    
    // Load products when switching categories
    document.addEventListener('shown.bs.tab', function(e) {
        if (e.target.getAttribute('data-bs-toggle') === 'pill') {
            const categoryId = e.target.getAttribute('data-bs-target').replace('#waiter-category-', '');
            loadWaiterProducts(categoryId);
        }
    });
});
</script>
{% endblock %}