{% extends "base.html" %}

{% block title %}Menú - Mesero{% endblock %}

{% block content %}
<div class="container-fluid tablet-friendly">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-book"></i> Menú del Restaurante</h2>
        <div class="btn-group">
            <a href="{{ url_for('admin.pos') }}" class="btn btn-success btn-touch">
                <i class="bi bi-calculator"></i> POS (Punto de Venta)
            </a>
            <a href="{{ url_for('waiter.tables') }}" class="btn btn-outline-secondary btn-touch">
                <i class="bi bi-arrow-left"></i> Volver a Mesas
            </a>
        </div>
    </div>
    
    {% for category in categories %}
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">{{ category.name }}</h4>
            {% if category.description %}
            <small>{{ category.description }}</small>
            {% endif %}
        </div>
        <div class="card-body">
            <div class="row" id="menu-category-{{ category.id }}">
                <!-- Products will be loaded via JavaScript -->
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endblock %}

{% block scripts %}
<script>
// Load products for all categories
document.addEventListener('DOMContentLoaded', function() {
    {% for category in categories %}
    loadMenuProducts({{ category.id }});
    {% endfor %}
});

function loadMenuProducts(categoryId) {
    fetch(`/api/products?category_id=${categoryId}`)
        .then(response => response.json())
        .then(products => {
            const container = document.getElementById(`menu-category-${categoryId}`);
            container.innerHTML = '';
            
            products.forEach(product => {
                let stockBadge = '';
                let cardStyle = '';
                let cardClass = 'card h-100';
                
                if (product.stock <= 0) {
                    stockBadge = '<span class="badge bg-danger">❌ Agotado</span>';
                    cardStyle = 'opacity: 0.6;';
                    cardClass += ' border-danger';
                } else if (product.stock <= 5) {
                    stockBadge = `<span class="badge bg-warning text-dark">⚠️ Stock: ${product.stock}</span>`;
                } else {
                    stockBadge = `<span class="badge bg-success">✅ Stock: ${product.stock}</span>`;
                }
                
                const productCard = `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="${cardClass}" style="${cardStyle}">
                            <div class="card-body">
                                <h5 class="card-title">${product.name}</h5>
                                <p class="card-text text-muted">${product.description || ''}</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="h5 text-primary mb-0">RD$ ${product.price.toFixed(2)}</span>
                                    ${stockBadge}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += productCard;
            });
        })
        .catch(error => {
            console.error('Error loading products:', error);
        });
}
</script>
{% endblock %}