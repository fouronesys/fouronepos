{% extends "base.html" %}

{% block title %}Gestión de Mesas - {{ user_role }}{% endblock %}


{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-table"></i> Gestión de Mesas</h2>
        <div class="btn-group" role="group">
            <a href="{{ url_for('admin.dashboard') }}" class="btn btn-outline-secondary">
                <i class="bi bi-house"></i> Dashboard
            </a>
            <a href="{{ url_for('admin.pos') }}" class="btn btn-outline-primary">
                <i class="bi bi-cash-register"></i> POS
            </a>
        </div>
    </div>
    
    <!-- Tables with Active Orders -->
    {% if tables_with_orders %}
    <div class="mb-5">
        <h4 class="text-primary mb-3">
            <i class="bi bi-receipt-cutoff"></i> Mesas con Órdenes Pendientes de Facturación 
            <span class="badge bg-primary">{{ tables_with_orders|length }}</span>
        </h4>
        <div class="alert alert-info mb-4">
            <i class="bi bi-info-circle"></i>
            <strong>Administradores y Cajeros:</strong> Pueden facturar las órdenes directamente desde aquí.
        </div>
        <div class="row">
            {% for table_data in tables_with_orders %}
            {% set table = table_data.table %}
            {% set current_sale = table_data.current_sale %}
            {% set order_total = table_data.order_total %}
            {% set order_items_count = table_data.order_items_count %}
            
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card border-primary h-100">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-table"></i> Mesa {{ table.number }}
                            {% if table.name %}
                            <small class="text-light">- {{ table.name }}</small>
                            {% endif %}
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-12">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <p class="mb-1"><i class="bi bi-people"></i> {{ table.capacity }} personas</p>
                                        <p class="mb-1">
                                            <i class="bi bi-receipt"></i> 
                                            {{ order_items_count }} {% if order_items_count == 1 %}producto{% else %}productos{% endif %}
                                        </p>
                                        <p class="mb-0"><strong>Orden #{{ current_sale.id }}</strong></p>
                                    </div>
                                    <div class="text-end">
                                        <h4 class="text-success mb-0">RD$ {{ "%.2f"|format(order_total) }}</h4>
                                        <small class="text-muted">Total a facturar</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Order Items Preview -->
                        {% if current_sale.sale_items %}
                        <div class="mb-3">
                            <h6 class="text-muted mb-2">Productos en la orden:</h6>
                            <div class="small">
                                {% for item in current_sale.sale_items[:3] %}
                                <div class="d-flex justify-content-between border-bottom py-1">
                                    <span>{{ item.quantity }}x {{ item.product.name }}</span>
                                    <span>RD$ {{ "%.2f"|format(item.total_price) }}</span>
                                </div>
                                {% endfor %}
                                {% if current_sale.sale_items|length > 3 %}
                                <div class="text-center text-muted mt-1">
                                    <small>... y {{ current_sale.sale_items|length - 3 }} más</small>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                        
                        <div class="d-grid gap-2">
                            {% if order_total > 0 %}
                                <button class="btn btn-success btn-lg shadow" onclick="billTable({{ table.id }}, {{ current_sale.id }}, {{ order_total }})">
                                    <i class="bi bi-credit-card"></i> <strong>Facturar Orden</strong>
                                </button>
                            {% else %}
                                <button class="btn btn-outline-secondary btn-lg" disabled>
                                    <i class="bi bi-exclamation-triangle"></i> Orden Vacía
                                </button>
                            {% endif %}
                            <div class="btn-group" role="group">
                                <button class="btn btn-outline-info" onclick="viewOrderDetails({{ current_sale.id }})">
                                    <i class="bi bi-eye"></i> Ver Detalles
                                </button>
                                <button class="btn btn-outline-warning" onclick="editOrder({{ current_sale.id }})">
                                    <i class="bi bi-pencil"></i> Editar
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer text-muted text-center">
                        <small>
                            <i class="bi bi-clock"></i> 
                            Creada: {{ current_sale.created_at.strftime('%H:%M') }}
                        </small>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% else %}
    <div class="alert alert-info text-center">
        <i class="bi bi-info-circle fs-4"></i>
        <h5 class="mt-2">No hay mesas con órdenes activas</h5>
        <p class="mb-0">Las mesas con órdenes pendientes aparecerán aquí para facturación.</p>
    </div>
    {% endif %}
    
    <!-- Available Tables -->
    {% if tables_available %}
    <div>
        <h4 class="text-success mb-3">
            <i class="bi bi-check-circle"></i> Mesas Disponibles para Nuevas Órdenes
            <span class="badge bg-success">{{ tables_available|length }}</span>
        </h4>
        <div class="alert alert-success">
            <i class="bi bi-info-circle"></i>
            <strong>Meseros:</strong> Pueden crear nuevas órdenes en estas mesas desde el POS.
        </div>
        <div class="row">
            {% for table_data in tables_available %}
            {% set table = table_data.table %}
            
            <div class="col-md-4 col-lg-3 mb-3">
                <div class="card border-success h-100">
                    <div class="card-header bg-success text-white text-center">
                        <h6 class="mb-0">
                            <i class="bi bi-table"></i> Mesa {{ table.number }}
                        </h6>
                    </div>
                    <div class="card-body text-center">
                        {% if table.name %}
                        <p class="text-muted mb-2">{{ table.name }}</p>
                        {% endif %}
                        <p class="mb-2"><i class="bi bi-people"></i> {{ table.capacity }} personas</p>
                        <span class="badge bg-success mb-2">
                            <i class="bi bi-check-circle"></i> Disponible
                        </span>
                        <div class="mt-2">
                            <a href="/admin/pos?table_id={{ table.id }}" class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-plus-circle"></i> Nueva Orden
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Order Details Modal -->
<div class="modal fade" id="orderDetailsModal" tabindex="-1" aria-labelledby="orderDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="orderDetailsModalLabel">
                    <i class="bi bi-receipt"></i> Detalles de la Orden
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="orderDetailsContent">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Billing Modal -->
<div class="modal fade" id="billingModal" tabindex="-1" aria-labelledby="billingModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="billingModalLabel">
                    <i class="bi bi-credit-card"></i> Facturar Mesa
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="billingContent">
                    <!-- Billing form will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentTableId = null;
let currentSaleId = null;
let currentTotal = 0;

// Bill a table order
async function billTable(tableId, saleId, total) {
    currentTableId = tableId;
    currentSaleId = saleId;
    currentTotal = total;
    
    // Create billing form content
    const billingContent = `
        <div class="text-center mb-3">
            <h4>Mesa ${tableId}</h4>
            <p class="text-muted">Venta ID: ${saleId}</p>
            <h5 class="text-success">Total: RD$ ${total.toFixed(2)}</h5>
        </div>
        
        <form id="billingForm">
            <div class="mb-3">
                <label for="paymentMethod" class="form-label">Método de Pago</label>
                <select class="form-select" id="paymentMethod" required>
                    <option value="">Seleccionar método</option>
                    <option value="efectivo">Efectivo</option>
                    <option value="tarjeta">Tarjeta</option>
                    <option value="transferencia">Transferencia</option>
                </select>
            </div>
            
            <div class="mb-3">
                <label for="ncfType" class="form-label">Tipo de Comprobante</label>
                <select class="form-select" id="ncfType" required>
                    <option value="">Seleccionar tipo</option>
                    <option value="consumo">Consumo (B01)</option>
                    <option value="credito_fiscal">Crédito Fiscal (B02)</option>
                    <option value="gubernamental">Gubernamental (B14)</option>
                </select>
            </div>
            
            <div class="mb-3" id="customerInfoSection" style="display: none;">
                <label for="customerName" class="form-label">Nombre del Cliente</label>
                <input type="text" class="form-control" id="customerName" placeholder="Nombre completo">
                
                <label for="customerRnc" class="form-label mt-2">RNC/Cédula</label>
                <input type="text" class="form-control" id="customerRnc" placeholder="RNC (9 dígitos) o Cédula (11 dígitos)">
            </div>
            
            <div class="mb-3">
                <label for="description" class="form-label">Descripción (Opcional)</label>
                <input type="text" class="form-control" id="description" placeholder="Nota interna de la venta">
            </div>
            
            <div class="d-grid gap-2">
                <button type="button" class="btn btn-success btn-lg" onclick="processBilling()">
                    <i class="bi bi-check-circle"></i> Procesar Factura
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    Cancelar
                </button>
            </div>
        </form>
    `;
    
    document.getElementById('billingContent').innerHTML = billingContent;
    
    // Show/hide customer info section based on NCF type
    document.getElementById('ncfType').addEventListener('change', function() {
        const customerSection = document.getElementById('customerInfoSection');
        const requiresCustomer = ['credito_fiscal', 'gubernamental'].includes(this.value);
        customerSection.style.display = requiresCustomer ? 'block' : 'none';
    });
    
    // Show billing modal
    const modal = new bootstrap.Modal(document.getElementById('billingModal'));
    modal.show();
}

// Process billing
async function processBilling() {
    const form = document.getElementById('billingForm');
    const formData = new FormData(form);
    
    const billingData = {
        payment_method: document.getElementById('paymentMethod').value,
        ncf_type: document.getElementById('ncfType').value,
        customer_name: document.getElementById('customerName').value,
        customer_rnc: document.getElementById('customerRnc').value,
        description: document.getElementById('description').value
    };
    
    // Validate required fields
    if (!billingData.payment_method || !billingData.ncf_type) {
        alert('Por favor completa todos los campos requeridos.');
        return;
    }
    
    // Validate customer info for fiscal receipts
    if (['credito_fiscal', 'gubernamental'].includes(billingData.ncf_type)) {
        if (!billingData.customer_name || !billingData.customer_rnc) {
            alert('Los comprobantes fiscales y gubernamentales requieren información del cliente.');
            return;
        }
    }
    
    try {
        // Process the sale via API with CSRF token
        const csrfToken = getCsrfToken();
        if (!csrfToken) {
            alert('Error: Token de seguridad no disponible. Por favor recarga la página.');
            return;
        }
        
        billingData.csrf_token = csrfToken; // Also include in body for redundancy
        
        const response = await fetch(`/api/sales/${currentSaleId}/table-finalize`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(billingData)
        });
        
        if (response.ok) {
            const result = await response.json();
            
            // Check if automatic receipt printing is enabled
            if (result.auto_print && result.receipt_text) {
                // Use the same printing function as POS
                try {
                    // Call printReceipt function if available (same as POS)
                    if (typeof printReceipt === 'function') {
                        await printReceipt(result);
                    } else {
                        // Show receipt text in a modal (fallback)
                        showReceiptModal(result);
                    }
                } catch (error) {
                    console.error('[Billing] Error printing receipt:', error);
                }
            }
            
            alert(`✅ Factura procesada exitosamente!\n\n` +
                  `📋 NCF: ${result.ncf}\n` +
                  `💰 Total: RD$ ${result.total.toFixed(2)}\n` +
                  `🧾 ID Venta: ${result.sale_id}`);
            
            // Hide modal and reload page (with delay to allow printing to complete)
            bootstrap.Modal.getInstance(document.getElementById('billingModal')).hide();
            setTimeout(() => {
                location.reload();
            }, 2000); // 2 second delay to allow printing/downloading to complete
            
        } else {
            const error = await response.json();
            alert('Error procesando factura: ' + (error.error || 'Error desconocido'));
        }
    } catch (error) {
        alert('Error de conexión procesando factura');
        console.error('Billing error:', error);
    }
}

// View order details
async function viewOrderDetails(saleId) {
    try {
        // Show loading state
        const loadingHtml = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="mt-2">Cargando detalles de la orden...</p>
            </div>
        `;
        
        // Get modal elements safely
        const orderDetailsContent = document.getElementById('orderDetailsContent');
        const orderDetailsModal = document.getElementById('orderDetailsModal');
        
        if (!orderDetailsContent || !orderDetailsModal) {
            alert('Error: No se pudo encontrar el modal de detalles. Por favor recarga la página.');
            return;
        }
        
        orderDetailsContent.innerHTML = loadingHtml;
        
        // Show modal first with loading content
        const modalInstance = new bootstrap.Modal(orderDetailsModal);
        modalInstance.show();
        
        const response = await fetch(`/api/sales/${saleId}/table-details`);
        
        if (response.ok) {
            const sale = await response.json();
            
            // Validate response data
            if (!sale || typeof sale !== 'object') {
                throw new Error('Respuesta inválida del servidor');
            }
                
            let detailsHtml = `
                <div class="row mb-3">
                    <div class="col-6"><strong>Venta ID:</strong> ${sale.id || 'N/A'}</div>
                    <div class="col-6"><strong>Mesa:</strong> ${sale.table_number || 'N/A'}</div>
                </div>
                <div class="row mb-3">
                    <div class="col-6"><strong>Fecha:</strong> ${sale.created_at ? new Date(sale.created_at).toLocaleString() : 'N/A'}</div>
                    <div class="col-6"><strong>Total:</strong> RD$ ${sale.total ? sale.total.toFixed(2) : '0.00'}</div>
                </div>
                <div class="row mb-3">
                    <div class="col-6"><strong>Estado:</strong> ${sale.status || 'N/A'}</div>
                    <div class="col-6"><strong>Subtotal:</strong> RD$ ${sale.subtotal ? sale.subtotal.toFixed(2) : '0.00'}</div>
                </div>
                
                <h6>Productos:</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Cantidad</th>
                                <th>Precio</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            if (sale.items && Array.isArray(sale.items) && sale.items.length > 0) {
                sale.items.forEach(item => {
                    detailsHtml += `
                        <tr>
                            <td>${item.product_name || 'N/A'}</td>
                            <td>${item.quantity || 0}</td>
                            <td>RD$ ${item.unit_price ? item.unit_price.toFixed(2) : '0.00'}</td>
                            <td>RD$ ${item.total_price ? item.total_price.toFixed(2) : '0.00'}</td>
                        </tr>
                    `;
                });
            } else {
                detailsHtml += `
                    <tr>
                        <td colspan="4" class="text-center text-muted">No hay productos en esta orden</td>
                    </tr>
                `;
            }
            
            detailsHtml += `
                        </tbody>
                    </table>
                </div>
            `;
            
            orderDetailsContent.innerHTML = detailsHtml;
            
        } else {
            let errorMessage = 'Error desconocido';
            
            try {
                const errorData = await response.json();
                errorMessage = errorData.error || errorMessage;
            } catch (e) {
                // If can't parse JSON, use status text
                errorMessage = response.statusText || `Error HTTP ${response.status}`;
            }
            
            if (response.status === 403) {
                errorMessage = 'No tienes permisos para ver los detalles de esta orden';
            } else if (response.status === 404) {
                errorMessage = 'La orden no existe o fue eliminada';
            }
            
            orderDetailsContent.innerHTML = `
                <div class="alert alert-danger">
                    <h5><i class="bi bi-exclamation-triangle"></i> Error</h5>
                    <p>No se pudieron cargar los detalles de la orden:</p>
                    <p><strong>${errorMessage}</strong></p>
                    <button type="button" class="btn btn-secondary mt-2" data-bs-dismiss="modal">Cerrar</button>
                </div>
            `;
        }
    } catch (error) {
        console.error('[Orders] Error loading order details:', error);
        
        const orderDetailsContent = document.getElementById('orderDetailsContent');
        if (orderDetailsContent) {
            orderDetailsContent.innerHTML = `
                <div class="alert alert-warning">
                    <h5><i class="bi bi-wifi-off"></i> Error de Conexión</h5>
                    <p>No se pudo conectar con el servidor. Verifica tu conexión a internet e inténtalo de nuevo.</p>
                    <button type="button" class="btn btn-secondary mt-2" data-bs-dismiss="modal">Cerrar</button>
                </div>
            `;
        } else {
            alert('Error de conexión al cargar detalles. Por favor recarga la página e inténtalo de nuevo.');
        }
    }
}

// Get CSRF token from meta tag or form
function getCsrfToken() {
    const token = document.querySelector('meta[name=csrf-token]');
    return token ? token.getAttribute('content') : '';
}

// Edit order function
function editOrder(saleId) {
    // Redirect to POS with the sale ID to edit the order
    window.location.href = `/admin/pos?edit_sale=${saleId}`;
}

// Fallback function to show receipt when printReceipt is not available
function showReceiptModal(saleData) {
    // Create receipt preview modal (simplified version)
    const receiptModal = `
        <div class="modal fade" id="receiptModalFallback" tabindex="-1" aria-labelledby="receiptModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-receipt me-2"></i>Recibo Generado - Venta #${saleData.sale_id}
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle me-2"></i>
                            Recibo generado automáticamente después de la facturación
                        </div>
                        <div class="receipt-preview">
                            <pre id="receiptText" style="font-family: 'Courier New', monospace; font-size: 12px; background: #f8f9fa; color: #000; padding: 15px; border-radius: 8px; overflow-x: auto; white-space: pre-wrap; border: 1px solid #dee2e6;"></pre>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <a href="/api/receipts/${saleData.sale_id}/pdf" class="btn btn-primary" download>
                            <i class="bi bi-download me-1"></i>Descargar PDF
                        </a>
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('receiptModalFallback');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', receiptModal);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('receiptModalFallback'));
    modal.show();
    
    // Set receipt text safely to prevent XSS
    document.getElementById('receiptText').textContent = saleData.receipt_text;
    
    // Auto-hide after 10 seconds
    setTimeout(() => {
        modal.hide();
    }, 10000);
}

// Auto refresh page every 30 seconds to show updated table status
setInterval(() => {
    location.reload();
}, 30000);
</script>

<!-- Include payment system for unified printing -->
<script defer src="{{ url_for('static', filename='js/payment-system.js') }}?v={{ timestamp }}"></script>
{% endblock %}