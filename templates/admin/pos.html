{% extends "base.html" %}

{% block title %}Punto de Venta - Four One POS{% endblock %}

{% block head %}
<meta name="csrf-token" content="{{ csrf_token() }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/pos-style.css') }}?v=20250912065500">
<!-- Organized JavaScript Files - Load in order for proper initialization -->
<script src="{{ url_for('static', filename='js/pos-utils.js') }}?v=1759597895"></script>
<script src="{{ url_for('static', filename='js/payment-system.js') }}?v=1759597895"></script>
<style>
    /* Billing Modal Styles */
    .billing-summary {
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        border-radius: 12px;
        padding: 1rem;
        margin-top: 1rem;
    }
    
    .summary-details .row {
        margin-bottom: 0.5rem;
        padding: 0.25rem 0;
        border-bottom: 1px solid var(--glass-border);
    }
    
    .summary-details .row:last-child {
        border-bottom: none;
        font-weight: 600;
    }
    
    .tax-types-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 0.5rem;
    }
    
    .tax-option {
        background: var(--glass-bg);
        border: 2px solid var(--glass-border);
        border-radius: 8px;
        padding: 0.75rem;
        transition: all 0.3s ease;
    }
    
    .tax-option:hover {
        border-color: var(--primary-color);
        background: var(--glass-hover-bg);
    }
    
    .tax-option input[type="radio"]:checked + label {
        color: var(--primary-color);
        font-weight: 600;
    }
    
    .tax-option input[type="radio"]:checked {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }
    
    .payment-methods .form-check {
        background: var(--glass-bg);
        border: 2px solid var(--glass-border);
        border-radius: 8px;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        transition: all 0.3s ease;
    }
    
    .payment-methods .form-check:hover {
        border-color: var(--primary-color);
        background: var(--glass-hover-bg);
    }
    
    .payment-methods .form-check-input:checked + .form-check-label {
        color: var(--primary-color);
        font-weight: 600;
    }

    /* Cash Register Status Styles */
    .cash-controls {
        align-items: center;
    }
    
    .cash-open {
        background-color: #28a745 !important;
        animation: pulse-green 2s infinite;
    }
    
    .cash-closed {
        background-color: #dc3545 !important;
    }
    
    @keyframes pulse-green {
        0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
        70% { box-shadow: 0 0 0 8px rgba(40, 167, 69, 0); }
        100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
    }
    
    #cash-status-indicator {
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        padding: 8px 12px;
        font-size: 0.9rem;
        font-weight: 500;
    }
    
    #close-cash-btn {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        font-weight: 500;
    }
    
    #close-cash-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Modern POS Header -->
    <div class="row align-items-center mb-4">
        <div class="col">
            <div class="d-flex align-items-center gap-3">
                <div class="pos-icon">
                    <i class="bi bi-cash-register"></i>
                </div>
                <div>
                    <h1 class="display-6 fw-bold mb-1">Punto de Venta</h1>
                    <p class="text-muted mb-0">Sistema POS con Cumplimiento Fiscal ‚Ä¢ Rep√∫blica Dominicana</p>
                </div>
            </div>
        </div>
        <div class="col-auto">
            <div class="d-flex align-items-center gap-3">
                <!-- Enhanced Status Indicators -->
                <div id="connection-status" class="status-indicator online">
                    <div class="status-dot"></div>
                    <span><i class="bi bi-wifi me-1"></i>En l√≠nea</span>
                </div>
                <div id="sync-status" class="status-indicator sync" style="display: none;">
                    <div class="status-dot sync-dot"></div>
                    <span><i class="bi bi-cloud-upload me-1"></i><span id="sync-count">0</span> pendiente(s)</span>
                </div>
                <!-- Quick Stats -->
                <div class="quick-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="daily-sales">RD$ 0</div>
                        <div class="stat-label">Ventas del d√≠a</div>
                    </div>
                </div>
                <!-- Cash Register Controls -->
                {% if session.role in ['ADMINISTRADOR', 'CAJERO'] %}
                <div class="cash-controls d-flex gap-2">
                    <button id="close-cash-btn" class="btn btn-warning" onclick="showCloseCashModal()" style="display: none;">
                        <i class="bi bi-lock me-1"></i>Cerrar Caja
                    </button>
                    <div id="cash-status-indicator" class="status-indicator" style="display: none;">
                        <div class="status-dot cash-open"></div>
                        <span id="cash-status-text">Caja: Cerrada</span>
                    </div>
                </div>
                {% endif %}
                
                <!-- Back to Waiter Tables Button (only for waiters) -->
                {% if session.role == 'MESERO' %}
                <a href="{{ url_for('waiter.tables') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-2"></i>Volver a Mesas
                </a>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="row g-4">
        <!-- Products/Orders Section -->
        <div class="col-lg-8">
            <!-- Tab Navigation -->
            <div class="pos-tabs mb-4">
                <div class="tab-buttons">
                    <button class="tab-button active" id="products-tab" onclick="showProductsSection()">
                        <i class="bi bi-grid-3x3-gap"></i>
                        <span>Productos</span>
                    </button>
                    <button class="tab-button" id="orders-tab" onclick="showOrdersSection()">
                        <i class="bi bi-clock-history"></i>
                        <span>√ìrdenes Abiertas</span>
                        <span class="order-count" id="pending-orders-count">0</span>
                    </button>
                </div>
            </div>
            
            <!-- Products Section -->
            <div id="products-section" class="products-section">
                <!-- Enhanced Category Navigation -->
                <div class="category-nav mb-4">
                    <div class="category-pills">
                        {% for category in categories %}
                        <button class="category-pill {% if loop.first %}active{% endif %}" 
                                data-category-id="{{ category.id }}"
                                onclick="switchCategory({{ category.id }})">
                            <i class="bi bi-{% if category.name == 'Bebidas' %}cup-straw{% elif category.name == 'Comidas' %}egg-fried{% elif category.name == 'Postres' %}cake2{% else %}box{% endif %}"></i>
                            <span>{{ category.name }}</span>
                        </button>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Enhanced Product Grid -->
                <div class="products-grid">
                    {% for category in categories %}
                    <div class="category-products {% if not loop.first %}d-none{% endif %}" 
                         id="category-products-{{ category.id }}">
                        <div class="products-container" id="products-{{ category.id }}">
                            <!-- Products will be loaded via JavaScript -->
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Open Orders Section -->
            <div id="orders-section" class="orders-section d-none">
                <div class="orders-header mb-3">
                    <h5 class="mb-0">
                        <i class="bi bi-clock-history me-2"></i>
                        √ìrdenes Pendientes de Facturaci√≥n
                    </h5>
                    <small class="text-muted">√ìrdenes creadas por meseros que necesitan ser facturadas</small>
                </div>
                
                <div id="pending-orders-container" class="orders-grid">
                    <!-- Orders will be loaded via JavaScript -->
                    <div class="empty-orders text-center py-5">
                        <i class="bi bi-inbox" style="font-size: 3rem; color: #ddd;"></i>
                        <h6 class="text-muted mt-3">No hay √≥rdenes pendientes</h6>
                        <p class="text-muted mb-0">Las √≥rdenes de los meseros aparecer√°n aqu√≠</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Modern Cart Section -->
        <div class="col-lg-4">
            <div class="modern-cart">
                <!-- Cart Header -->
                <div class="cart-header">
                    <div class="cart-title">
                        <i class="bi bi-cart3"></i>
                        <span>Carrito</span>
                    </div>
                    <div class="cart-counter" id="cart-counter">0</div>
                </div>
                
                <!-- Cart Configuration -->
                <div class="cart-config">
                    <!-- Table Selection -->
                    <div class="config-item">
                        <label for="table-select" class="config-label">
                            <i class="bi bi-table"></i>
                            <span>Mesa</span>
                        </label>
                        <select class="modern-select" id="table-select">
                            <option value="">Sin asignar</option>
                        </select>
                    </div>
                    
                    <!-- Order Description -->
                    <div class="config-item">
                        <label for="order-description" class="config-label">
                            <i class="bi bi-sticky"></i>
                            <span>Descripci√≥n</span>
                        </label>
                        <input type="text" class="modern-input" id="order-description" placeholder="Nota interna de la orden (opcional)" maxlength="200">
                        <small class="text-muted" style="font-size: 0.75rem;">Solo para referencia interna - no se imprime en el recibo</small>
                    </div>
                    
                    <!-- NCF Type -->
                    <div class="config-item">
                        <label for="ncf-type-select" class="config-label">
                            <i class="bi bi-receipt"></i>
                            <span>Comprobante</span>
                        </label>
                        <select class="modern-select" id="ncf-type-select" onchange="toggleClientInfo()">
                            <option value="sin_comprobante" selected>Sin comprobante</option>
                            <option value="consumo">Consumo</option>
                            <option value="credito_fiscal">Cr√©dito Fiscal</option>
                            <option value="gubernamental">Gubernamental</option>
                        </select>
                    </div>
                    
                    <!-- Customer Name (Always visible for identification) -->
                    <div class="config-item">
                        <label for="client-name" class="config-label">
                            <i class="bi bi-person"></i>
                            <span>Nombre del Cliente</span>
                        </label>
                        <input type="text" class="modern-input" id="client-name" placeholder="Nombre del cliente (opcional)">
                        <small class="text-muted" style="font-size: 0.75rem;">Para identificar al cliente en la orden</small>
                    </div>
                    
                    <!-- Fiscal Information (Only for fiscal receipts) -->
                    <div id="client-info-section" class="client-info-section" style="display: none;">
                        <div class="config-item">
                            <label for="customer-select" class="config-label">
                                <i class="bi bi-people"></i>
                                <span>Seleccionar Cliente</span>
                            </label>
                            <select class="modern-select" id="customer-select" onchange="fillCustomerInfo()">
                                <option value="">Seleccione un cliente o ingrese manualmente</option>
                                <!-- Options will be loaded via JavaScript -->
                            </select>
                        </div>
                        <div class="config-item">
                            <label for="client-rnc" class="config-label">
                                <i class="bi bi-card-text"></i>
                                <span>RNC/C√©dula</span>
                            </label>
                            <input type="text" class="modern-input" id="client-rnc" placeholder="RNC o n√∫mero de c√©dula">
                        </div>
                    </div>
                </div>
                
                <!-- Payment Method Configuration Section -->
                <div class="cart-config">
                    <div class="config-item">
                        <label for="payment-method-select" class="config-label">
                            <i class="bi bi-credit-card"></i>
                            <span>M√©todo de Pago</span>
                        </label>
                        <select class="modern-select" id="payment-method-select" onchange="toggleCashFields()">
                            <option value="cash">Efectivo</option>
                            <option value="card">Tarjeta</option>
                            <option value="transfer">Transferencia</option>
                        </select>
                    </div>
                    
                    <!-- Cash Payment Fields -->
                    <div id="cash-payment-section" class="cash-payment-section">
                        <div class="config-item">
                            <label for="cash-received" class="config-label">
                                <i class="bi bi-cash-stack"></i>
                                <span>Efectivo Recibido</span>
                            </label>
                            <input type="number" step="0.01" min="0" class="modern-input" id="cash-received" placeholder="0.00" onchange="calculateChange()">
                        </div>
                        <div class="config-item">
                            <label class="config-label">
                                <i class="bi bi-arrow-down-circle"></i>
                                <span>Cambio a Entregar</span>
                            </label>
                            <div class="change-display" id="change-display">RD$ 0.00</div>
                        </div>
                    </div>
                </div>
                
                <!-- Service Charge (Propina) Configuration -->
                <div class="cart-config">
                    <div class="config-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="apply-service-charge" onchange="updateTotals()">
                            <label class="form-check-label" for="apply-service-charge">
                                <i class="bi bi-percent me-2"></i>
                                <strong>Aplicar propina del 10%</strong>
                                <small class="d-block text-muted">Propina legal seg√∫n normativa dominicana</small>
                            </label>
                        </div>
                    </div>
                </div>
                
                
                <!-- Cart Items -->
                <div class="cart-items-container">
                    <div id="cart-items" class="cart-items">
                        <div class="empty-cart">
                            <i class="bi bi-cart-x"></i>
                            <p>Carrito vac√≠o</p>
                            <small>Agrega productos para empezar</small>
                        </div>
                    </div>
                </div>
                
                <!-- Cart Totals -->
                <div class="cart-totals">
                    <div class="total-row subtotal-row">
                        <span>Subtotal</span>
                        <span id="subtotal">RD$ 0.00</span>
                    </div>
                    <div class="total-row tax-row" id="tax-row">
                        <span id="tax-label">ITBIS (18%)</span>
                        <span id="tax">RD$ 0.00</span>
                    </div>
                    <div class="total-row tax-row" id="service-charge-row" style="display: none;">
                        <span>Propina (10%)</span>
                        <span id="service-charge">RD$ 0.00</span>
                    </div>
                    <div class="total-row final-row">
                        <span>Total</span>
                        <span id="total">RD$ 0.00</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="cart-actions">
                    <div class="d-grid gap-2">
                        <button class="btn btn-success btn-lg" id="process-sale" onclick="processSale()" 
                                {% if session.role == 'MESERO' %}disabled title="Los meseros no pueden procesar ventas directamente"{% endif %}>
                            <i class="bi bi-check-circle me-2"></i> Procesar Venta
                        </button>
                        <button class="btn btn-warning" id="assign-table" onclick="assignToTable()" style="background: linear-gradient(135deg, #ffa500 0%, #ff8c00 100%); color: #000; font-weight: 600;">
                            <i class="bi bi-table me-2"></i> Asignar a Mesa
                        </button>
                        <button class="btn btn-danger-custom" id="clear-cart" onclick="clearCart()">
                            <i class="bi bi-trash me-2"></i> Limpiar Carrito
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Enhanced POS functionality with offline support and cart persistence

// Get CSRF token from meta tag
const csrfToken = document.querySelector('meta[name="csrf-token"]').content;

// Get CSRF token from document
function getCsrfToken() {
    const metaTag = document.querySelector('meta[name="csrf-token"]');
    if (metaTag) {
        return metaTag.content;
    }
    
    // Fallback: try to get from hidden input
    const hiddenInput = document.querySelector('input[name="csrf_token"]');
    if (hiddenInput) {
        return hiddenInput.value;
    }
    
    console.error('[Utils] CSRF token not found');
    return null;
}

// Centralized API request function with CSRF and proper error handling
async function apiRequest(url, options = {}) {
    const defaultOptions = {
        credentials: 'same-origin',
        headers: {
            'Content-Type': 'application/json',
            ...options.headers
        }
    };
    
    // Add CSRF token for non-GET requests
    if (options.method && options.method !== 'GET') {
        const csrfToken = getCsrfToken();
        if (csrfToken) {
            defaultOptions.headers['X-CSRFToken'] = csrfToken;
        }
    }
    
    // Merge options
    const finalOptions = {
        ...defaultOptions,
        ...options,
        headers: {
            ...defaultOptions.headers,
            ...options.headers
        }
    };
    
    try {
        const response = await fetch(url, finalOptions);
        
        // Try to parse JSON response
        let data = {};
        try {
            const text = await response.text();
            if (text) {
                data = JSON.parse(text);
            }
        } catch (parseError) {
            console.error('[API] Failed to parse JSON response:', parseError);
            data = { error: 'Invalid server response' };
        }
        
        // Check if request was successful
        if (!response.ok) {
            const errorMessage = data.error || data.details || `${response.status} ${response.statusText}`;
            throw new Error(errorMessage);
        }
        
        return data;
        
    } catch (error) {
        console.error('[API] Request failed:', error.message || error);
        throw error;
    }
}

// Show notification to user
function showNotification(message, type = 'info') {
    // Create or update notification element
    let notification = document.getElementById('notification');
    if (!notification) {
        notification = document.createElement('div');
        notification.id = 'notification';
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            z-index: 9999;
            font-weight: 600;
            max-width: 300px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
            transform: translateX(100%);
        `;
        document.body.appendChild(notification);
    }
    
    // Set notification style based on type
    const colors = {
        success: 'background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%); color: #000;',
        error: 'background: linear-gradient(135deg, #ff4757 0%, #ff3742 100%); color: #fff;',
        warning: 'background: linear-gradient(135deg, #ffa500 0%, #ff8c00 100%); color: #000;',
        info: 'background: linear-gradient(135deg, #00d4ff 0%, #0ea5e9 100%); color: #000;'
    };
    
    notification.style.cssText += colors[type] || colors.info;
    notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px;">
            <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'error' ? 'x-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
            <span>${message}</span>
        </div>
    `;
    
    // Show notification
    setTimeout(() => notification.style.transform = 'translateX(0)', 100);
    
    // Hide notification after 5 seconds
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => notification.remove(), 300);
    }, 5000);
}

// Global tax types storage
let globalTaxTypes = [];

// Load tax types from server
async function loadTaxTypes() {
    try {
        const response = await fetch('/api/tax-types', {
            credentials: 'same-origin'
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const taxTypes = await response.json();
        console.log('[POS] Tax types loaded:', taxTypes);
        
        // Store globally for access by tax functions
        globalTaxTypes = taxTypes;
        
        return taxTypes;
    } catch (error) {
        console.error('[POS] Error loading tax types:', error);
        // Fallback to default ITBIS if cannot load
        globalTaxTypes = [{
            id: 1,
            name: 'ITBIS',
            rate: 0.18,
            is_inclusive: true,
            description: 'Impuesto sobre Transferencias de Bienes Industrializados y Servicios'
        }];
        return globalTaxTypes;
    }
}

// Get current tax type ID (default to first available tax type or ITBIS)
function getCurrentTaxTypeId() {
    if (globalTaxTypes.length === 0) {
        console.warn('[POS] No tax types available, returning null');
        return null;
    }
    
    // Return first tax type ID (usually ITBIS)
    const taxTypeId = globalTaxTypes[0].id;
    console.log('[POS] getCurrentTaxTypeId returning:', taxTypeId);
    return taxTypeId;
}

// Get current tax type inclusivity (default to first available tax type)
function getCurrentTaxIsInclusive() {
    if (globalTaxTypes.length === 0) {
        console.warn('[POS] No tax types available, defaulting to inclusive');
        return true; // Default to inclusive
    }
    
    // Return first tax type inclusivity (usually ITBIS)
    const isInclusive = globalTaxTypes[0].is_inclusive;
    console.log('[POS] getCurrentTaxIsInclusive returning:', isInclusive);
    return isInclusive;
}

// Get current tax type object (default to first available tax type)
function getCurrentTaxType() {
    if (globalTaxTypes.length === 0) {
        console.warn('[POS] No tax types available, returning default ITBIS');
        return {
            id: 1,
            name: 'ITBIS',
            rate: 0.18,
            is_inclusive: true,
            description: 'Impuesto sobre Transferencias de Bienes Industrializados y Servicios'
        };
    }
    
    // Return first tax type (usually ITBIS)
    const taxType = globalTaxTypes[0];
    console.log('[POS] getCurrentTaxType returning:', taxType);
    return taxType;
}

// Cart Management with localStorage
class CartManager {
    constructor() {
        this.storageKey = 'fourone_pos_cart';
        this.cart = this.loadCartFromStorage();
        this.setupCrossTabSync();
        this.setupServiceWorkerCommunication();
    }

    // Load cart from localStorage
    loadCartFromStorage() {
        try {
            const storedCart = localStorage.getItem(this.storageKey);
            const cart = storedCart ? JSON.parse(storedCart) : [];
            console.log('[Cart] Loaded cart from storage:', cart);
            return cart;
        } catch (error) {
            console.error('[Cart] Error loading cart from storage:', error);
            return [];
        }
    }

    // Save cart to localStorage
    saveCartToStorage() {
        try {
            localStorage.setItem(this.storageKey, JSON.stringify(this.cart));
            console.log('[Cart] Cart saved to storage:', this.cart);
            
            // Broadcast cart change for cross-tab sync
            this.broadcastCartChange();
        } catch (error) {
            console.error('[Cart] Error saving cart to storage:', error);
        }
    }

    // Setup cross-tab synchronization
    setupCrossTabSync() {
        // Listen for storage events from other tabs
        window.addEventListener('storage', (e) => {
            if (e.key === this.storageKey && e.newValue !== null) {
                console.log('[Cart] Cart updated in another tab, syncing...');
                this.cart = JSON.parse(e.newValue);
                updateCartDisplay();
                showNotification('Carrito sincronizado desde otra pesta√±a', 'info');
            }
        });

        // Listen for custom cart change events within the same tab
        window.addEventListener('cartChanged', () => {
            updateCartDisplay();
        });
    }

    // Broadcast cart changes using Broadcast Channel API
    broadcastCartChange() {
        if ('BroadcastChannel' in window) {
            const channel = new BroadcastChannel('cart_sync');
            channel.postMessage({
                type: 'CART_UPDATED',
                cart: this.cart,
                timestamp: Date.now()
            });
        }

        // Dispatch custom event for same-tab components
        window.dispatchEvent(new CustomEvent('cartChanged'));
    }

    // Add item to cart
    addItem(productId, productName, price, taxTypes = []) {
        const existingItem = this.cart.find(item => item.id === productId);
        
        if (existingItem) {
            existingItem.quantity += 1;
        } else {
            this.cart.push({
                id: productId,
                name: productName,
                price: price,
                quantity: 1,
                addedAt: Date.now(),
                tax_types: taxTypes || []
            });
        }
        
        this.saveCartToStorage();
        showNotification(`${productName} agregado al carrito`, 'success');
    }

    // Add item directly with specific quantity (for loading existing sales)
    addItemDirectly(productId, productName, price, quantity) {
        const existingItem = this.cart.find(item => item.id === productId);
        
        if (existingItem) {
            existingItem.quantity = quantity;
        } else {
            this.cart.push({
                id: productId,
                name: productName,
                price: price,
                quantity: quantity,
                addedAt: Date.now()
            });
        }
        
        this.saveCartToStorage();
    }

    // Remove item from cart
    removeItem(productId) {
        const item = this.cart.find(item => item.id === productId);
        this.cart = this.cart.filter(item => item.id !== productId);
        this.saveCartToStorage();
        
        if (item) {
            showNotification(`${item.name} removido del carrito`, 'warning');
        }
    }

    // Update item quantity
    updateQuantity(productId, quantity) {
        const item = this.cart.find(item => item.id === productId);
        if (item) {
            if (quantity > 0) {
                item.quantity = quantity;
                this.saveCartToStorage();
            } else {
                this.removeItem(productId);
            }
        }
    }

    // Clear cart
    clear() {
        this.cart = [];
        this.saveCartToStorage();
        showNotification('Carrito limpiado', 'info');
    }

    // Get cart items
    getItems() {
        return this.cart;
    }

    // Get cart totals with automatic tax calculation per product (DR fiscal compliance)
    getTotals() {
        let subtotal = 0;
        let inclusiveTaxes = {}; // Taxes included in prices
        let exclusiveTaxes = {}; // Taxes to be added to base
        
        // First pass: Calculate subtotal and identify tax types per product
        this.cart.forEach(item => {
            const itemSubtotal = item.price * item.quantity;
            subtotal += itemSubtotal;
            
            // Process taxes for this product
            if (item.tax_types && item.tax_types.length > 0) {
                item.tax_types.forEach(taxType => {
                    if (taxType.rate > 0) {
                        const taxName = taxType.name || 'ITBIS';
                        
                        if (taxType.is_inclusive) {
                            // Tax included in price - extract from item total
                            const taxAmount = itemSubtotal - (itemSubtotal / (1 + taxType.rate));
                            if (!inclusiveTaxes[taxName]) {
                                inclusiveTaxes[taxName] = {
                                    rate: taxType.rate,
                                    amount: 0,
                                    is_inclusive: true
                                };
                            }
                            inclusiveTaxes[taxName].amount += taxAmount;
                        } else {
                            // Tax exclusive - will be calculated on tax base later
                            if (!exclusiveTaxes[taxName]) {
                                exclusiveTaxes[taxName] = {
                                    rate: taxType.rate,
                                    amount: 0,
                                    is_inclusive: false,
                                    itemsSubtotal: 0 // Track subtotal of items with this tax
                                };
                            }
                            exclusiveTaxes[taxName].itemsSubtotal += itemSubtotal;
                        }
                    }
                });
            }
            // If no tax_types, the product is tax exempt (no tax calculation)
        });
        
        // Calculate service charge (propina) if enabled - applies before exclusive taxes per DR law
        const applyServiceCharge = document.getElementById('apply-service-charge')?.checked || false;
        const serviceChargeRate = 0.10; // 10%
        const serviceCharge = applyServiceCharge ? subtotal * serviceChargeRate : 0;
        
        // Calculate exclusive taxes on tax base (subtotal + service charge for DR compliance)
        const taxBase = subtotal + serviceCharge;
        Object.keys(exclusiveTaxes).forEach(taxName => {
            const taxInfo = exclusiveTaxes[taxName];
            // Apply tax proportionally to items that have this tax type
            const proportion = taxInfo.itemsSubtotal / subtotal;
            taxInfo.amount = taxBase * proportion * taxInfo.rate;
        });
        
        // Combine all taxes for breakdown and total calculation
        const taxBreakdown = { ...inclusiveTaxes, ...exclusiveTaxes };
        const totalInclusiveTax = Object.values(inclusiveTaxes).reduce((sum, tax) => sum + tax.amount, 0);
        const totalExclusiveTax = Object.values(exclusiveTaxes).reduce((sum, tax) => sum + tax.amount, 0);
        const totalTax = totalInclusiveTax + totalExclusiveTax;
        
        const total = subtotal + serviceCharge + totalExclusiveTax;
        
        // For backward compatibility, provide a single tax rate (average)
        const averageTaxRate = subtotal > 0 ? totalTax / subtotal : 0;
        
        console.log('[POS] Tax calculation:', {
            subtotal,
            serviceCharge,
            taxBase,
            inclusiveTaxes,
            exclusiveTaxes,
            totalTax,
            total
        });
        
        return { 
            subtotal, 
            tax: totalTax, 
            serviceCharge, 
            total, 
            taxRate: averageTaxRate, 
            applyServiceCharge,
            taxBreakdown  // Detailed tax information
        };
    }

    // Setup service worker communication
    setupServiceWorkerCommunication() {
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.addEventListener('message', (event) => {
                if (event.data.type === 'offline-request-queued') {
                    showNotification('Operaci√≥n guardada - se procesar√° cuando vuelva la conexi√≥n', 'warning');
                } else if (event.data.type === 'offline-request-synced') {
                    showNotification('Operaci√≥n sincronizada exitosamente', 'success');
                }
            });
        }
    }
}

// Connection Status Manager
class ConnectionManager {
    constructor() {
        this.isOnline = navigator.onLine;
        this.setupConnectionListeners();
        this.updateConnectionStatus();
    }

    setupConnectionListeners() {
        window.addEventListener('online', () => {
            this.isOnline = true;
            this.updateConnectionStatus();
            this.onConnectionRestored();
        });

        window.addEventListener('offline', () => {
            this.isOnline = false;
            this.updateConnectionStatus();
            this.onConnectionLost();
        });
    }

    updateConnectionStatus() {
        const statusIndicator = document.getElementById('connection-status');
        if (statusIndicator) {
            if (this.isOnline) {
                statusIndicator.className = 'connection-status online';
                statusIndicator.innerHTML = '<i class="bi bi-wifi"></i> En l√≠nea';
            } else {
                statusIndicator.className = 'connection-status offline';
                statusIndicator.innerHTML = '<i class="bi bi-wifi-off"></i> Offline';
            }
        }
    }

    onConnectionRestored() {
        showNotification('Conexi√≥n restaurada - sincronizando datos...', 'success');
        
        // Force sync with service worker
        if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
            navigator.serviceWorker.controller.postMessage({ type: 'FORCE_SYNC' });
        }
        
        // Refresh data
        loadTables();
        refreshProductData();
    }

    onConnectionLost() {
        showNotification('Conexi√≥n perdida - trabajando offline', 'warning');
    }
}

// Device Detection Class
class DeviceDetector {
    constructor() {
        this.deviceInfo = this.detectDevice();
    }
    
    detectDevice() {
        const userAgent = navigator.userAgent.toLowerCase();
        const touchSupport = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
        const screenWidth = window.screen.width;
        const screenHeight = window.screen.height;
        const pixelRatio = window.devicePixelRatio || 1;
        
        // Check for mobile/tablet indicators
        const isMobile = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(userAgent);
        const isTablet = /(ipad|android(?!.*mobile)|tablet)/i.test(userAgent) || 
                        (touchSupport && Math.min(screenWidth, screenHeight) >= 768);
        
        // Additional checks for touch-capable devices
        const isTouchDevice = touchSupport && (isMobile || isTablet || 
            (screenWidth <= 1024 && screenHeight <= 1366)); // Common tablet resolutions
        
        // Determine receipt format based on device type
        const receiptFormat = (isMobile || (isTablet && Math.min(screenWidth, screenHeight) < 800)) ? '58mm' : '80mm';
        
        return {
            isMobile: isMobile,
            isTablet: isTablet,
            isTouchDevice: isTouchDevice,
            isDesktop: !isMobile && !isTablet && !isTouchDevice,
            receiptFormat: receiptFormat,
            screenWidth: screenWidth,
            screenHeight: screenHeight,
            pixelRatio: pixelRatio,
            userAgent: userAgent,
            touchSupport: touchSupport
        };
    }
    
    getReceiptFormat() {
        return this.deviceInfo.receiptFormat;
    }
    
    getDeviceInfo() {
        return this.deviceInfo;
    }
    
    logDeviceInfo() {
        console.log('[Device] Detected device info:', this.deviceInfo);
    }
}


// Global instances
let cartManager;
let connectionManager;
let deviceDetector;

// Legacy cart variable for backward compatibility
let cart = [];

// Load products for category with offline support
async function loadProducts(categoryId) {
    try {
        const products = await apiRequest(`/api/products?category_id=${categoryId}`);
        
        const container = document.getElementById(`products-${categoryId}`);
        if (!container) {
            console.error('[POS] Product container not found:', `products-${categoryId}`);
            return;
        }
        
        container.innerHTML = '';
        
        products.forEach(product => {
            const taxTypesBase64 = btoa(JSON.stringify(product.tax_types || []));
            const productCard = `
                <div class="col-md-4 col-lg-3 mb-3">
                    <div class="product-card fade-in-up" onclick="addToCart(${product.id}, '${product.name.replace(/'/g, "\\'")}', ${product.price}, '${taxTypesBase64}')"
                        <div class="card-body">
                            <div class="product-name">${product.name}</div>
                            <div class="product-price">RD$ ${product.price.toFixed(2)}</div>
                            <small class="opacity-75">Stock: ${product.stock}</small>
                        </div>
                    </div>
                </div>
            `;
            container.innerHTML += productCard;
        });
        
        console.log('[POS] Product data cached successfully');
        
    } catch (error) {
        console.error('[POS] Error loading products:', error.message || error);
        
        if (!navigator.onLine) {
            showNotification('Sin conexi√≥n - intentando cargar desde cach√©...', 'warning');
        } else {
            showNotification(`Error cargando productos: ${error.message}`, 'error');
        }
    }
}

// Switch between product categories
function switchCategory(categoryId) {
    // Remove active class from all category pills
    document.querySelectorAll('.category-pill').forEach(pill => {
        pill.classList.remove('active');
    });
    
    // Add active class to clicked category
    const activePill = document.querySelector(`[data-category-id="${categoryId}"]`);
    if (activePill) {
        activePill.classList.add('active');
    }
    
    // Hide all category product sections
    document.querySelectorAll('.category-products').forEach(section => {
        section.classList.add('d-none');
    });
    
    // Show selected category products section
    const selectedSection = document.getElementById(`category-products-${categoryId}`);
    if (selectedSection) {
        selectedSection.classList.remove('d-none');
    }
    
    // Load products for the selected category
    loadProducts(categoryId);
}

// Store loaded tax types globally
let loadedTaxTypes = [];

// Load tax types from API
async function loadTaxTypes() {
    try {
        console.log('[POS] Loading tax types from API...');
        const response = await apiRequest('/api/tax-types');
        console.log('[POS] Tax types API response:', response);
        
        // FIXED: API returns array directly, not wrapped in tax_types property
        if (Array.isArray(response) && response.length > 0) {
            loadedTaxTypes = response;
            populateTaxTypeDropdown();
        } else {
            console.error('[Tax] No tax types found in response');
            fallbackToDefaultTaxOptions();
        }
    } catch (error) {
        console.error('[Tax] Error loading tax types:', error);
        fallbackToDefaultTaxOptions();
    }
}

// Populate tax type dropdown with loaded data
function populateTaxTypeDropdown() {
    const taxSelect = document.getElementById('tax-type-select');
    if (!taxSelect) return;
    
    // Clear existing options
    taxSelect.innerHTML = '';
    
    // Find ITBIS Incluido (18%) as the default option
    let defaultTaxType = null;
    
    loadedTaxTypes.forEach(taxType => {
        const option = document.createElement('option');
        option.value = taxType.id;
        option.textContent = `${taxType.name} (${(taxType.rate * 100).toFixed(0)}%)${taxType.is_inclusive ? ' - Inclu√≠do' : ''}`;
        option.setAttribute('data-rate', taxType.rate);
        option.setAttribute('data-inclusive', taxType.is_inclusive);
        
        // Set ITBIS Incluido as default
        if (taxType.name.toLowerCase().includes('itbis') && taxType.is_inclusive && taxType.rate === 0.18) {
            defaultTaxType = taxType;
            option.selected = true;
        }
        
        taxSelect.appendChild(option);
    });
    
    // If no ITBIS Incluido found, select the first ITBIS option
    if (!defaultTaxType) {
        const itbisOption = loadedTaxTypes.find(t => 
            t.name.toLowerCase().includes('itbis') && t.rate === 0.18
        );
        if (itbisOption) {
            taxSelect.value = itbisOption.id;
        }
    }
    
    console.log('[Tax] Tax types loaded successfully:', loadedTaxTypes.length, 'types');
}



// Add product to cart (using CartManager)
function addToCart(productId, productName, price, taxTypes = []) {
    console.log('[CART DEBUG] üõí Intentando a√±adir producto al carrito:', {
        productId: productId,
        productName: productName,
        productPrice: price,
        productTaxTypes: taxTypes,
        taxTypesType: typeof taxTypes,
        timestamp: new Date().toISOString()
    });

    try {
        // Handle both array, JSON string, and base64 encoded inputs for tax_types
        let parsedTaxTypes = taxTypes;
        if (typeof taxTypes === 'string') {
            console.log('[CART DEBUG] üîÑ Parseando tax_types desde string:', taxTypes);
            try {
                // Try to decode as base64 first
                const decodedTaxTypes = atob(taxTypes);
                parsedTaxTypes = JSON.parse(decodedTaxTypes);
                console.log('[CART DEBUG] ‚úÖ Tax_types decodificados desde base64:', parsedTaxTypes);
            } catch (e) {
                console.log('[CART DEBUG] üîÑ No es base64, intentando JSON directo...');
                try {
                    parsedTaxTypes = JSON.parse(taxTypes);
                    console.log('[CART DEBUG] ‚úÖ Tax_types parseados como JSON directo:', parsedTaxTypes);
                } catch (e2) {
                    console.warn('[CART DEBUG] ‚ö†Ô∏è Failed to parse tax_types, using empty array:', e2);
                    parsedTaxTypes = [];
                }
            }
        }
        
        // Ensure it's an array
        if (!Array.isArray(parsedTaxTypes)) {
            console.log('[CART DEBUG] üîÑ Convirtiendo tax_types a array:', parsedTaxTypes);
            parsedTaxTypes = [];
        }

        console.log('[CART DEBUG] üìä Estado del carrito antes de a√±adir:');
        const cartItemsBefore = cartManager.getItems();
        console.log('[CART DEBUG] üìä Items en carrito:', cartItemsBefore.length, cartItemsBefore);

        console.log('[CART DEBUG] ‚ûï Llamando cartManager.addItem con:', {
            productId, productName, price, parsedTaxTypes
        });
        
        cartManager.addItem(productId, productName, price, parsedTaxTypes);

        console.log('[CART DEBUG] üìä Estado del carrito despu√©s de a√±adir:');
        const cartItemsAfter = cartManager.getItems();
        console.log('[CART DEBUG] üìä Items en carrito:', cartItemsAfter.length, cartItemsAfter);

        console.log('[CART DEBUG] üéâ Producto a√±adido exitosamente:', productName);
        
    } catch (error) {
        console.error('[CART DEBUG] ‚ùå Error adding product to cart:', {
            error: error,
            errorMessage: error.message,
            errorStack: error.stack,
            productId: productId,
            productName: productName
        });
        showNotification(`Error agregando producto al carrito: ${error.message}`, 'error');
    }
}

// Update cart display
function updateCartDisplay() {
    const cartItems = document.getElementById('cart-items');
    const items = cartManager.getItems();
    
    if (items.length === 0) {
        cartItems.innerHTML = '<p class="text-muted">No hay productos en el carrito</p>';
        document.getElementById('subtotal').textContent = 'RD$ 0.00';
        document.getElementById('tax').textContent = 'RD$ 0.00';
        document.getElementById('total').textContent = 'RD$ 0.00';
        return;
    }
    
    let html = '';
    const totals = cartManager.getTotals();
    
    items.forEach(item => {
        const itemTotal = item.price * item.quantity;
        
        html += `
            <div class="cart-item d-flex justify-content-between align-items-center mb-2">
                <div>
                    <div class="fw-bold">${item.name}</div>
                    <small class="text-muted">
                        <button class="btn btn-sm btn-outline-secondary me-1" onclick="updateItemQuantity(${item.id}, ${item.quantity - 1})">-</button>
                        ${item.quantity}
                        <button class="btn btn-sm btn-outline-secondary ms-1 me-2" onclick="updateItemQuantity(${item.id}, ${item.quantity + 1})">+</button>
                        x RD$ ${item.price.toFixed(2)}
                    </small>
                </div>
                <div>
                    <span class="me-2">RD$ ${itemTotal.toFixed(2)}</span>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeFromCart(${item.id})">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
        `;
    });
    
    cartItems.innerHTML = html;
    
    document.getElementById('subtotal').textContent = `RD$ ${totals.subtotal.toFixed(2)}`;
    document.getElementById('tax').textContent = `RD$ ${totals.tax.toFixed(2)}`;
    
    // Update service charge display
    const serviceChargeRow = document.getElementById('service-charge-row');
    const serviceChargeElement = document.getElementById('service-charge');
    if (totals.applyServiceCharge && totals.serviceCharge > 0) {
        serviceChargeRow.style.display = 'flex';
        serviceChargeElement.textContent = `RD$ ${totals.serviceCharge.toFixed(2)}`;
    } else {
        serviceChargeRow.style.display = 'none';
    }
    
    document.getElementById('total').textContent = `RD$ ${totals.total.toFixed(2)}`;
    
    // Update tax label based on actual tax breakdown
    const taxLabel = document.getElementById('tax-label');
    const taxRow = document.getElementById('tax-row');
    
    if (taxLabel && taxRow) {
        const taxBreakdown = totals.taxBreakdown || {};
        const taxTypes = Object.keys(taxBreakdown);
        
        if (totals.tax === 0 || taxTypes.length === 0) {
            // No taxes applied - show "Sin impuestos"
            taxLabel.textContent = 'Sin impuestos';
            taxRow.style.display = 'none';
        } else if (taxTypes.length === 1) {
            // Single tax type - show specific type with percentage
            const taxType = taxTypes[0];
            const percentage = Math.round(taxBreakdown[taxType].rate * 100);
            taxLabel.textContent = `${taxType} (${percentage}%)`;
            taxRow.style.display = 'flex';
        } else {
            // Multiple tax types - show "Impuestos" with average percentage
            const averagePercentage = Math.round(totals.taxRate * 100);
            taxLabel.textContent = `Impuestos (${averagePercentage}% prom.)`;
            taxRow.style.display = 'flex';
            
            // Add a tooltip or detailed breakdown in console for debugging
            console.log('[POS] Tax breakdown:', taxBreakdown);
        }
    }
    
    // Update legacy cart variable for backward compatibility
    cart = items;
    
    // Recalculate change when cart totals change
    if (window.paymentSystem) {
        window.paymentSystem.calculateChange();
    }
}

// Remove item from cart (using CartManager)
function removeFromCart(productId) {
    cartManager.removeItem(productId);
}

// Update item quantity
function updateItemQuantity(productId, newQuantity) {
    cartManager.updateQuantity(productId, newQuantity);
}

// Clear cart (using CartManager)
function clearCart() {
    cartManager.clear();
    document.getElementById('table-select').value = '';
    document.getElementById('ncf-type-select').value = 'consumo';
    document.getElementById('apply-service-charge').checked = false; // Reset service charge
    toggleClientInfo(); // Reset client info section
}

// Update totals when service charge checkbox changes
function updateTotals() {
    updateCartDisplay();
}

// Show notification to user
function showNotification(message, type = 'info') {
    // Create or update notification element
    let notification = document.getElementById('notification');
    if (!notification) {
        notification = document.createElement('div');
        notification.id = 'notification';
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            z-index: 9999;
            font-weight: 600;
            max-width: 300px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
            transform: translateX(100%);
        `;
        document.body.appendChild(notification);
    }
    
    // Set notification style based on type
    const colors = {
        success: 'background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%); color: #000;',
        error: 'background: linear-gradient(135deg, #ff4757 0%, #ff3742 100%); color: #fff;',
        warning: 'background: linear-gradient(135deg, #ffa500 0%, #ff8c00 100%); color: #000;',
        info: 'background: linear-gradient(135deg, #00d4ff 0%, #0ea5e9 100%); color: #000;'
    };
    
    notification.style.cssText += colors[type] || colors.info;
    notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px;">
            <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'error' ? 'x-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
            <span>${message}</span>
        </div>
    `;
    
    // Show notification
    setTimeout(() => notification.style.transform = 'translateX(0)', 100);
    
    // Hide notification after 5 seconds
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => notification.remove(), 300);
    }, 5000);
}

// Refresh product data for offline caching
function refreshProductData() {
    if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
        const channel = new MessageChannel();
        channel.port1.onmessage = (event) => {
            if (event.data.success) {
                console.log('[POS] Product data cached successfully');
            }
        };
        
        navigator.serviceWorker.controller.postMessage({ 
            type: 'CACHE_API_DATA' 
        }, [channel.port2]);
    }
}

// Process sale (updated for offline support)
function processSale() {
    const items = cartManager.getItems();
    if (items.length === 0) {
        showNotification('El carrito est√° vac√≠o', 'warning');
        return;
    }
    
    const ncfType = document.getElementById('ncf-type-select').value;
    
    // Validate client info for fiscal/government invoices
    if (ncfType === 'credito_fiscal' || ncfType === 'gubernamental') {
        const clientRnc = document.getElementById('client-rnc').value.trim();
        
        if (!clientRnc) {
            showNotification('Para comprobantes fiscales y gubernamentales debe completar el RNC/c√©dula del cliente', 'error');
            return;
        }
    }
    
    const tableId = document.getElementById('table-select').value || null;
    const description = document.getElementById('order-description').value.trim() || '';
    
    // Disable button during processing
    const processButton = document.getElementById('process-sale');
    const originalText = processButton.innerHTML;
    processButton.disabled = true;
    processButton.innerHTML = '<i class="bi bi-spinner-border me-2"></i> Procesando...';
    
    // Create sale first
    fetch('/api/sales', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        credentials: 'same-origin',
        body: JSON.stringify({
            table_id: tableId,
            description: description
        })
    })
    .then(response => response.json())
    .then(sale => {
        if (sale.error) {
            showNotification('Error al crear venta: ' + sale.error, 'error');
            return Promise.reject(sale.error);
        }
        
        // Add items to sale - using cart items for compatibility
        const promises = items.map(item => 
            fetch(`/api/sales/${sale.id}/items`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                credentials: 'same-origin',
                body: JSON.stringify({
                    product_id: item.id,
                    quantity: item.quantity,
                    // Include tax information if available from current selection
                    tax_type_id: getCurrentTaxTypeId(),
                    is_inclusive: getCurrentTaxIsInclusive()
                })
            })
        );
        
        return Promise.all(promises).then(() => sale);
    })
    .then(sale => {
        // Finalize sale
        const paymentMethod = document.getElementById('payment-method-select').value;
        const taxType = getCurrentTaxType();
        const finalizationData = {
            payment_method: paymentMethod,
            ncf_type: ncfType,
            tax_rate: taxType.rate,
            tax_type_id: taxType.id,
            tax_is_inclusive: taxType.is_inclusive,
            apply_service_charge: document.getElementById('apply-service-charge').checked
        };
        
        // Add cash payment details if paying with cash
        if (paymentMethod === 'cash') {
            const cashReceived = parseFloat(document.getElementById('cash-received').value) || 0;
            const total = cartManager.getTotals().total;
            
            if (cashReceived < total) {
                showNotification('El efectivo recibido debe ser mayor o igual al total', 'error');
                return Promise.reject('Efectivo insuficiente');
            }
            
            finalizationData.cash_received = cashReceived;
            finalizationData.change_amount = cashReceived - total;
        }
        
        // Always add client name if provided (for identification)
        const clientName = document.getElementById('client-name').value.trim();
        if (clientName) {
            finalizationData.client_name = clientName;
        }
        
        // Add RNC for fiscal/government invoices
        if (ncfType === 'credito_fiscal' || ncfType === 'gubernamental') {
            finalizationData.client_rnc = document.getElementById('client-rnc').value.trim();
        }
        
        return fetch(`/api/sales/${sale.id}/finalize`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            credentials: 'same-origin',
            body: JSON.stringify(finalizationData)
        });
    })
    .then(response => response.json())
    .then(result => {
        if (result.error) {
            showNotification('Error al finalizar venta: ' + result.error, 'error');
            return;
        }
        
        if (result.offline_queued) {
            showNotification('Venta guardada - se procesar√° cuando vuelva la conexi√≥n', 'warning');
        } else {
            showNotification(`Venta procesada exitosamente. NCF: ${result.ncf}`, 'success');
            
            // Automatically print receipt with appropriate format for device
            if (result.id) {
                const saleData = {
                    sale_id: result.id,  // Use result.id from finalize_sale response
                    table_id: result.table_id || null
                };
                printReceipt(saleData).then(printed => {
                    if (printed) {
                        console.log('[POS] Receipt printed successfully after sale');
                    } else {
                        console.log('[POS] Receipt printing failed, but sale was processed');
                    }
                }).catch(error => {
                    console.error('[POS] Receipt printing error:', error);
                    // Don't show error to user as sale was successful
                });
            }
        }
        
        clearCart();
        loadTables(); // Refresh table list
    })
    .catch(error => {
        console.error('[DEBUG PROCESS] Full error object:', error);
        console.error('[DEBUG PROCESS] Error message:', error.message);
        console.error('[DEBUG PROCESS] Error stack:', error.stack);
        console.error('[DEBUG PROCESS] Error type:', typeof error);
        console.error('[DEBUG PROCESS] Error string:', String(error));
        showNotification('Error al procesar la venta', 'error');
    })
    .finally(() => {
        // Re-enable button
        processButton.disabled = false;
        processButton.innerHTML = originalText;
    });
}

// Assign order to table without processing (updated for offline support)
function assignToTable() {
    const items = cartManager.getItems();
    if (items.length === 0) {
        showNotification('El carrito est√° vac√≠o', 'warning');
        return;
    }
    
    const tableId = document.getElementById('table-select').value;
    if (!tableId) {
        showNotification('Debe seleccionar una mesa', 'warning');
        return;
    }
    
    const description = document.getElementById('order-description').value.trim() || '';
    
    // Get customer information if provided
    const customerName = document.getElementById('client-name').value.trim() || '';
    const customerRnc = document.getElementById('client-rnc').value.trim() || '';
    
    // Disable button during processing
    const assignButton = document.getElementById('assign-table');
    const originalText = assignButton.innerHTML;
    assignButton.disabled = true;
    assignButton.innerHTML = '<i class="bi bi-spinner-border me-2"></i> Asignando...';
    
    // Prepare sale data
    const saleData = {
        table_id: tableId,
        description: description
    };
    
    // Add customer information if provided
    if (customerName) {
        saleData.customer_name = customerName;
    }
    if (customerRnc) {
        saleData.customer_rnc = customerRnc;
    }
    
    // Create sale first
    fetch('/api/sales', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        credentials: 'same-origin',
        body: JSON.stringify(saleData)
    })
    .then(response => response.json())
    .then(sale => {
        if (sale.error) {
            showNotification('Error al crear orden: ' + sale.error, 'error');
            return Promise.reject(sale.error);
        }
        
        // Add items to sale - using cart items for compatibility
        const promises = items.map(item => 
            fetch(`/api/sales/${sale.id}/items`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                credentials: 'same-origin',
                body: JSON.stringify({
                    product_id: item.id,
                    quantity: item.quantity,
                    // Include tax information if available from current selection
                    tax_type_id: getCurrentTaxTypeId(),
                    is_inclusive: getCurrentTaxIsInclusive()
                })
            })
        );
        
        return Promise.all(promises).then(() => sale);
    })
    .then(sale => {
        // Update table status to occupied
        return fetch(`/api/tables/${tableId}/status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            credentials: 'same-origin',
            body: JSON.stringify({
                status: 'occupied'
            })
        }).then(() => sale);
    })
    .then(sale => {
        if (sale.offline_queued) {
            showNotification('Orden guardada - se procesar√° cuando vuelva la conexi√≥n', 'warning');
        } else {
            showNotification(`Orden asignada exitosamente a Mesa ${tableId}. Estado: Pendiente`, 'success');
        }
        clearCart();
        loadTables(); // Refresh table list
        loadPendingOrders(); // Update pending orders counter
    })
    .catch(error => {
        console.error('[DEBUG ASSIGN] Full error object:', error);
        console.error('[DEBUG ASSIGN] Error message:', error.message);
        console.error('[DEBUG ASSIGN] Error stack:', error.stack);
        console.error('[DEBUG ASSIGN] Error type:', typeof error);
        console.error('[DEBUG ASSIGN] Error string:', String(error));
        showNotification('Error al asignar orden a la mesa', 'error');
    })
    .finally(() => {
        // Re-enable button
        assignButton.disabled = false;
        assignButton.innerHTML = originalText;
    });
}

// Clear cart - removed duplicate function, using CartManager version only

// Toggle client information fields based on NCF type
function toggleClientInfo() {
    const ncfType = document.getElementById('ncf-type-select').value;
    const clientInfoSection = document.getElementById('client-info-section');
    
    if (ncfType === 'credito_fiscal' || ncfType === 'gubernamental') {
        clientInfoSection.style.display = 'block';
        // Make RNC field required for fiscal receipts
        document.getElementById('client-rnc').required = true;
        // Client name is always optional but recommended for identification
    } else {
        clientInfoSection.style.display = 'none';
        // Remove required attribute from RNC
        document.getElementById('client-rnc').required = false;
        // Clear only RNC value (client name stays for identification)
        document.getElementById('client-rnc').value = '';
    }
}

// Load available tables with offline support
function loadTables() {
    fetch('/api/tables?status=available', {
        credentials: 'same-origin'
    })
        .then(response => response.json())
        .then(tables => {
            const tableSelect = document.getElementById('table-select');
            tableSelect.innerHTML = '<option value="">Seleccione una mesa</option>';
            
            tables.forEach(table => {
                const option = document.createElement('option');
                option.value = table.id;
                option.textContent = `Mesa ${table.number}${table.name ? ' - ' + table.name : ''}`;
                tableSelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('[POS] Error loading tables:', error);
            if (!navigator.onLine) {
                showNotification('Cargando mesas desde cach√© offline...', 'info');
            }
        });
}

// Service Worker Registration
async function registerServiceWorker() {
    if ('serviceWorker' in navigator) {
        try {
            const registration = await navigator.serviceWorker.register('/static/sw.js');
            console.log('[SW] Service Worker registered successfully:', registration);
            
            // Listen for updates
            registration.addEventListener('updatefound', () => {
                const newWorker = registration.installing;
                newWorker.addEventListener('statechange', () => {
                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                        showNotification('Nueva versi√≥n disponible - recarga para actualizar', 'info');
                    }
                });
            });
            
            // Cache initial API data
            if (navigator.serviceWorker.controller) {
                refreshProductData();
            }
            
            return registration;
        } catch (error) {
            console.error('[SW] Service Worker registration failed:', error);
        }
    } else {
        console.log('[SW] Service Worker not supported');
    }
}

// Tab Management Functions
function showProductsSection() {
    // Switch tab buttons
    document.getElementById('products-tab').classList.add('active');
    document.getElementById('orders-tab').classList.remove('active');
    
    // Switch sections
    document.getElementById('products-section').classList.remove('d-none');
    document.getElementById('orders-section').classList.add('d-none');
}

function showOrdersSection() {
    // Switch tab buttons
    document.getElementById('orders-tab').classList.add('active');
    document.getElementById('products-tab').classList.remove('active');
    
    // Switch sections
    document.getElementById('orders-section').classList.remove('d-none');
    document.getElementById('products-section').classList.add('d-none');
    
    // Load pending orders
    loadPendingOrders();
}

// Load pending orders from API
async function loadPendingOrders() {
    try {
        const data = await apiRequest('/api/pending-orders');
        const orders = data.orders || [];
        
        // Update order count in tab - with null check
        const countElement = document.getElementById('pending-orders-count');
        if (countElement) {
            countElement.textContent = orders.length;
            console.log('[Orders] Updated pending orders count:', orders.length);
        } else {
            console.warn('[Orders] pending-orders-count element not found');
        }
        
        // Display orders
        displayPendingOrders(orders);
        
    } catch (error) {
        console.error('[Orders] Error loading pending orders:', error);
        // Don't show notification on initial load
    }
}

// Display pending orders in the interface
function displayPendingOrders(orders) {
    const container = document.getElementById('pending-orders-container');
    
    if (orders.length === 0) {
        container.innerHTML = `
            <div class="empty-orders text-center py-5">
                <i class="bi bi-inbox" style="font-size: 3rem; color: #ddd;"></i>
                <h6 class="text-muted mt-3">No hay √≥rdenes pendientes</h6>
                <p class="text-muted mb-0">Las √≥rdenes de los meseros aparecer√°n aqu√≠</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = orders.map(order => `
        <div class="order-card" data-order-id="${order.id}">
            <div class="order-header">
                <div class="order-info">
                    <h6 class="order-title">
                        <i class="bi bi-table me-1"></i>
                        Mesa ${order.table_number || 'Sin asignar'}
                        ${order.table_name ? ` - ${order.table_name}` : ''}
                    </h6>
                    <small class="text-muted">
                        <i class="bi bi-person me-1"></i>
                        Mesero: ${order.waiter_name} ‚Ä¢ 
                        ${new Date(order.created_at).toLocaleTimeString('es-DO', {hour: '2-digit', minute: '2-digit'})}
                    </small>
                </div>
                <div class="order-status">
                    <span class="badge ${getOrderStatusBadgeClass(order.order_status)}">
                        ${getOrderStatusText(order.order_status)}
                    </span>
                </div>
            </div>
            
            <div class="order-items">
                ${order.items.map(item => `
                    <div class="order-item">
                        <span class="item-name">${item.product_name}</span>
                        <span class="item-quantity">√ó${item.quantity}</span>
                        <span class="item-price">RD$ ${item.total_price.toFixed(2)}</span>
                    </div>
                `).join('')}
            </div>
            
            <div class="order-footer">
                <div class="order-total">
                    <strong>Total: RD$ ${order.total.toFixed(2)}</strong>
                </div>
                <div class="order-actions">
                    <button class="btn btn-primary btn-sm" onclick="billOrder(${order.id})">
                        <i class="bi bi-receipt me-1"></i>
                        Facturar
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="viewOrderDetails(${order.id})">
                        <i class="bi bi-eye me-1"></i>
                        Ver
                    </button>
                </div>
            </div>
        </div>
    `).join('');
}

// Utility functions for order status
function getOrderStatusBadgeClass(status) {
    switch (status) {
        case 'sent_to_kitchen': return 'bg-info';
        case 'in_preparation': return 'bg-warning';
        case 'ready': return 'bg-success';
        default: return 'bg-secondary';
    }
}

function getOrderStatusText(status) {
    switch (status) {
        case 'not_sent': return 'No enviado';
        case 'sent_to_kitchen': return 'En cocina';
        case 'in_preparation': return 'Preparando';
        case 'ready': return 'Listo';
        default: return 'Pendiente';
    }
}

// Bill an order (load it into the cart for processing)
async function billOrder(orderId) {
    try {
        // Clear current cart first
        cartManager.clear();
        
        // Get order details using centralized API function
        const orderData = await apiRequest(`/api/sales/${orderId}/details`);
        const order = orderData.sale;
        
        if (!order || !order.items) {
            throw new Error('Datos de orden inv√°lidos recibidos del servidor');
        }
        
        // Add order items to cart
        order.items.forEach(item => {
            cartManager.addItemDirectly(
                item.product_id,
                item.product_name,
                item.unit_price,
                item.quantity
            );
        });
        
        // Set table if available
        if (order.table_id) {
            const tableSelect = document.getElementById('table-select');
            if (tableSelect) {
                tableSelect.value = order.table_id;
            }
        }
        
        // Set payment method if available
        if (order.payment_method) {
            const paymentMethodInputs = document.querySelectorAll('input[name="payment-method"]');
            paymentMethodInputs.forEach(input => {
                if (input.value === order.payment_method) {
                    input.checked = true;
                    // Trigger payment method change to show/hide cash fields
                    input.dispatchEvent(new Event('change'));
                }
            });
        }
        
        // Set customer name if available
        if (order.customer_name) {
            const customerNameInput = document.getElementById('client-name');
            if (customerNameInput) {
                customerNameInput.value = order.customer_name;
            }
        }
        
        // Set customer RNC if available
        if (order.customer_rnc) {
            const customerRncInput = document.getElementById('client-rnc');
            if (customerRncInput) {
                customerRncInput.value = order.customer_rnc;
            }
        }
        
        // Set NCF type based on customer info
        const ncfTypeSelect = document.getElementById('ncf-type-select');
        if (ncfTypeSelect) {
            if (order.customer_rnc) {
                ncfTypeSelect.value = 'credito_fiscal';
            } else if (order.customer_name) {
                ncfTypeSelect.value = 'gubernamental';
            } else {
                ncfTypeSelect.value = 'consumo';
            }
            // Trigger NCF type change to show/hide client info
            ncfTypeSelect.dispatchEvent(new Event('change'));
        }
        
        // Switch to products tab to show the cart
        showProductsSection();
        
        // Update cart display
        updateCartDisplay();
        
        // Store the order ID for finalization - we'll complete this original order
        window.currentOrderId = orderId;
        window.originalOrderData = order; // Store original order for completion
        
        // Show billing form instead of auto-finalizing
        showBillingForm(order);
        
    } catch (error) {
        console.error('[Orders] Error billing order:', error.message || error);
        showNotification(`Error cargando la orden: ${error.message}`, 'error');
    }
}

// Show billing form for order finalization
async function showBillingForm(order) {
    try {
        // Get tax types for the form
        const taxTypesResponse = await apiRequest('/api/tax-types');
        const taxTypes = taxTypesResponse || [];
        
        // Create billing form modal
        const billingFormHtml = `
            <div class="modal fade" id="billingModal" tabindex="-1" aria-labelledby="billingModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="billingModalLabel">
                                <i class="bi bi-receipt"></i> Facturar Orden #${order.id} - Mesa ${order.table_number || 'Sin asignar'}
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="billingForm">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label"><strong>M√©todo de Pago</strong></label>
                                        <div class="payment-methods">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="payment_method" id="billing_cash" value="cash" ${order.payment_method === 'cash' ? 'checked' : ''}>
                                                <label class="form-check-label" for="billing_cash">
                                                    <i class="bi bi-cash"></i> Efectivo
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="payment_method" id="billing_card" value="card" ${order.payment_method === 'card' ? 'checked' : ''}>
                                                <label class="form-check-label" for="billing_card">
                                                    <i class="bi bi-credit-card"></i> Tarjeta
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="payment_method" id="billing_transfer" value="transfer" ${order.payment_method === 'transfer' ? 'checked' : ''}>
                                                <label class="form-check-label" for="billing_transfer">
                                                    <i class="bi bi-bank"></i> Transferencia
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="billing_ncf_type" class="form-label"><strong>Tipo de Comprobante</strong></label>
                                        <select class="form-select" id="billing_ncf_type" name="ncf_type">
                                            <option value="consumo" ${(!order.customer_rnc && !order.customer_name) ? 'selected' : ''}>
                                                Consumo (P√∫blico General)
                                            </option>
                                            <option value="credito_fiscal" ${order.customer_rnc ? 'selected' : ''}>
                                                Cr√©dito Fiscal (Con RNC/C√©dula)
                                            </option>
                                            <option value="gubernamental" ${(order.customer_name && !order.customer_rnc) ? 'selected' : ''}>
                                                Gubernamental (Instituciones)
                                            </option>
                                            <option value="sin_comprobante">
                                                Sin Comprobante
                                            </option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Client Info (will show/hide based on NCF type) -->
                                <div id="billing_client_info" class="row mb-3" style="display: none;">
                                    <div class="col-md-6">
                                        <label for="billing_client_name" class="form-label">Nombre/Empresa</label>
                                        <input type="text" class="form-control" id="billing_client_name" name="client_name" value="${order.customer_name || ''}" placeholder="Nombre completo o empresa">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="billing_client_rnc" class="form-label">RNC/C√©dula</label>
                                        <input type="text" class="form-control" id="billing_client_rnc" name="client_rnc" value="${order.customer_rnc || ''}" placeholder="RNC o c√©dula del cliente">
                                    </div>
                                </div>
                                
                                <!-- Cash Payment Details -->
                                <div id="billing_cash_details" class="row mb-3" style="display: none;">
                                    <div class="col-md-6">
                                        <label for="billing_cash_received" class="form-label">Efectivo Recibido</label>
                                        <input type="number" class="form-control" id="billing_cash_received" name="cash_received" step="0.01" min="0" value="${order.total.toFixed(2)}">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Cambio</label>
                                        <div class="form-control-plaintext" id="billing_change_display">RD$ 0.00</div>
                                    </div>
                                </div>
                                
                                <!-- Tax Information (automatic) -->
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <div class="alert alert-info">
                                            <i class="bi bi-info-circle me-2"></i>
                                            <strong>Impuestos:</strong> Se aplicar√°n autom√°ticamente seg√∫n la configuraci√≥n de cada producto
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Order Summary -->
                                <div class="billing-summary">
                                    <h6><i class="bi bi-list-check"></i> Resumen de la Orden</h6>
                                    <div class="summary-details">
                                        <div class="row">
                                            <div class="col-6"><strong>Total de productos:</strong></div>
                                            <div class="col-6 text-end">RD$ ${order.total.toFixed(2)}</div>
                                        </div>
                                        <div class="row">
                                            <div class="col-6"><strong>Mesa:</strong></div>
                                            <div class="col-6 text-end">${order.table_number || 'Sin asignar'}</div>
                                        </div>
                                        <div class="row">
                                            <div class="col-6"><strong>Productos:</strong></div>
                                            <div class="col-6 text-end">${order.items ? order.items.length : 0} art√≠culos</div>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="button" class="btn btn-success" id="finalizeBillingBtn">
                                <i class="bi bi-check-circle"></i> Finalizar Facturaci√≥n
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Remove existing modal if any
        const existingModal = document.getElementById('billingModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // Add modal to DOM
        document.body.insertAdjacentHTML('beforeend', billingFormHtml);
        
        // Initialize modal functionality
        initializeBillingForm(order);
        
        // Show the modal
        const modal = new bootstrap.Modal(document.getElementById('billingModal'));
        modal.show();
        
    } catch (error) {
        console.error('[Billing] Error loading tax types:', error);
        showNotification('Error cargando formulario de facturaci√≥n', 'error');
    }
}

// Initialize billing form functionality
function initializeBillingForm(order) {
    const modal = document.getElementById('billingModal');
    
    // Handle NCF type change
    const ncfSelect = modal.querySelector('#billing_ncf_type');
    const clientInfoDiv = modal.querySelector('#billing_client_info');
    
    function toggleClientInfo() {
        const selectedType = ncfSelect.value;
        if (selectedType === 'credito_fiscal' || selectedType === 'gubernamental') {
            clientInfoDiv.style.display = 'block';
        } else {
            clientInfoDiv.style.display = 'none';
        }
    }
    
    ncfSelect.addEventListener('change', toggleClientInfo);
    toggleClientInfo(); // Initialize
    
    // Handle payment method change
    const paymentRadios = modal.querySelectorAll('input[name="payment_method"]');
    const cashDetailsDiv = modal.querySelector('#billing_cash_details');
    const cashReceivedInput = modal.querySelector('#billing_cash_received');
    const changeDisplay = modal.querySelector('#billing_change_display');
    
    function toggleCashDetails() {
        const selectedPayment = modal.querySelector('input[name="payment_method"]:checked');
        if (selectedPayment && selectedPayment.value === 'cash') {
            cashDetailsDiv.style.display = 'block';
            calculateChange();
        } else {
            cashDetailsDiv.style.display = 'none';
        }
    }
    
    function calculateChange() {
        const total = parseFloat(order.total);
        const received = parseFloat(cashReceivedInput.value) || 0;
        const change = received - total;
        
        changeDisplay.textContent = `RD$ ${change.toFixed(2)}`;
        changeDisplay.className = 'form-control-plaintext ' + (change < 0 ? 'text-danger' : 'text-success');
    }
    
    paymentRadios.forEach(radio => {
        radio.addEventListener('change', toggleCashDetails);
    });
    
    cashReceivedInput.addEventListener('input', calculateChange);
    toggleCashDetails(); // Initialize
    
    // Handle form submission
    const finalizeBtn = modal.querySelector('#finalizeBillingBtn');
    finalizeBtn.addEventListener('click', async () => {
        await finalizeBillingOrder(order);
    });
}

// Finalize the billing order
async function finalizeBillingOrder(order) {
    try {
        const modal = document.getElementById('billingModal');
        const formData = new FormData(modal.querySelector('#billingForm'));
        
        // Validate required fields
        const paymentMethod = formData.get('payment_method');
        const ncfType = formData.get('ncf_type');
        
        if (!paymentMethod) {
            showNotification('Debe seleccionar un m√©todo de pago', 'error');
            return;
        }
        
        // Validate client info for fiscal/government invoices
        if (ncfType === 'credito_fiscal' || ncfType === 'gubernamental') {
            const clientName = formData.get('client_name');
            const clientRnc = formData.get('client_rnc');
            
            if (!clientName || !clientRnc) {
                showNotification('Para comprobantes fiscales debe completar nombre/empresa y RNC/c√©dula', 'error');
                return;
            }
        }
        
        // Validate cash payment
        if (paymentMethod === 'cash') {
            const cashReceived = parseFloat(formData.get('cash_received')) || 0;
            const total = parseFloat(order.total);
            
            if (cashReceived < total) {
                showNotification('El efectivo recibido debe ser mayor o igual al total', 'error');
                return;
            }
        }
        
        // Disable button during processing
        const finalizeBtn = modal.querySelector('#finalizeBillingBtn');
        finalizeBtn.disabled = true;
        finalizeBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Procesando...';
        
        // Prepare finalization data (taxes handled automatically by server)
        const finalizeData = {
            ncf_type: ncfType,
            payment_method: paymentMethod,
            client_name: formData.get('client_name') || '',
            client_rnc: formData.get('client_rnc') || ''
        };
        
        // Add cash payment details
        if (paymentMethod === 'cash') {
            finalizeData.cash_received = parseFloat(formData.get('cash_received'));
            finalizeData.change_amount = finalizeData.cash_received - parseFloat(order.total);
        }
        
        console.log('[Billing] Finalizing order:', order.id, finalizeData);
        
        // Finalize the order
        const response = await apiRequest(`/api/sales/${order.id}/finalize`, {
            method: 'POST',
            body: JSON.stringify(finalizeData)
        });
        
        // Close modal
        const bootstrapModal = bootstrap.Modal.getInstance(modal);
        bootstrapModal.hide();
        
        // Clear cart and reset form
        cartManager.clear();
        window.currentOrderId = null;
        window.originalOrderData = null;
        
        // Refresh pending orders
        loadPendingOrders();
        
        showNotification(`Orden #${order.id} facturada exitosamente - NCF: ${response.ncf || 'N/A'}`, 'success');
        
    } catch (error) {
        console.error('[Billing] Error finalizing order:', error);
        showNotification(`Error facturando la orden: ${error.message}`, 'error');
        
        // Re-enable button
        const finalizeBtn = modal.querySelector('#finalizeBillingBtn');
        if (finalizeBtn) {
            finalizeBtn.disabled = false;
            finalizeBtn.innerHTML = '<i class="bi bi-check-circle"></i> Finalizar Facturaci√≥n';
        }
    }
}

// View order details modal
async function viewOrderDetails(orderId) {
    try {
        showNotification('Cargando detalles de la orden...', 'info');
        
        // Get order details using centralized API function
        const sale = await apiRequest(`/api/sales/${orderId}/table-details`);
        
        if (!sale || typeof sale !== 'object') {
            throw new Error('Respuesta inv√°lida del servidor');
        }
        
        // Create and show modal
        showOrderDetailsModal(sale);
        
    } catch (error) {
        console.error('[Orders] Error loading order details:', error.message || error);
        showNotification(`Error cargando detalles: ${error.message}`, 'error');
    }
}

// Show order details in a modal
function showOrderDetailsModal(sale) {
    let detailsHtml = `
        <div class="row mb-3">
            <div class="col-6"><strong>Venta ID:</strong> ${sale.id || 'N/A'}</div>
            <div class="col-6"><strong>Mesa:</strong> ${sale.table_number || 'N/A'}</div>
        </div>
        <div class="row mb-3">
            <div class="col-6"><strong>Fecha:</strong> ${sale.created_at ? new Date(sale.created_at).toLocaleString() : 'N/A'}</div>
            <div class="col-6"><strong>Total:</strong> RD$ ${sale.total ? sale.total.toFixed(2) : '0.00'}</div>
        </div>
        <div class="row mb-3">
            <div class="col-6"><strong>Estado:</strong> ${sale.status || 'N/A'}</div>
            <div class="col-6"><strong>Subtotal:</strong> RD$ ${sale.subtotal ? sale.subtotal.toFixed(2) : '0.00'}</div>
        </div>
        
        <h6>Productos:</h6>
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th>Cantidad</th>
                        <th>Precio</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    if (sale.items && Array.isArray(sale.items) && sale.items.length > 0) {
        sale.items.forEach(item => {
            detailsHtml += `
                <tr>
                    <td>${item.product_name || 'N/A'}</td>
                    <td>${item.quantity || 0}</td>
                    <td>RD$ ${item.unit_price ? item.unit_price.toFixed(2) : '0.00'}</td>
                    <td>RD$ ${item.total_price ? item.total_price.toFixed(2) : '0.00'}</td>
                </tr>
            `;
        });
    } else {
        detailsHtml += '<tr><td colspan="4" class="text-center">No hay productos en esta orden</td></tr>';
    }
    
    detailsHtml += `
                </tbody>
            </table>
        </div>
    `;
    
    // Create temporary modal
    const modalHtml = `
        <div class="modal fade" id="tempOrderModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Detalles de Orden #${sale.id}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        ${detailsHtml}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove any existing temporary modal
    const existingModal = document.getElementById('tempOrderModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to document
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Show modal
    const modalElement = document.getElementById('tempOrderModal');
    const modalInstance = new bootstrap.Modal(modalElement);
    modalInstance.show();
    
    // Remove modal from DOM when hidden
    modalElement.addEventListener('hidden.bs.modal', () => {
        modalElement.remove();
    });
}

// Toggle cash payment fields based on payment method
function toggleCashFields() {
    const paymentMethod = document.getElementById('payment-method-select').value;
    const cashSection = document.getElementById('cash-payment-section');
    
    if (paymentMethod === 'cash') {
        cashSection.style.display = 'block';
        // Auto-fill cash received with total amount
        const total = cartManager.getTotals().total;
        document.getElementById('cash-received').value = total.toFixed(2);
        calculateChange();
    } else {
        cashSection.style.display = 'none';
        document.getElementById('cash-received').value = '';
        document.getElementById('change-display').textContent = 'RD$ 0.00';
    }
}

// Calculate change to be given
function calculateChange() {
    const cashReceived = parseFloat(document.getElementById('cash-received').value) || 0;
    const total = cartManager.getTotals().total;
    const change = Math.max(0, cashReceived - total);
    
    const changeDisplay = document.getElementById('change-display');
    changeDisplay.textContent = `RD$ ${change.toFixed(2)}`;
    
    // Add visual feedback for insufficient cash
    if (cashReceived > 0 && cashReceived < total) {
        changeDisplay.style.color = '#dc3545';
        changeDisplay.innerHTML = `<i class="bi bi-exclamation-triangle"></i> RD$ ${change.toFixed(2)} (Insuficiente)`;
    } else if (change > 0) {
        changeDisplay.style.color = '#28a745';
        changeDisplay.innerHTML = `<i class="bi bi-check-circle"></i> RD$ ${change.toFixed(2)}`;
    } else {
        changeDisplay.style.color = '#6c757d';
    }
}

// Load existing sale for editing
async function loadSaleForEditing(saleData) {
    console.log('[POS] Loading sale for editing:', saleData);
    
    try {
        // Clear current cart
        console.log('[POS] Clearing current cart...');
        cartManager.clear();
        
        // Set table selection if applicable
        if (saleData.table_id) {
            console.log('[POS] Setting table ID to:', saleData.table_id);
            const tableSelect = document.getElementById('table-select');
            if (tableSelect) {
                tableSelect.value = saleData.table_id;
                console.log('[POS] Table set successfully');
            } else {
                console.warn('[POS] Table select element not found');
            }
        }
        
        // Set description if available
        if (saleData.description) {
            console.log('[POS] Setting description to:', saleData.description);
            const descriptionInput = document.getElementById('order-description');
            if (descriptionInput) {
                descriptionInput.value = saleData.description;
                console.log('[POS] Description set successfully');
            } else {
                console.warn('[POS] Description input not found');
            }
        }
        
        // Add items to cart
        console.log('[POS] Adding', saleData.items.length, 'items to cart...');
        for (const item of saleData.items) {
            console.log('[POS] Adding item:', item);
            try {
                cartManager.addItemDirectly(
                    item.product_id,
                    item.product_name,
                    item.price,
                    item.quantity
                );
                console.log('[POS] Item added successfully:', item.product_name);
            } catch (itemError) {
                console.error('[POS] Error adding item:', item, itemError);
            }
        }
        
        // Update cart display
        console.log('[POS] Updating cart display...');
        updateCartDisplay();
        
        showNotification(`Orden #${saleData.id} cargada para edici√≥n`, 'info');
        
        console.log('[POS] Sale loaded successfully for editing. Cart has', cartManager.getItems().length, 'items');
        
    } catch (error) {
        console.error('[POS] Error loading sale for editing:', error);
        showNotification('Error cargando la orden para edici√≥n', 'error');
    }
}

// Initialize POS System
async function initializePOS() {
    try {
        console.log('[POS] Initializing POS system...');
        
        // Initialize managers
        cartManager = new CartManager();
        connectionManager = new ConnectionManager();
        deviceDetector = new DeviceDetector();
        
        // Initialize payment system (globally available)
        window.paymentSystem = new PaymentSystem('{{ csrf_token() }}', cartManager);
        window.paymentSystem.initializePaymentMethod();
        
        // Log device information for debugging
        deviceDetector.logDeviceInfo();
        
        // Register service worker
        await registerServiceWorker();
        
        // Load initial cart state
        updateCartDisplay();
        
        // Check if we're editing an existing sale
        {% if edit_sale_data %}
        try {
            const editSaleData = {{ edit_sale_data | tojson }};
            console.log('[POS] Edit sale data received:', editSaleData);
            if (editSaleData && editSaleData.id) {
                await loadSaleForEditing(editSaleData);
            } else {
                console.error('[POS] Invalid edit sale data:', editSaleData);
            }
        } catch (error) {
            console.error('[POS] Error loading edit sale data:', error);
        }
        {% endif %}
        
        // Load products for the first category (default)
        const firstCategory = document.querySelector('[data-bs-toggle="pill"]');
        if (firstCategory) {
            const categoryId = firstCategory.getAttribute('data-bs-target').replace('#category-', '');
            loadProducts(categoryId);
        } else {
            // Fallback: load products for category 1 if no tabs found
            loadProducts(1);
        }
        
        // Load available tables
        console.log('[POS] About to load tables...');
        loadTables();
        
        // Load customers for dropdown
        console.log('[POS] About to load customers...');
        await loadCustomers();
        
        // Load pending orders count
        console.log('[POS] About to load pending orders...');
        await loadPendingOrders();
        
        // Load tax types from API
        console.log('[POS] About to load tax types...');
        await loadTaxTypes();
        
        // Check cash register status and show opening modal if needed
        console.log('[POS] About to check cash register status...');
        await checkCashRegisterStatus();
        
        console.log('[POS] POS system initialized successfully');
        showNotification('Sistema POS iniciado - Modo offline disponible', 'success');
        
        // Set up automatic refresh of pending orders counter every 15 seconds
        setInterval(() => {
            loadPendingOrders();
            console.log('[POS] Auto-refreshing pending orders counter');
        }, 15000); // 15 seconds
        
    } catch (error) {
        console.error('[POS] CRITICAL ERROR during initialization:', error);
        console.error('[POS] Error stack:', error.stack);
        showNotification('Error cr√≠tico inicializando el sistema POS. Por favor recarga la p√°gina.', 'error');
    }
}

// Check cash register status and update UI accordingly
async function checkCashRegisterStatus() {
    try {
        const response = await apiRequest('/api/cash-register/status');
        
        if (response.has_register) {
            if (response.has_open_session) {
                // Show cash controls for open session
                showCashControls(response);
            } else {
                // Hide cash controls for closed session  
                hideCashControls();
                // Show modal to open cash register if user has one assigned
                showOpenCashModal(response.register_name || 'Caja Registradora');
            }
        } else {
            // No register assigned
            console.warn('[Cash] No cash register assigned to user');
            hideCashControls();
        }
    } catch (error) {
        console.error('[Cash] Error checking cash register status:', error);
    }
}

// Show cash controls when session is open
function showCashControls(sessionData) {
    const closeBtn = document.getElementById('close-cash-btn');
    const statusIndicator = document.getElementById('cash-status-indicator');
    const statusText = document.getElementById('cash-status-text');
    
    if (closeBtn) {
        closeBtn.style.display = 'block';
    }
    
    if (statusIndicator) {
        statusIndicator.style.display = 'block';
        const statusDot = statusIndicator.querySelector('.status-dot');
        if (statusDot) {
            statusDot.className = 'status-dot cash-open';
        }
    }
    
    if (statusText) {
        statusText.textContent = `Caja: ${sessionData.register_name} (Abierta)`;
    }
}

// Hide cash controls when session is closed
function hideCashControls() {
    const closeBtn = document.getElementById('close-cash-btn');
    const statusIndicator = document.getElementById('cash-status-indicator');
    const statusText = document.getElementById('cash-status-text');
    
    if (closeBtn) {
        closeBtn.style.display = 'none';
    }
    
    if (statusIndicator) {
        statusIndicator.style.display = 'block';
        const statusDot = statusIndicator.querySelector('.status-dot');
        if (statusDot) {
            statusDot.className = 'status-dot cash-closed';
        }
    }
    
    if (statusText) {
        statusText.textContent = 'Caja: Cerrada';
    }
}

// Show open cash modal
function showOpenCashModal(registerName) {
    const modalHtml = `
        <div class="modal fade" id="openCashModal" tabindex="-1" aria-labelledby="openCashModalLabel" aria-hidden="true" data-bs-backdrop="static">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="openCashModalLabel">
                            <i class="bi bi-unlock me-2"></i>Abrir Caja Registradora
                        </h5>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>Importante:</strong> Debes abrir la caja registradora antes de procesar ventas.
                        </div>
                        <form id="openCashForm">
                            <div class="mb-3">
                                <label for="opening-amount" class="form-label">Monto inicial en caja (RD$)</label>
                                <input type="number" class="form-control" id="opening-amount" step="0.01" min="0" value="0" required>
                                <div class="form-text">Cuenta todo el efectivo e ingresa el total inicial</div>
                            </div>
                            <div class="mb-3">
                                <label for="opening-notes" class="form-label">Notas de apertura (opcional)</label>
                                <textarea class="form-control" id="opening-notes" rows="2" placeholder="Observaciones de turno, billetes y monedas, etc."></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-success" onclick="openCashRegister()">
                            <i class="bi bi-unlock me-1"></i>Abrir Caja
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('openCashModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('openCashModal'));
    modal.show();
}

// Open cash register
async function openCashRegister() {
    try {
        const openingAmount = parseFloat(document.getElementById('opening-amount').value) || 0;
        const openingNotes = document.getElementById('opening-notes').value.trim();
        
        const response = await apiRequest('/api/cash-register/open', {
            method: 'POST',
            body: JSON.stringify({
                opening_amount: openingAmount,
                opening_notes: openingNotes
            }),
            headers: {
                'X-CSRFToken': getCsrfToken()
            }
        });
        
        if (response.success) {
            showNotification(response.message, 'success');
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('openCashModal'));
            modal.hide();
            
            // Refresh cash register status
            await checkCashRegisterStatus();
        } else {
            showNotification(response.error || 'Error abriendo caja registradora', 'error');
        }
        
    } catch (error) {
        console.error('[Cash] Error opening cash register:', error);
        showNotification('Error abriendo caja: ' + (error.message || error), 'error');
    }
}

// Document ready event
document.addEventListener('DOMContentLoaded', initializePOS);

// SIMPLE DATA LOADING - Independent of POS initialization
document.addEventListener('DOMContentLoaded', function() {
    // Load customers immediately
    setTimeout(() => {
        fetch('/api/customers', {credentials: 'same-origin'})
            .then(response => response.json())
            .then(data => {
                customersData = data;
                const customerSelect = document.getElementById('customer-select');
                if (customerSelect) {
                    customerSelect.innerHTML = '<option value="">Seleccione un cliente o ingrese manualmente</option>';
                    data.forEach(customer => {
                        const option = document.createElement('option');
                        option.value = customer.id;
                        option.textContent = `${customer.name}${customer.rnc ? ' - ' + customer.rnc : ''}`;
                        customerSelect.appendChild(option);
                    });
                }
                console.log('[POS] ‚úÖ Customers loaded:', data.length);
            })
            .catch(error => console.log('[POS] ‚ùå Customers failed:', error.message));
    }, 1000);
    
    // Load tax types immediately
    setTimeout(() => {
        fetch('/api/tax-types', {credentials: 'same-origin'})
            .then(response => response.json())
            .then(data => {
                loadedTaxTypes = data;
                console.log('[POS] ‚úÖ Tax types loaded:', data.length);
            })
            .catch(error => console.log('[POS] ‚ùå Tax types failed:', error.message));
    }, 1200);
    
    // Load tables immediately  
    setTimeout(() => {
        fetch('/api/tables', {credentials: 'same-origin'})
            .then(response => response.json())
            .then(data => {
                const tableSelect = document.getElementById('table-select');
                if (tableSelect) {
                    tableSelect.innerHTML = '<option value="">Seleccione una mesa</option>';
                    data.forEach(table => {
                        const option = document.createElement('option');
                        option.value = table.id;
                        option.textContent = `Mesa ${table.number} (${table.capacity} personas)`;
                        tableSelect.appendChild(option);
                    });
                }
                console.log('[POS] ‚úÖ Tables loaded:', data.length);
            })
            .catch(error => console.log('[POS] ‚ùå Tables failed:', error.message));
    }, 1400);
});

// Handle category tab changes
document.addEventListener('shown.bs.tab', function(e) {
    if (e.target.getAttribute('data-bs-toggle') === 'pill') {
        const categoryId = e.target.getAttribute('data-bs-target').replace('#category-', '');
        loadProducts(categoryId);
    }
});

// Handle page visibility change (for better power management)
document.addEventListener('visibilitychange', function() {
    if (document.visibilityState === 'visible') {
        // Page became visible, check connection and refresh if needed
        if (navigator.onLine && connectionManager) {
            connectionManager.onConnectionRestored();
        }
    }
});

// Prevent data loss on page unload
window.addEventListener('beforeunload', function(e) {
    // Cart is automatically saved via localStorage, but let's ensure it
    if (cartManager && cartManager.getItems().length > 0) {
        e.preventDefault();
        e.returnValue = 'Tienes productos en el carrito. ¬øEst√°s seguro de que quieres salir?';
    }
});

function updateCashStatusUI(status) {
    const statusIndicator = document.getElementById('cash-status-indicator');
    const statusText = document.getElementById('cash-status-text');
    const closeCashBtn = document.getElementById('close-cash-btn');
    
    if (statusIndicator && statusText) {
        statusIndicator.style.display = 'flex';
        
        if (status.has_open_session) {
            statusText.textContent = `Caja: ${status.register_name} - Abierta`;
            statusIndicator.querySelector('.status-dot').className = 'status-dot cash-open';
            if (closeCashBtn) closeCashBtn.style.display = 'inline-block';
        } else {
            statusText.textContent = `Caja: ${status.register_name} - Cerrada`;
            statusIndicator.querySelector('.status-dot').className = 'status-dot cash-closed';
            if (closeCashBtn) closeCashBtn.style.display = 'none';
        }
    }
}

function showOpenCashModal(registerName) {
    const modalHtml = `
        <div class="modal fade" id="openCashModal" tabindex="-1" aria-labelledby="openCashModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="openCashModalLabel">
                            <i class="bi bi-unlock me-2"></i>Abrir Caja Registradora
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            Debes abrir la caja registradora <strong>${registerName}</strong> antes de comenzar a vender.
                        </div>
                        <form id="openCashForm">
                            <div class="mb-3">
                                <label for="opening-amount" class="form-label">Monto inicial en caja (RD$)</label>
                                <input type="number" class="form-control" id="opening-amount" step="0.01" min="0" value="0" required>
                                <div class="form-text">Ingresa la cantidad de dinero en efectivo al abrir la caja</div>
                            </div>
                            <div class="mb-3">
                                <label for="opening-notes" class="form-label">Notas (opcional)</label>
                                <textarea class="form-control" id="opening-notes" rows="2" placeholder="Observaciones adicionales..."></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-success" onclick="openCashRegister()">
                            <i class="bi bi-unlock me-1"></i>Abrir Caja
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('openCashModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('openCashModal'), {
        backdrop: 'static',
        keyboard: false
    });
    modal.show();
}

async function openCashRegister() {
    try {
        const openingAmount = parseFloat(document.getElementById('opening-amount').value) || 0;
        const openingNotes = document.getElementById('opening-notes').value.trim();
        
        const response = await apiRequest('/api/cash-register/open', {
            method: 'POST',
            body: JSON.stringify({
                opening_amount: openingAmount,
                opening_notes: openingNotes
            }),
            headers: {
                'X-CSRFToken': getCsrfToken()
            }
        });
        
        if (response.success) {
            showNotification(response.message, 'success');
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('openCashModal'));
            modal.hide();
            
            // Refresh cash register status
            await checkCashRegisterStatus();
        } else {
            showNotification(response.error || 'Error abriendo caja registradora', 'error');
        }
        
    } catch (error) {
        console.error('[Cash] Error opening cash register:', error);
        showNotification('Error abriendo caja: ' + (error.message || error), 'error');
    }
}

function showCloseCashModal() {
    const modalHtml = `
        <div class="modal fade" id="closeCashModal" tabindex="-1" aria-labelledby="closeCashModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="closeCashModalLabel">
                            <i class="bi bi-lock me-2"></i>Cerrar Caja Registradora
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            Al cerrar la caja se generar√° un resumen detallado de ventas que debes verificar antes de confirmar.
                        </div>
                        <form id="closeCashForm">
                            <div class="mb-3">
                                <label for="closing-amount" class="form-label">Monto final en caja (RD$)</label>
                                <input type="number" class="form-control" id="closing-amount" step="0.01" min="0" value="0" required>
                                <div class="form-text">Cuenta todo el efectivo y ingresa el total</div>
                            </div>
                            <div class="mb-3">
                                <label for="closing-notes" class="form-label">Notas de cierre (opcional)</label>
                                <textarea class="form-control" id="closing-notes" rows="2" placeholder="Observaciones, incidencias, etc."></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-danger" onclick="closeCashRegister()">
                            <i class="bi bi-lock me-1"></i>Cerrar Caja
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('closeCashModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('closeCashModal'));
    modal.show();
}

async function closeCashRegister() {
    try {
        const closingAmount = parseFloat(document.getElementById('closing-amount').value) || 0;
        const closingNotes = document.getElementById('closing-notes').value.trim();
        
        const response = await apiRequest('/api/cash-register/close', {
            method: 'POST',
            body: JSON.stringify({
                closing_amount: closingAmount,
                closing_notes: closingNotes
            }),
            headers: {
                'X-CSRFToken': getCsrfToken()
            }
        });
        
        if (response.success) {
            showNotification(response.message, 'success');
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('closeCashModal'));
            modal.hide();
            
            // Show detailed summary
            showCashSummaryModal(response.session_summary);
            
            // Refresh cash register status
            await checkCashRegisterStatus();
        } else {
            showNotification(response.error || 'Error cerrando caja registradora', 'error');
        }
        
    } catch (error) {
        console.error('[Cash] Error closing cash register:', error);
        showNotification('Error cerrando caja: ' + (error.message || error), 'error');
    }
}

function showCashSummaryModal(summary) {
    const formatCurrency = (amount) => `RD$ ${parseFloat(amount || 0).toLocaleString('es-DO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
    const formatDate = (dateStr) => new Date(dateStr).toLocaleString('es-DO');
    
    const differenceClass = summary.cash_difference >= 0 ? 'text-success' : 'text-danger';
    const differenceIcon = summary.cash_difference >= 0 ? 'arrow-up-circle' : 'arrow-down-circle';
    
    const summaryHtml = `
        <div class="modal fade" id="cashSummaryModal" tabindex="-1" aria-labelledby="cashSummaryModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="cashSummaryModalLabel">
                            <i class="bi bi-file-earmark-text me-2"></i>Resumen de Caja - Sesi√≥n #${summary.session_id}
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="bi bi-clock me-2"></i>Informaci√≥n de Sesi√≥n</h6>
                                    </div>
                                    <div class="card-body">
                                        <p><strong>Apertura:</strong> ${formatDate(summary.opened_at)}</p>
                                        <p><strong>Cierre:</strong> ${formatDate(summary.closed_at)}</p>
                                        <p><strong>Total Transacciones:</strong> ${summary.total_transactions}</p>
                                    </div>
                                </div>
                                
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="bi bi-cash me-2"></i>Control de Efectivo</h6>
                                    </div>
                                    <div class="card-body">
                                        <p><strong>Apertura:</strong> ${formatCurrency(summary.opening_amount)}</p>
                                        <p><strong>Ventas en Efectivo:</strong> ${formatCurrency(summary.cash_sales)}</p>
                                        <p><strong>Efectivo Esperado:</strong> ${formatCurrency(summary.expected_cash)}</p>
                                        <p><strong>Efectivo Real:</strong> ${formatCurrency(summary.closing_amount)}</p>
                                        <hr>
                                        <p class="mb-0 ${differenceClass}">
                                            <i class="bi bi-${differenceIcon} me-2"></i>
                                            <strong>Diferencia: ${formatCurrency(Math.abs(summary.cash_difference))} 
                                            ${summary.cash_difference >= 0 ? '(Sobrante)' : '(Faltante)'}</strong>
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="bi bi-bar-chart me-2"></i>Resumen de Ventas</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-sm-6">
                                                <div class="text-center p-3 bg-success bg-opacity-10 rounded">
                                                    <i class="bi bi-cash-coin text-success fs-1"></i>
                                                    <p class="mb-1 text-muted">Efectivo</p>
                                                    <h5 class="mb-0">${formatCurrency(summary.cash_sales)}</h5>
                                                </div>
                                            </div>
                                            <div class="col-sm-6">
                                                <div class="text-center p-3 bg-primary bg-opacity-10 rounded">
                                                    <i class="bi bi-credit-card text-primary fs-1"></i>
                                                    <p class="mb-1 text-muted">Tarjeta</p>
                                                    <h5 class="mb-0">${formatCurrency(summary.card_sales)}</h5>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row mt-3">
                                            <div class="col-sm-6">
                                                <div class="text-center p-3 bg-info bg-opacity-10 rounded">
                                                    <i class="bi bi-phone text-info fs-1"></i>
                                                    <p class="mb-1 text-muted">Transferencia</p>
                                                    <h5 class="mb-0">${formatCurrency(summary.transfer_sales)}</h5>
                                                </div>
                                            </div>
                                            <div class="col-sm-6">
                                                <div class="text-center p-3 bg-dark bg-opacity-10 rounded">
                                                    <i class="bi bi-calculator text-dark fs-1"></i>
                                                    <p class="mb-1 text-muted">Total</p>
                                                    <h5 class="mb-0 fw-bold">${formatCurrency(summary.total_sales)}</h5>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                ${summary.opening_notes || summary.closing_notes ? `
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="bi bi-journal-text me-2"></i>Notas</h6>
                                    </div>
                                    <div class="card-body">
                                        ${summary.opening_notes ? `<p><strong>Apertura:</strong> ${summary.opening_notes}</p>` : ''}
                                        ${summary.closing_notes ? `<p><strong>Cierre:</strong> ${summary.closing_notes}</p>` : ''}
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" onclick="printCashSummary()">
                            <i class="bi bi-printer me-1"></i>Imprimir Resumen
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Store summary data for printing
    window.lastCashSummary = summary;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('cashSummaryModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', summaryHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('cashSummaryModal'));
    modal.show();
}

function printCashSummary() {
    if (!window.lastCashSummary) return;
    
    const summary = window.lastCashSummary;
    const formatCurrency = (amount) => `RD$ ${parseFloat(amount || 0).toLocaleString('es-DO', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
    const formatDate = (dateStr) => new Date(dateStr).toLocaleString('es-DO');
    
    const printContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Resumen de Caja - Sesi√≥n #${summary.session_id}</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 10px; }
                .summary-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                .summary-table th, .summary-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                .summary-table th { background-color: #f2f2f2; }
                .difference { font-weight: bold; }
                .positive { color: green; }
                .negative { color: red; }
                @media print { body { margin: 0; } }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>RESUMEN DE CAJA REGISTRADORA</h1>
                <h2>Sesi√≥n #${summary.session_id}</h2>
                <p>Impreso: ${new Date().toLocaleString('es-DO')}</p>
            </div>
            
            <table class="summary-table">
                <tr><th colspan="2">INFORMACI√ìN DE SESI√ìN</th></tr>
                <tr><td>Fecha/Hora Apertura:</td><td>${formatDate(summary.opened_at)}</td></tr>
                <tr><td>Fecha/Hora Cierre:</td><td>${formatDate(summary.closed_at)}</td></tr>
                <tr><td>Total Transacciones:</td><td>${summary.total_transactions}</td></tr>
            </table>
            
            <table class="summary-table">
                <tr><th colspan="2">RESUMEN DE VENTAS POR M√âTODO DE PAGO</th></tr>
                <tr><td>Ventas en Efectivo:</td><td>${formatCurrency(summary.cash_sales)}</td></tr>
                <tr><td>Ventas con Tarjeta:</td><td>${formatCurrency(summary.card_sales)}</td></tr>
                <tr><td>Ventas por Transferencia:</td><td>${formatCurrency(summary.transfer_sales)}</td></tr>
                <tr><td><strong>TOTAL VENTAS:</strong></td><td><strong>${formatCurrency(summary.total_sales)}</strong></td></tr>
            </table>
            
            <table class="summary-table">
                <tr><th colspan="2">CONTROL DE EFECTIVO</th></tr>
                <tr><td>Monto Apertura:</td><td>${formatCurrency(summary.opening_amount)}</td></tr>
                <tr><td>Ventas en Efectivo:</td><td>${formatCurrency(summary.cash_sales)}</td></tr>
                <tr><td>Efectivo Esperado:</td><td>${formatCurrency(summary.expected_cash)}</td></tr>
                <tr><td>Efectivo Contado:</td><td>${formatCurrency(summary.closing_amount)}</td></tr>
                <tr><td class="difference ${summary.cash_difference >= 0 ? 'positive' : 'negative'}">
                    DIFERENCIA:
                </td><td class="difference ${summary.cash_difference >= 0 ? 'positive' : 'negative'}">
                    ${formatCurrency(Math.abs(summary.cash_difference))} ${summary.cash_difference >= 0 ? '(SOBRANTE)' : '(FALTANTE)'}
                </td></tr>
            </table>
            
            ${summary.opening_notes || summary.closing_notes ? `
            <table class="summary-table">
                <tr><th colspan="2">OBSERVACIONES</th></tr>
                ${summary.opening_notes ? `<tr><td>Notas Apertura:</td><td>${summary.opening_notes}</td></tr>` : ''}
                ${summary.closing_notes ? `<tr><td>Notas Cierre:</td><td>${summary.closing_notes}</td></tr>` : ''}
            </table>
            ` : ''}
            
            <div style="margin-top: 40px; text-align: center; font-size: 12px; color: #666;">
                Sistema POS Four One ‚Ä¢ Rep√∫blica Dominicana
            </div>
        </body>
        </html>
    `;
    
    const printWindow = window.open('', '_blank');
    
    // Set up load handler before writing content to avoid race condition
    printWindow.onload = () => {
        printWindow.focus();
        printWindow.print();
        
        // Close print window after printing
        setTimeout(() => {
            printWindow.close();
        }, 500);
    };
    
    printWindow.document.write(printContent);
    printWindow.document.close();
}

// Print receipt function - called automatically after sale finalization
async function printReceipt(saleData) {
    try {
        if (!saleData || !saleData.sale_id) {
            console.error('[Print] No sale ID provided for receipt printing');
            return false;
        }
        
        // Generate thermal receipt via API
        const response = await apiRequest(`/api/receipts/${saleData.sale_id}/thermal`);
        
        if (!response.success || !response.receipt_text) {
            console.error('[Print] Failed to generate receipt text:', response.error);
            return false;
        }
        
        // Create receipt preview modal
        const receiptModal = `
            <div class="modal fade" id="receiptModal" tabindex="-1" aria-labelledby="receiptModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="receiptModalLabel">
                                <i class="bi bi-receipt me-2"></i>Recibo Generado - Venta #${saleData.sale_id}
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-success">
                                <i class="bi bi-check-circle me-2"></i>
                                Recibo generado autom√°ticamente despu√©s de la venta
                            </div>
                            <div class="receipt-preview">
                                <pre style="font-family: 'Courier New', monospace; font-size: 12px; background: #f8f9fa; color: #000; padding: 15px; border-radius: 8px; overflow-x: auto; white-space: pre-wrap; border: 1px solid #dee2e6;">${response.receipt_text}</pre>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="printReceiptToDevice('${saleData.sale_id}')">
                                <i class="bi bi-printer me-1"></i>Imprimir en Impresora
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="copyReceiptText()">
                                <i class="bi bi-clipboard me-1"></i>Copiar Texto
                            </button>
                            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Remove existing modal if any
        const existingModal = document.getElementById('receiptModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // Add modal to page
        document.body.insertAdjacentHTML('beforeend', receiptModal);
        
        // Store receipt text for copying
        window.currentReceiptText = response.receipt_text;
        
        // Show modal and keep it open for user interaction
        const modal = new bootstrap.Modal(document.getElementById('receiptModal'));
        modal.show();
        
        // Automatically download PDF receipt
        downloadReceiptPDF(saleData.sale_id);
        
        // Auto-hide after 10 seconds to give user time to read and interact
        setTimeout(() => {
            modal.hide();
        }, 10000);
        
        console.log('[Print] Receipt generated and displayed successfully');
        return true;
        
    } catch (error) {
        console.error('[Print] Error generating receipt:', error);
        showNotification('Error generando recibo (venta procesada exitosamente)', 'warning');
        return false;
    }
}

// Print receipt to thermal printer or regular printer
function printReceiptToDevice(saleId) {
    if (!window.currentReceiptText) {
        showNotification('No hay texto de recibo disponible', 'error');
        return;
    }
    
    const printContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Recibo - Venta #${saleId}</title>
            <style>
                body { 
                    font-family: 'Courier New', monospace; 
                    font-size: 12px; 
                    margin: 5px; 
                    line-height: 1.2;
                }
                pre { 
                    margin: 0; 
                    white-space: pre-wrap; 
                    word-wrap: break-word;
                }
                @media print { 
                    body { margin: 0; } 
                    @page { 
                        size: 80mm auto;
                        margin: 2mm;
                    }
                }
            </style>
        </head>
        <body>
            <pre>${window.currentReceiptText}</pre>
        </body>
        </html>
    `;
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(printContent);
    printWindow.document.close();
    
    // Wait for content to load then print
    printWindow.onload = () => {
        printWindow.focus();
        printWindow.print();
        
        // Close print window after printing
        setTimeout(() => {
            printWindow.close();
        }, 500);
    };
    
    showNotification('Enviando recibo a impresora...', 'info');
}

// Download receipt PDF automatically
function downloadReceiptPDF(saleId) {
    try {
        // Create a temporary link to trigger PDF download
        const downloadLink = document.createElement('a');
        downloadLink.href = `/api/receipts/${saleId}/pdf`;
        downloadLink.download = `recibo_fiscal_${saleId}_${new Date().toISOString().slice(0,10)}.pdf`;
        downloadLink.style.display = 'none';
        
        // Add to DOM temporarily and click to trigger download
        document.body.appendChild(downloadLink);
        downloadLink.click();
        
        // Clean up
        setTimeout(() => {
            document.body.removeChild(downloadLink);
        }, 100);
        
        showNotification('Descargando recibo en PDF...', 'info');
        console.log(`[Print] PDF download initiated for sale ${saleId}`);
        
    } catch (error) {
        console.error('[Print] Error downloading PDF:', error);
        showNotification('Error descargando PDF (recibo thermal disponible)', 'warning');
    }
}

// Copy receipt text to clipboard
function copyReceiptText() {
    if (!window.currentReceiptText) {
        showNotification('No hay texto de recibo para copiar', 'error');
        return;
    }
    
    navigator.clipboard.writeText(window.currentReceiptText).then(() => {
        showNotification('Texto del recibo copiado al portapapeles', 'success');
    }).catch(err => {
        console.error('[Print] Error copying receipt text:', err);
        showNotification('Error copiando texto del recibo', 'error');
    });
}

// Customer management functions
let customersData = [];

// Load customers for dropdown
async function loadCustomers() {
    try {
        console.log('[POS] Loading customers from API...');
        const response = await apiRequest('/api/customers');
        customersData = response;
        console.log('[POS] Customers loaded successfully:', customersData.length);
        
        const customerSelect = document.getElementById('customer-select');
        if (customerSelect) {
            // Clear existing options except the first one
            customerSelect.innerHTML = '<option value="">Seleccione un cliente o ingrese manualmente</option>';
            
            // Add customer options
            customersData.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = `${customer.name}${customer.rnc ? ' - ' + customer.rnc : ''}`;
                customerSelect.appendChild(option);
            });
        }
        
        console.log('[POS] Loaded customers for dropdown:', customersData.length);
        
    } catch (error) {
        console.error('[POS] Error loading customers:', error);
        showNotification('Error cargando clientes', 'warning');
    }
}

// Fill customer information when selected from dropdown
function fillCustomerInfo() {
    const customerSelect = document.getElementById('customer-select');
    const clientNameInput = document.getElementById('client-name');
    const clientRncInput = document.getElementById('client-rnc');
    
    if (!customerSelect || !clientNameInput || !clientRncInput) {
        console.warn('[POS] Customer form elements not found');
        return;
    }
    
    const selectedCustomerId = customerSelect.value;
    
    if (selectedCustomerId && customersData.length > 0) {
        // Find selected customer data
        const selectedCustomer = customersData.find(c => c.id === parseInt(selectedCustomerId));
        
        if (selectedCustomer) {
            // Fill form fields
            clientNameInput.value = selectedCustomer.name || '';
            clientRncInput.value = selectedCustomer.rnc || '';
            
            console.log('[POS] Customer info populated:', selectedCustomer.name);
            showNotification(`Cliente seleccionado: ${selectedCustomer.name}`, 'success');
        }
    } else {
        // Clear fields if no customer selected
        clientNameInput.value = '';
        clientRncInput.value = '';
    }
}

// Handle automatic cash opening modal when flag is set
{% if show_cash_opening_modal %}
document.addEventListener('DOMContentLoaded', function() {
    try {
        // Show cash opening modal after page load
        setTimeout(() => {
            {% if cash_register %}
            showOpenCashModal('{{ cash_register.name }}');
            {% endif %}
        }, 500); // Small delay to ensure page is fully loaded
    } catch (error) {
        console.error('[POS] Error showing cash opening modal:', error);
    }
});
{% endif %}
</script>
{% endblock %}