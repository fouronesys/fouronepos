{% extends "base.html" %}

{% block title %}Punto de Venta - Four One POS{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pos-style.css') }}?v=20250912065500">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="pos-header fade-in-up">
        <h2 class="mb-0"><i class="bi bi-cash-register me-3"></i> Punto de Venta</h2>
        <p class="mb-0 mt-2 opacity-75">Sistema POS con Cumplimiento Fiscal Dominicano</p>
    </div>
    
    <div class="row">
        <!-- Products Section -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-grid"></i> Productos</h5>
                </div>
                <div class="card-body">
                    <!-- Category Tabs -->
                    <ul class="nav nav-pills mb-3" id="category-tabs">
                        {% for category in categories %}
                        <li class="nav-item">
                            <button class="nav-link {% if loop.first %}active{% endif %}" 
                                    data-bs-toggle="pill" 
                                    data-bs-target="#category-{{ category.id }}">
                                {{ category.name }}
                            </button>
                        </li>
                        {% endfor %}
                    </ul>
                    
                    <!-- Product Grid -->
                    <div class="tab-content">
                        {% for category in categories %}
                        <div class="tab-pane fade {% if loop.first %}show active{% endif %}" 
                             id="category-{{ category.id }}">
                            <div class="row" id="products-{{ category.id }}">
                                <!-- Products will be loaded via JavaScript -->
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Cart Section -->
        <div class="col-md-4">
            <div class="cart-section fade-in-up">
                <h5 class="mb-4"><i class="bi bi-cart me-2"></i> Carrito de Compras</h5>
                    <!-- Table Selection -->
                    <div class="mb-3">
                        <label for="table-select" class="form-label">
                            <i class="bi bi-table"></i> Mesa (Opcional)
                        </label>
                        <select class="form-control" id="table-select">
                            <option value="">Sin mesa asignada</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="ncf-type-select" class="form-label">
                            <i class="bi bi-receipt"></i> Tipo de Comprobante
                        </label>
                        <select class="form-control" id="ncf-type-select" onchange="toggleClientInfo()">
                            <option value="consumo">Consumo</option>
                            <option value="credito_fiscal">Crédito Fiscal</option>
                            <option value="gubernamental">Gubernamental</option>
                        </select>
                    </div>
                    
                    <!-- Client Information for Fiscal/Government Invoices -->
                    <div id="client-info-section" style="display: none;">
                        <div class="mb-3">
                            <label for="client-name" class="form-label">
                                <i class="bi bi-person"></i> Nombre/Empresa
                            </label>
                            <input type="text" class="form-control" id="client-name" placeholder="Nombre o razón social">
                        </div>
                        <div class="mb-3">
                            <label for="client-rnc" class="form-label">
                                <i class="bi bi-card-text"></i> RNC/Cédula
                            </label>
                            <input type="text" class="form-control" id="client-rnc" placeholder="RNC o número de cédula">
                        </div>
                    </div>
                    
                    <div id="cart-items">
                        <p class="text-muted">No hay productos en el carrito</p>
                    </div>
                    
                    <div class="totals-section">
                        <div class="d-flex justify-content-between mb-2">
                            <span><strong>Subtotal:</strong></span>
                            <span id="subtotal" class="fw-bold">RD$ 0.00</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span><strong>ITBIS (18%):</strong></span>
                            <span id="tax" class="fw-bold">RD$ 0.00</span>
                        </div>
                        <div class="d-flex justify-content-between fw-bold">
                            <span>Total:</span>
                            <span id="total">RD$ 0.00</span>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button class="btn btn-success-custom pulse-animation" id="process-sale" onclick="processSale()">
                            <i class="bi bi-check-circle me-2"></i> Procesar Venta
                        </button>
                        <button class="btn btn-warning" id="assign-table" onclick="assignToTable()" style="background: linear-gradient(135deg, #ffa500 0%, #ff8c00 100%); color: #000; font-weight: 600;">
                            <i class="bi bi-table me-2"></i> Asignar a Mesa
                        </button>
                        <button class="btn btn-danger-custom" id="clear-cart" onclick="clearCart()">
                            <i class="bi bi-trash me-2"></i> Limpiar Carrito
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Basic POS functionality
let cart = [];

// Load products for category
function loadProducts(categoryId) {
    fetch(`/api/products?category_id=${categoryId}`, {
        credentials: 'same-origin'
    })
        .then(response => response.json())
        .then(products => {
            const container = document.getElementById(`products-${categoryId}`);
            container.innerHTML = '';
            
            products.forEach(product => {
                const productCard = `
                    <div class="col-md-4 col-lg-3 mb-3">
                        <div class="product-card fade-in-up" onclick="addToCart(${product.id}, '${product.name}', ${product.price})">
                            <div class="card-body">
                                <div class="product-name">${product.name}</div>
                                <div class="product-price">RD$ ${product.price.toFixed(2)}</div>
                                <small class="opacity-75">Stock: ${product.stock}</small>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += productCard;
            });
        });
}

// Add product to cart
function addToCart(productId, productName, price) {
    const existingItem = cart.find(item => item.id === productId);
    
    if (existingItem) {
        existingItem.quantity += 1;
    } else {
        cart.push({
            id: productId,
            name: productName,
            price: price,
            quantity: 1
        });
    }
    
    updateCartDisplay();
}

// Update cart display
function updateCartDisplay() {
    const cartItems = document.getElementById('cart-items');
    
    if (cart.length === 0) {
        cartItems.innerHTML = '<p class="text-muted">No hay productos en el carrito</p>';
        document.getElementById('subtotal').textContent = 'RD$ 0.00';
        document.getElementById('tax').textContent = 'RD$ 0.00';
        document.getElementById('total').textContent = 'RD$ 0.00';
        return;
    }
    
    let html = '';
    let subtotal = 0;
    
    cart.forEach(item => {
        const itemTotal = item.price * item.quantity;
        subtotal += itemTotal;
        
        html += `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <div>
                    <div class="fw-bold">${item.name}</div>
                    <small class="text-muted">${item.quantity} x RD$ ${item.price.toFixed(2)}</small>
                </div>
                <div>
                    <span class="me-2">RD$ ${itemTotal.toFixed(2)}</span>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeFromCart(${item.id})">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
        `;
    });
    
    cartItems.innerHTML = html;
    
    const tax = subtotal * 0.18;
    const total = subtotal + tax;
    
    document.getElementById('subtotal').textContent = `RD$ ${subtotal.toFixed(2)}`;
    document.getElementById('tax').textContent = `RD$ ${tax.toFixed(2)}`;
    document.getElementById('total').textContent = `RD$ ${total.toFixed(2)}`;
}

// Remove item from cart
function removeFromCart(productId) {
    cart = cart.filter(item => item.id !== productId);
    updateCartDisplay();
}

// Process sale
function processSale() {
    if (cart.length === 0) {
        alert('El carrito está vacío');
        return;
    }
    
    const ncfType = document.getElementById('ncf-type-select').value;
    
    // Validate client info for fiscal/government invoices
    if (ncfType === 'credito_fiscal' || ncfType === 'gubernamental') {
        const clientName = document.getElementById('client-name').value.trim();
        const clientRnc = document.getElementById('client-rnc').value.trim();
        
        if (!clientName || !clientRnc) {
            alert('Para comprobantes fiscales y gubernamentales debe completar el nombre/empresa y RNC/cédula');
            return;
        }
    }
    
    const tableId = document.getElementById('table-select').value || null;
    
    // Create sale first
    fetch('/api/sales', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        credentials: 'same-origin',
        body: JSON.stringify({
            table_id: tableId
        })
    })
    .then(response => response.json())
    .then(sale => {
        if (sale.error) {
            alert('Error al crear venta: ' + sale.error);
            return;
        }
        
        // Add items to sale
        const promises = cart.map(item => 
            fetch(`/api/sales/${sale.id}/items`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin',
                body: JSON.stringify({
                    product_id: item.id,
                    quantity: item.quantity
                })
            })
        );
        
        Promise.all(promises)
        .then(() => {
            // Finalize sale
            const finalizationData = {
                payment_method: 'efectivo',
                ncf_type: ncfType
            };
            
            // Add client info for fiscal/government invoices
            if (ncfType === 'credito_fiscal' || ncfType === 'gubernamental') {
                finalizationData.client_name = document.getElementById('client-name').value.trim();
                finalizationData.client_rnc = document.getElementById('client-rnc').value.trim();
            }
            
            return fetch(`/api/sales/${sale.id}/finalize`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin',
                body: JSON.stringify(finalizationData)
            });
        })
        .then(response => response.json())
        .then(result => {
            if (result.error) {
                alert('Error al finalizar venta: ' + result.error);
                return;
            }
            alert(`Venta procesada exitosamente. NCF: ${result.ncf}`);
            clearCart();
            loadTables(); // Refresh table list
        })
        .catch(error => {
            console.error('Error processing sale:', error);
            alert('Error al procesar la venta');
        });
    })
    .catch(error => {
        console.error('Error creating sale:', error);
        alert('Error al crear la venta');
    });
}

// Assign order to table without processing
function assignToTable() {
    if (cart.length === 0) {
        alert('El carrito está vacío');
        return;
    }
    
    const tableId = document.getElementById('table-select').value;
    if (!tableId) {
        alert('Debe seleccionar una mesa');
        return;
    }
    
    // Create sale first
    fetch('/api/sales', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        credentials: 'same-origin',
        body: JSON.stringify({
            table_id: tableId
        })
    })
    .then(response => response.json())
    .then(sale => {
        if (sale.error) {
            alert('Error al crear orden: ' + sale.error);
            return;
        }
        
        // Add items to sale
        const promises = cart.map(item => 
            fetch(`/api/sales/${sale.id}/items`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin',
                body: JSON.stringify({
                    product_id: item.id,
                    quantity: item.quantity
                })
            })
        );
        
        Promise.all(promises)
        .then(() => {
            // Update table status to occupied
            return fetch(`/api/tables/${tableId}/status`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin',
                body: JSON.stringify({
                    status: 'occupied'
                })
            });
        })
        .then(() => {
            alert(`Orden asignada exitosamente a Mesa ${tableId}. Estado: Pendiente`);
            clearCart();
            loadTables(); // Refresh table list
        })
        .catch(error => {
            console.error('Error assigning to table:', error);
            alert('Error al asignar orden a la mesa');
        });
    })
    .catch(error => {
        console.error('Error creating order:', error);
        alert('Error al crear la orden');
    });
}

// Clear cart
function clearCart() {
    cart = [];
    updateCartDisplay();
    document.getElementById('table-select').value = '';
}

// Toggle client information fields based on NCF type
function toggleClientInfo() {
    const ncfType = document.getElementById('ncf-type-select').value;
    const clientInfoSection = document.getElementById('client-info-section');
    
    if (ncfType === 'credito_fiscal' || ncfType === 'gubernamental') {
        clientInfoSection.style.display = 'block';
        // Make fields required
        document.getElementById('client-name').required = true;
        document.getElementById('client-rnc').required = true;
    } else {
        clientInfoSection.style.display = 'none';
        // Remove required attribute
        document.getElementById('client-name').required = false;
        document.getElementById('client-rnc').required = false;
        // Clear values
        document.getElementById('client-name').value = '';
        document.getElementById('client-rnc').value = '';
    }
}

// Load available tables
function loadTables() {
    fetch('/api/tables?status=available', {
        credentials: 'same-origin'
    })
        .then(response => response.json())
        .then(tables => {
            const tableSelect = document.getElementById('table-select');
            tableSelect.innerHTML = '<option value="">Sin mesa asignada</option>';
            
            tables.forEach(table => {
                const option = document.createElement('option');
                option.value = table.id;
                option.textContent = `Mesa ${table.number}${table.name ? ' - ' + table.name : ''}`;
                tableSelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error loading tables:', error);
        });
}

// Load initial products and tables
document.addEventListener('DOMContentLoaded', function() {
    // Load products for the first category (default)
    const firstCategory = document.querySelector('[data-bs-toggle="pill"]');
    if (firstCategory) {
        const categoryId = firstCategory.getAttribute('data-bs-target').replace('#category-', '');
        loadProducts(categoryId);
    } else {
        // Fallback: load products for category 1 if no tabs found
        loadProducts(1);
    }
    
    // Load available tables
    loadTables();
});

// Handle category tab changes
document.addEventListener('shown.bs.tab', function(e) {
    if (e.target.getAttribute('data-bs-toggle') === 'pill') {
        const categoryId = e.target.getAttribute('data-bs-target').replace('#category-', '');
        loadProducts(categoryId);
    }
});
</script>
{% endblock %}