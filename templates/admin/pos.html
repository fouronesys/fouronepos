{% extends "base.html" %}

{% block title %}Punto de Venta - Four One POS{% endblock %}

{% block head %}
<meta name="csrf-token" content="{{ csrf_token() }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/pos-style.css') }}?v=20250912065500">
<!-- Organized JavaScript Files - Load with defer for proper DOM loading -->
<script defer src="{{ url_for('static', filename='js/pos-utils.js') }}?v={{ timestamp }}"></script>
<script defer src="{{ url_for('static', filename='js/payment-system.js') }}?v={{ timestamp }}"></script>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Modern POS Header -->
    <div class="row align-items-center mb-4">
        <div class="col">
            <div class="d-flex align-items-center gap-3">
                <div class="pos-icon">
                    <i class="bi bi-cash-register"></i>
                </div>
                <div>
                    <h1 class="display-6 fw-bold mb-1">Punto de Venta</h1>
                    <p class="text-muted mb-0">Sistema POS con Cumplimiento Fiscal • República Dominicana</p>
                </div>
            </div>
        </div>
        <div class="col-auto">
            <div class="d-flex align-items-center gap-3">
                <!-- Enhanced Status Indicators -->
                <div id="connection-status" class="status-indicator online">
                    <div class="status-dot"></div>
                    <span><i class="bi bi-wifi me-1"></i>En línea</span>
                </div>
                <div id="sync-status" class="status-indicator sync" style="display: none;">
                    <div class="status-dot sync-dot"></div>
                    <span><i class="bi bi-cloud-upload me-1"></i><span id="sync-count">0</span> pendiente(s)</span>
                </div>
                <!-- Quick Stats -->
                <div class="quick-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="daily-sales">RD$ 0</div>
                        <div class="stat-label">Ventas del día</div>
                    </div>
                </div>
                <!-- Back to Waiter Tables Button (only for waiters) -->
                {% if session.role == 'MESERO' %}
                <a href="{{ url_for('waiter.tables') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-2"></i>Volver a Mesas
                </a>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="row g-4">
        <!-- Products/Orders Section -->
        <div class="col-lg-8">
            <!-- Tab Navigation -->
            <div class="pos-tabs mb-4">
                <div class="tab-buttons">
                    <button class="tab-button active" id="products-tab" onclick="showProductsSection()">
                        <i class="bi bi-grid-3x3-gap"></i>
                        <span>Productos</span>
                    </button>
                    <button class="tab-button" id="orders-tab" onclick="showOrdersSection()">
                        <i class="bi bi-clock-history"></i>
                        <span>Órdenes Abiertas</span>
                        <span class="order-count" id="pending-orders-count">0</span>
                    </button>
                </div>
            </div>
            
            <!-- Products Section -->
            <div id="products-section" class="products-section">
                <!-- Enhanced Category Navigation -->
                <div class="category-nav mb-4">
                    <div class="category-pills">
                        {% for category in categories %}
                        <button class="category-pill {% if loop.first %}active{% endif %}" 
                                data-category-id="{{ category.id }}"
                                onclick="switchCategory({{ category.id }})">
                            <i class="bi bi-{% if category.name == 'Bebidas' %}cup-straw{% elif category.name == 'Comidas' %}egg-fried{% elif category.name == 'Postres' %}cake2{% else %}box{% endif %}"></i>
                            <span>{{ category.name }}</span>
                        </button>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Enhanced Product Grid -->
                <div class="products-grid">
                    {% for category in categories %}
                    <div class="category-products {% if not loop.first %}d-none{% endif %}" 
                         id="category-products-{{ category.id }}">
                        <div class="products-container" id="products-{{ category.id }}">
                            <!-- Products will be loaded via JavaScript -->
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Open Orders Section -->
            <div id="orders-section" class="orders-section d-none">
                <div class="orders-header mb-3">
                    <h5 class="mb-0">
                        <i class="bi bi-clock-history me-2"></i>
                        Órdenes Pendientes de Facturación
                    </h5>
                    <small class="text-muted">Órdenes creadas por meseros que necesitan ser facturadas</small>
                </div>
                
                <div id="pending-orders-container" class="orders-grid">
                    <!-- Orders will be loaded via JavaScript -->
                    <div class="empty-orders text-center py-5">
                        <i class="bi bi-inbox" style="font-size: 3rem; color: #ddd;"></i>
                        <h6 class="text-muted mt-3">No hay órdenes pendientes</h6>
                        <p class="text-muted mb-0">Las órdenes de los meseros aparecerán aquí</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Modern Cart Section -->
        <div class="col-lg-4">
            <div class="modern-cart">
                <!-- Cart Header -->
                <div class="cart-header">
                    <div class="cart-title">
                        <i class="bi bi-cart3"></i>
                        <span>Carrito</span>
                    </div>
                    <div class="cart-counter" id="cart-counter">0</div>
                </div>
                
                <!-- Cart Configuration -->
                <div class="cart-config">
                    <!-- Table Selection -->
                    <div class="config-item">
                        <label for="table-select" class="config-label">
                            <i class="bi bi-table"></i>
                            <span>Mesa</span>
                        </label>
                        <select class="modern-select" id="table-select">
                            <option value="">Sin asignar</option>
                        </select>
                    </div>
                    
                    <!-- Order Description -->
                    <div class="config-item">
                        <label for="order-description" class="config-label">
                            <i class="bi bi-sticky"></i>
                            <span>Descripción</span>
                        </label>
                        <input type="text" class="modern-input" id="order-description" placeholder="Nota interna de la orden (opcional)" maxlength="200">
                        <small class="text-muted" style="font-size: 0.75rem;">Solo para referencia interna - no se imprime en el recibo</small>
                    </div>
                    
                    <!-- NCF Type -->
                    <div class="config-item">
                        <label for="ncf-type-select" class="config-label">
                            <i class="bi bi-receipt"></i>
                            <span>Comprobante</span>
                        </label>
                        <select class="modern-select" id="ncf-type-select" onchange="toggleClientInfo()">
                            <option value="sin_comprobante" selected>Sin comprobante</option>
                            <option value="consumo">Consumo</option>
                            <option value="credito_fiscal">Crédito Fiscal</option>
                            <option value="gubernamental">Gubernamental</option>
                        </select>
                    </div>
                    
                    <!-- Client Information -->
                    <div id="client-info-section" class="client-info-section" style="display: none;">
                        <div class="config-item">
                            <label for="client-name" class="config-label">
                                <i class="bi bi-person"></i>
                                <span>Cliente</span>
                            </label>
                            <input type="text" class="modern-input" id="client-name" placeholder="Nombre o razón social">
                        </div>
                        <div class="config-item">
                            <label for="client-rnc" class="config-label">
                                <i class="bi bi-card-text"></i>
                                <span>RNC/Cédula</span>
                            </label>
                            <input type="text" class="modern-input" id="client-rnc" placeholder="RNC o número de cédula">
                        </div>
                    </div>
                </div>
                
                <!-- Payment Method Configuration Section -->
                <div class="cart-config">
                    <div class="config-item">
                        <label for="payment-method-select" class="config-label">
                            <i class="bi bi-credit-card"></i>
                            <span>Método de Pago</span>
                        </label>
                        <select class="modern-select" id="payment-method-select" onchange="toggleCashFields()">
                            <option value="cash">Efectivo</option>
                            <option value="card">Tarjeta</option>
                            <option value="transfer">Transferencia</option>
                        </select>
                    </div>
                    
                    <!-- Cash Payment Fields -->
                    <div id="cash-payment-section" class="cash-payment-section">
                        <div class="config-item">
                            <label for="cash-received" class="config-label">
                                <i class="bi bi-cash-stack"></i>
                                <span>Efectivo Recibido</span>
                            </label>
                            <input type="number" step="0.01" min="0" class="modern-input" id="cash-received" placeholder="0.00" onchange="calculateChange()">
                        </div>
                        <div class="config-item">
                            <label class="config-label">
                                <i class="bi bi-arrow-down-circle"></i>
                                <span>Cambio a Entregar</span>
                            </label>
                            <div class="change-display" id="change-display">RD$ 0.00</div>
                        </div>
                    </div>
                </div>
                
                <!-- Tax Configuration Section -->
                <div class="cart-config">
                    <div class="config-item">
                        <label for="tax-type-select" class="config-label">
                            <i class="bi bi-percent"></i>
                            <span>Tipo de Impuesto</span>
                        </label>
                        <select class="modern-input" id="tax-type-select" onchange="updateTaxCalculation()">
                            <option value="0.18">ITBIS (18%)</option>
                            <option value="0.00">Sin impuestos</option>
                        </select>
                    </div>
                </div>
                
                <!-- Cart Items -->
                <div class="cart-items-container">
                    <div id="cart-items" class="cart-items">
                        <div class="empty-cart">
                            <i class="bi bi-cart-x"></i>
                            <p>Carrito vacío</p>
                            <small>Agrega productos para empezar</small>
                        </div>
                    </div>
                </div>
                
                <!-- Cart Totals -->
                <div class="cart-totals">
                    <div class="total-row subtotal-row">
                        <span>Subtotal</span>
                        <span id="subtotal">RD$ 0.00</span>
                    </div>
                    <div class="total-row tax-row" id="tax-row">
                        <span id="tax-label">ITBIS (18%)</span>
                        <span id="tax">RD$ 0.00</span>
                    </div>
                    <div class="total-row final-row">
                        <span>Total</span>
                        <span id="total">RD$ 0.00</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="cart-actions">
                    <div class="d-grid gap-2">
                        <button class="btn btn-success btn-lg" id="process-sale" onclick="processSale()" 
                                {% if session.role == 'MESERO' %}disabled title="Los meseros no pueden procesar ventas directamente"{% endif %}>
                            <i class="bi bi-check-circle me-2"></i> Procesar Venta
                        </button>
                        <button class="btn btn-warning" id="assign-table" onclick="assignToTable()" style="background: linear-gradient(135deg, #ffa500 0%, #ff8c00 100%); color: #000; font-weight: 600;">
                            <i class="bi bi-table me-2"></i> Asignar a Mesa
                        </button>
                        <button class="btn btn-danger-custom" id="clear-cart" onclick="clearCart()">
                            <i class="bi bi-trash me-2"></i> Limpiar Carrito
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Enhanced POS functionality with offline support and cart persistence

// Get CSRF token from meta tag
const csrfToken = document.querySelector('meta[name="csrf-token"]').content;

// Cart Management with localStorage
class CartManager {
    constructor() {
        this.storageKey = 'fourone_pos_cart';
        this.cart = this.loadCartFromStorage();
        this.setupCrossTabSync();
        this.setupServiceWorkerCommunication();
    }

    // Load cart from localStorage
    loadCartFromStorage() {
        try {
            const storedCart = localStorage.getItem(this.storageKey);
            const cart = storedCart ? JSON.parse(storedCart) : [];
            console.log('[Cart] Loaded cart from storage:', cart);
            return cart;
        } catch (error) {
            console.error('[Cart] Error loading cart from storage:', error);
            return [];
        }
    }

    // Save cart to localStorage
    saveCartToStorage() {
        try {
            localStorage.setItem(this.storageKey, JSON.stringify(this.cart));
            console.log('[Cart] Cart saved to storage:', this.cart);
            
            // Broadcast cart change for cross-tab sync
            this.broadcastCartChange();
        } catch (error) {
            console.error('[Cart] Error saving cart to storage:', error);
        }
    }

    // Setup cross-tab synchronization
    setupCrossTabSync() {
        // Listen for storage events from other tabs
        window.addEventListener('storage', (e) => {
            if (e.key === this.storageKey && e.newValue !== null) {
                console.log('[Cart] Cart updated in another tab, syncing...');
                this.cart = JSON.parse(e.newValue);
                updateCartDisplay();
                showNotification('Carrito sincronizado desde otra pestaña', 'info');
            }
        });

        // Listen for custom cart change events within the same tab
        window.addEventListener('cartChanged', () => {
            updateCartDisplay();
        });
    }

    // Broadcast cart changes using Broadcast Channel API
    broadcastCartChange() {
        if ('BroadcastChannel' in window) {
            const channel = new BroadcastChannel('cart_sync');
            channel.postMessage({
                type: 'CART_UPDATED',
                cart: this.cart,
                timestamp: Date.now()
            });
        }

        // Dispatch custom event for same-tab components
        window.dispatchEvent(new CustomEvent('cartChanged'));
    }

    // Add item to cart
    addItem(productId, productName, price) {
        const existingItem = this.cart.find(item => item.id === productId);
        
        if (existingItem) {
            existingItem.quantity += 1;
        } else {
            this.cart.push({
                id: productId,
                name: productName,
                price: price,
                quantity: 1,
                addedAt: Date.now()
            });
        }
        
        this.saveCartToStorage();
        showNotification(`${productName} agregado al carrito`, 'success');
    }

    // Add item directly with specific quantity (for loading existing sales)
    addItemDirectly(productId, productName, price, quantity) {
        const existingItem = this.cart.find(item => item.id === productId);
        
        if (existingItem) {
            existingItem.quantity = quantity;
        } else {
            this.cart.push({
                id: productId,
                name: productName,
                price: price,
                quantity: quantity,
                addedAt: Date.now()
            });
        }
        
        this.saveCartToStorage();
    }

    // Remove item from cart
    removeItem(productId) {
        const item = this.cart.find(item => item.id === productId);
        this.cart = this.cart.filter(item => item.id !== productId);
        this.saveCartToStorage();
        
        if (item) {
            showNotification(`${item.name} removido del carrito`, 'warning');
        }
    }

    // Update item quantity
    updateQuantity(productId, quantity) {
        const item = this.cart.find(item => item.id === productId);
        if (item) {
            if (quantity > 0) {
                item.quantity = quantity;
                this.saveCartToStorage();
            } else {
                this.removeItem(productId);
            }
        }
    }

    // Clear cart
    clear() {
        this.cart = [];
        this.saveCartToStorage();
        showNotification('Carrito limpiado', 'info');
    }

    // Get cart items
    getItems() {
        return this.cart;
    }

    // Get cart totals
    getTotals() {
        const subtotal = this.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const taxRate = getCurrentTaxRate();
        const tax = subtotal * taxRate;
        const total = subtotal + tax;
        return { subtotal, tax, total, taxRate };
    }

    // Setup service worker communication
    setupServiceWorkerCommunication() {
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.addEventListener('message', (event) => {
                if (event.data.type === 'offline-request-queued') {
                    showNotification('Operación guardada - se procesará cuando vuelva la conexión', 'warning');
                } else if (event.data.type === 'offline-request-synced') {
                    showNotification('Operación sincronizada exitosamente', 'success');
                }
            });
        }
    }
}

// Connection Status Manager
class ConnectionManager {
    constructor() {
        this.isOnline = navigator.onLine;
        this.setupConnectionListeners();
        this.updateConnectionStatus();
    }

    setupConnectionListeners() {
        window.addEventListener('online', () => {
            this.isOnline = true;
            this.updateConnectionStatus();
            this.onConnectionRestored();
        });

        window.addEventListener('offline', () => {
            this.isOnline = false;
            this.updateConnectionStatus();
            this.onConnectionLost();
        });
    }

    updateConnectionStatus() {
        const statusIndicator = document.getElementById('connection-status');
        if (statusIndicator) {
            if (this.isOnline) {
                statusIndicator.className = 'connection-status online';
                statusIndicator.innerHTML = '<i class="bi bi-wifi"></i> En línea';
            } else {
                statusIndicator.className = 'connection-status offline';
                statusIndicator.innerHTML = '<i class="bi bi-wifi-off"></i> Offline';
            }
        }
    }

    onConnectionRestored() {
        showNotification('Conexión restaurada - sincronizando datos...', 'success');
        
        // Force sync with service worker
        if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
            navigator.serviceWorker.controller.postMessage({ type: 'FORCE_SYNC' });
        }
        
        // Refresh data
        loadTables();
        refreshProductData();
    }

    onConnectionLost() {
        showNotification('Conexión perdida - trabajando offline', 'warning');
    }
}

// Device Detection Class
class DeviceDetector {
    constructor() {
        this.deviceInfo = this.detectDevice();
    }
    
    detectDevice() {
        const userAgent = navigator.userAgent.toLowerCase();
        const touchSupport = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
        const screenWidth = window.screen.width;
        const screenHeight = window.screen.height;
        const pixelRatio = window.devicePixelRatio || 1;
        
        // Check for mobile/tablet indicators
        const isMobile = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(userAgent);
        const isTablet = /(ipad|android(?!.*mobile)|tablet)/i.test(userAgent) || 
                        (touchSupport && Math.min(screenWidth, screenHeight) >= 768);
        
        // Additional checks for touch-capable devices
        const isTouchDevice = touchSupport && (isMobile || isTablet || 
            (screenWidth <= 1024 && screenHeight <= 1366)); // Common tablet resolutions
        
        // Determine receipt format based on device type
        const receiptFormat = (isMobile || (isTablet && Math.min(screenWidth, screenHeight) < 800)) ? '58mm' : '80mm';
        
        return {
            isMobile: isMobile,
            isTablet: isTablet,
            isTouchDevice: isTouchDevice,
            isDesktop: !isMobile && !isTablet && !isTouchDevice,
            receiptFormat: receiptFormat,
            screenWidth: screenWidth,
            screenHeight: screenHeight,
            pixelRatio: pixelRatio,
            userAgent: userAgent,
            touchSupport: touchSupport
        };
    }
    
    getReceiptFormat() {
        return this.deviceInfo.receiptFormat;
    }
    
    getDeviceInfo() {
        return this.deviceInfo;
    }
    
    logDeviceInfo() {
        console.log('[Device] Detected device info:', this.deviceInfo);
    }
}

// Enhanced Automatic Receipt Printing Function with better error handling
async function printReceipt(saleData) {
    try {
        // Handle both sale_id and id for robustness
        const saleId = saleData.sale_id || saleData.id;
        if (!saleId) {
            throw new Error('Sale ID is required for receipt printing');
        }
        
        const receiptFormat = deviceDetector.getReceiptFormat();
        const deviceInfo = deviceDetector.getDeviceInfo();
        console.log(`[Receipt] Printing receipt in ${receiptFormat} format for ${deviceInfo.isMobile ? 'mobile' : deviceInfo.isTablet ? 'tablet' : 'desktop'} device`);
        
        // Use existing receipt view endpoint with format parameter and auto_print
        const viewUrl = `/api/receipts/${saleId}/view?format=${receiptFormat}&auto_print=true`;
        
        try {
            // First verify the receipt can be generated by checking if it exists and is accessible
            const testResponse = await fetch(`/api/receipts/${saleId}/view?format=${receiptFormat}`, {
                method: 'HEAD',
                credentials: 'same-origin'
            });
            
            if (!testResponse.ok) {
                if (testResponse.status === 401) {
                    throw new Error('Sesión expirada. Por favor, inicia sesión nuevamente.');
                } else if (testResponse.status === 404) {
                    throw new Error('Venta no encontrada o sin recibo disponible.');
                } else if (testResponse.status === 400) {
                    throw new Error('Esta venta no se puede imprimir (falta NCF o no está completada).');
                } else {
                    throw new Error(`Error del servidor: ${testResponse.status}`);
                }
            }
            
            // For all devices, redirect to receipt with auto_print
            console.log(`[Receipt] Redirecting to ${receiptFormat} receipt with auto-print enabled`);
            showNotification(`Generando recibo ${receiptFormat} para impresión automática...`, 'success');
            
            // Short delay to show notification, then redirect
            setTimeout(() => {
                window.location.href = viewUrl;
            }, 500);
            
            return true;
            
        } catch (fetchError) {
            console.error('[Receipt] Receipt verification failed:', fetchError);
            
            // Provide specific error messages based on the error
            let errorMessage = 'Error al verificar el recibo';
            if (fetchError.message.includes('sesión') || fetchError.message.includes('Sesión')) {
                errorMessage = fetchError.message;
            } else if (fetchError.message.includes('NCF') || fetchError.message.includes('completada')) {
                errorMessage = fetchError.message;
            } else if (fetchError.message.includes('encontrada')) {
                errorMessage = fetchError.message;
            } else {
                errorMessage = `Error al generar recibo: ${fetchError.message}`;
            }
            
            showNotification(errorMessage, 'error');
            return false;
        }
        
    } catch (error) {
        console.error('[Receipt] Error printing receipt:', error);
        showNotification(`Error al imprimir recibo: ${error.message}`, 'error');
        return false;
    }
}

// Global instances
let cartManager;
let connectionManager;
let deviceDetector;

// Legacy cart variable for backward compatibility
let cart = [];

// Load products for category with offline support
function loadProducts(categoryId) {
    fetch(`/api/products?category_id=${categoryId}`, {
        credentials: 'same-origin'
    })
        .then(response => response.json())
        .then(products => {
            const container = document.getElementById(`products-${categoryId}`);
            container.innerHTML = '';
            
            products.forEach(product => {
                const productCard = `
                    <div class="col-md-4 col-lg-3 mb-3">
                        <div class="product-card fade-in-up" onclick="addToCart(${product.id}, '${product.name}', ${product.price})">
                            <div class="card-body">
                                <div class="product-name">${product.name}</div>
                                <div class="product-price">RD$ ${product.price.toFixed(2)}</div>
                                <small class="opacity-75">Stock: ${product.stock}</small>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += productCard;
            });
        })
        .catch(error => {
            console.error('[POS] Error loading products:', error);
            if (!navigator.onLine) {
                showNotification('Cargando productos desde caché offline...', 'info');
            }
        });
}

// Switch between product categories
function switchCategory(categoryId) {
    // Remove active class from all category pills
    document.querySelectorAll('.category-pill').forEach(pill => {
        pill.classList.remove('active');
    });
    
    // Add active class to clicked category
    const activePill = document.querySelector(`[data-category-id="${categoryId}"]`);
    if (activePill) {
        activePill.classList.add('active');
    }
    
    // Hide all category product sections
    document.querySelectorAll('.category-products').forEach(section => {
        section.classList.add('d-none');
    });
    
    // Show selected category products section
    const selectedSection = document.getElementById(`category-products-${categoryId}`);
    if (selectedSection) {
        selectedSection.classList.remove('d-none');
    }
    
    // Load products for the selected category
    loadProducts(categoryId);
}

// Get current tax rate from selector
function getCurrentTaxRate() {
    const taxSelect = document.getElementById('tax-type-select');
    return taxSelect ? parseFloat(taxSelect.value) : 0.18;
}

// Update tax calculation when type changes
function updateTaxCalculation() {
    updateCartDisplay();
}

// Add product to cart (using CartManager)
function addToCart(productId, productName, price) {
    cartManager.addItem(productId, productName, price);
}

// Update cart display
function updateCartDisplay() {
    const cartItems = document.getElementById('cart-items');
    const items = cartManager.getItems();
    
    if (items.length === 0) {
        cartItems.innerHTML = '<p class="text-muted">No hay productos en el carrito</p>';
        document.getElementById('subtotal').textContent = 'RD$ 0.00';
        document.getElementById('tax').textContent = 'RD$ 0.00';
        document.getElementById('total').textContent = 'RD$ 0.00';
        return;
    }
    
    let html = '';
    const totals = cartManager.getTotals();
    
    items.forEach(item => {
        const itemTotal = item.price * item.quantity;
        
        html += `
            <div class="cart-item d-flex justify-content-between align-items-center mb-2">
                <div>
                    <div class="fw-bold">${item.name}</div>
                    <small class="text-muted">
                        <button class="btn btn-sm btn-outline-secondary me-1" onclick="updateItemQuantity(${item.id}, ${item.quantity - 1})">-</button>
                        ${item.quantity}
                        <button class="btn btn-sm btn-outline-secondary ms-1 me-2" onclick="updateItemQuantity(${item.id}, ${item.quantity + 1})">+</button>
                        x RD$ ${item.price.toFixed(2)}
                    </small>
                </div>
                <div>
                    <span class="me-2">RD$ ${itemTotal.toFixed(2)}</span>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeFromCart(${item.id})">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
        `;
    });
    
    cartItems.innerHTML = html;
    
    document.getElementById('subtotal').textContent = `RD$ ${totals.subtotal.toFixed(2)}`;
    document.getElementById('tax').textContent = `RD$ ${totals.tax.toFixed(2)}`;
    document.getElementById('total').textContent = `RD$ ${totals.total.toFixed(2)}`;
    
    // Update tax label based on selected type
    const taxRate = totals.taxRate || getCurrentTaxRate();
    const taxLabel = document.getElementById('tax-label');
    if (taxLabel) {
        if (taxRate === 0) {
            taxLabel.textContent = 'Sin impuestos';
            document.getElementById('tax-row').style.display = 'none';
        } else {
            const percentage = Math.round(taxRate * 100);
            taxLabel.textContent = `ITBIS (${percentage}%)`;
            document.getElementById('tax-row').style.display = 'flex';
        }
    }
    
    // Update legacy cart variable for backward compatibility
    cart = items;
}

// Remove item from cart (using CartManager)
function removeFromCart(productId) {
    cartManager.removeItem(productId);
}

// Update item quantity
function updateItemQuantity(productId, newQuantity) {
    cartManager.updateQuantity(productId, newQuantity);
}

// Clear cart (using CartManager)
function clearCart() {
    cartManager.clear();
    document.getElementById('table-select').value = '';
    document.getElementById('ncf-type-select').value = 'consumo';
    toggleClientInfo(); // Reset client info section
}

// Show notification to user
function showNotification(message, type = 'info') {
    // Create or update notification element
    let notification = document.getElementById('notification');
    if (!notification) {
        notification = document.createElement('div');
        notification.id = 'notification';
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            z-index: 9999;
            font-weight: 600;
            max-width: 300px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
            transform: translateX(100%);
        `;
        document.body.appendChild(notification);
    }
    
    // Set notification style based on type
    const colors = {
        success: 'background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%); color: #000;',
        error: 'background: linear-gradient(135deg, #ff4757 0%, #ff3742 100%); color: #fff;',
        warning: 'background: linear-gradient(135deg, #ffa500 0%, #ff8c00 100%); color: #000;',
        info: 'background: linear-gradient(135deg, #00d4ff 0%, #0ea5e9 100%); color: #000;'
    };
    
    notification.style.cssText += colors[type] || colors.info;
    notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px;">
            <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'error' ? 'x-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
            <span>${message}</span>
        </div>
    `;
    
    // Show notification
    setTimeout(() => notification.style.transform = 'translateX(0)', 100);
    
    // Hide notification after 5 seconds
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => notification.remove(), 300);
    }, 5000);
}

// Refresh product data for offline caching
function refreshProductData() {
    if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
        const channel = new MessageChannel();
        channel.port1.onmessage = (event) => {
            if (event.data.success) {
                console.log('[POS] Product data cached successfully');
            }
        };
        
        navigator.serviceWorker.controller.postMessage({ 
            type: 'CACHE_API_DATA' 
        }, [channel.port2]);
    }
}

// Process sale (updated for offline support)
function processSale() {
    const items = cartManager.getItems();
    if (items.length === 0) {
        showNotification('El carrito está vacío', 'warning');
        return;
    }
    
    const ncfType = document.getElementById('ncf-type-select').value;
    
    // Validate client info for fiscal/government invoices
    if (ncfType === 'credito_fiscal' || ncfType === 'gubernamental') {
        const clientName = document.getElementById('client-name').value.trim();
        const clientRnc = document.getElementById('client-rnc').value.trim();
        
        if (!clientName || !clientRnc) {
            showNotification('Para comprobantes fiscales y gubernamentales debe completar el nombre/empresa y RNC/cédula', 'error');
            return;
        }
    }
    
    const tableId = document.getElementById('table-select').value || null;
    const description = document.getElementById('order-description').value.trim() || '';
    
    // Disable button during processing
    const processButton = document.getElementById('process-sale');
    const originalText = processButton.innerHTML;
    processButton.disabled = true;
    processButton.innerHTML = '<i class="bi bi-spinner-border me-2"></i> Procesando...';
    
    // Create sale first
    fetch('/api/sales', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        credentials: 'same-origin',
        body: JSON.stringify({
            table_id: tableId,
            description: description
        })
    })
    .then(response => response.json())
    .then(sale => {
        if (sale.error) {
            showNotification('Error al crear venta: ' + sale.error, 'error');
            return Promise.reject(sale.error);
        }
        
        // Add items to sale - using cart items for compatibility
        const promises = items.map(item => 
            fetch(`/api/sales/${sale.id}/items`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                credentials: 'same-origin',
                body: JSON.stringify({
                    product_id: item.id,
                    quantity: item.quantity
                })
            })
        );
        
        return Promise.all(promises).then(() => sale);
    })
    .then(sale => {
        // Finalize sale
        const paymentMethod = document.getElementById('payment-method-select').value;
        const finalizationData = {
            payment_method: paymentMethod,
            ncf_type: ncfType,
            tax_rate: getCurrentTaxRate()
        };
        
        // Add cash payment details if paying with cash
        if (paymentMethod === 'cash') {
            const cashReceived = parseFloat(document.getElementById('cash-received').value) || 0;
            const total = cartManager.getTotals().total;
            
            if (cashReceived < total) {
                showNotification('El efectivo recibido debe ser mayor o igual al total', 'error');
                return Promise.reject('Efectivo insuficiente');
            }
            
            finalizationData.cash_received = cashReceived;
            finalizationData.change_amount = cashReceived - total;
        }
        
        // Add client info for fiscal/government invoices
        if (ncfType === 'credito_fiscal' || ncfType === 'gubernamental') {
            finalizationData.client_name = document.getElementById('client-name').value.trim();
            finalizationData.client_rnc = document.getElementById('client-rnc').value.trim();
        }
        
        return fetch(`/api/sales/${sale.id}/finalize`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            credentials: 'same-origin',
            body: JSON.stringify(finalizationData)
        });
    })
    .then(response => response.json())
    .then(result => {
        if (result.error) {
            showNotification('Error al finalizar venta: ' + result.error, 'error');
            return;
        }
        
        if (result.offline_queued) {
            showNotification('Venta guardada - se procesará cuando vuelva la conexión', 'warning');
        } else {
            showNotification(`Venta procesada exitosamente. NCF: ${result.ncf}`, 'success');
            
            // Automatically print receipt with appropriate format for device
            if (result.id) {
                const saleData = {
                    sale_id: result.id,  // Use result.id from finalize_sale response
                    table_id: result.table_id || null
                };
                printReceipt(saleData).then(printed => {
                    if (printed) {
                        console.log('[POS] Receipt printed successfully after sale');
                    } else {
                        console.log('[POS] Receipt printing failed, but sale was processed');
                    }
                }).catch(error => {
                    console.error('[POS] Receipt printing error:', error);
                    // Don't show error to user as sale was successful
                });
            }
        }
        
        clearCart();
        loadTables(); // Refresh table list
    })
    .catch(error => {
        console.error('Error processing sale:', error);
        showNotification('Error al procesar la venta', 'error');
    })
    .finally(() => {
        // Re-enable button
        processButton.disabled = false;
        processButton.innerHTML = originalText;
    });
}

// Assign order to table without processing (updated for offline support)
function assignToTable() {
    const items = cartManager.getItems();
    if (items.length === 0) {
        showNotification('El carrito está vacío', 'warning');
        return;
    }
    
    const tableId = document.getElementById('table-select').value;
    if (!tableId) {
        showNotification('Debe seleccionar una mesa', 'warning');
        return;
    }
    
    const description = document.getElementById('order-description').value.trim() || '';
    
    // Disable button during processing
    const assignButton = document.getElementById('assign-table');
    const originalText = assignButton.innerHTML;
    assignButton.disabled = true;
    assignButton.innerHTML = '<i class="bi bi-spinner-border me-2"></i> Asignando...';
    
    // Create sale first
    fetch('/api/sales', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        credentials: 'same-origin',
        body: JSON.stringify({
            table_id: tableId,
            description: description
        })
    })
    .then(response => response.json())
    .then(sale => {
        if (sale.error) {
            showNotification('Error al crear orden: ' + sale.error, 'error');
            return Promise.reject(sale.error);
        }
        
        // Add items to sale - using cart items for compatibility
        const promises = items.map(item => 
            fetch(`/api/sales/${sale.id}/items`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                credentials: 'same-origin',
                body: JSON.stringify({
                    product_id: item.id,
                    quantity: item.quantity
                })
            })
        );
        
        return Promise.all(promises).then(() => sale);
    })
    .then(sale => {
        // Update table status to occupied
        return fetch(`/api/tables/${tableId}/status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            credentials: 'same-origin',
            body: JSON.stringify({
                status: 'occupied'
            })
        }).then(() => sale);
    })
    .then(sale => {
        if (sale.offline_queued) {
            showNotification('Orden guardada - se procesará cuando vuelva la conexión', 'warning');
        } else {
            showNotification(`Orden asignada exitosamente a Mesa ${tableId}. Estado: Pendiente`, 'success');
        }
        clearCart();
        loadTables(); // Refresh table list
    })
    .catch(error => {
        console.error('Error assigning to table:', error);
        showNotification('Error al asignar orden a la mesa', 'error');
    })
    .finally(() => {
        // Re-enable button
        assignButton.disabled = false;
        assignButton.innerHTML = originalText;
    });
}

// Clear cart - removed duplicate function, using CartManager version only

// Toggle client information fields based on NCF type
function toggleClientInfo() {
    const ncfType = document.getElementById('ncf-type-select').value;
    const clientInfoSection = document.getElementById('client-info-section');
    
    if (ncfType === 'credito_fiscal' || ncfType === 'gubernamental') {
        clientInfoSection.style.display = 'block';
        // Make fields required
        document.getElementById('client-name').required = true;
        document.getElementById('client-rnc').required = true;
    } else {
        clientInfoSection.style.display = 'none';
        // Remove required attribute
        document.getElementById('client-name').required = false;
        document.getElementById('client-rnc').required = false;
        // Clear values
        document.getElementById('client-name').value = '';
        document.getElementById('client-rnc').value = '';
    }
}

// Load available tables
function loadTables() {
    fetch('/api/tables?status=available', {
        credentials: 'same-origin'
    })
        .then(response => response.json())
        .then(tables => {
            const tableSelect = document.getElementById('table-select');
            tableSelect.innerHTML = '<option value="">Seleccione una mesa</option>';
            
            tables.forEach(table => {
                const option = document.createElement('option');
                option.value = table.id;
                option.textContent = `Mesa ${table.number}${table.name ? ' - ' + table.name : ''}`;
                tableSelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error loading tables:', error);
        });
}

// Load available tables with offline support
function loadTables() {
    fetch('/api/tables?status=available', {
        credentials: 'same-origin'
    })
        .then(response => response.json())
        .then(tables => {
            const tableSelect = document.getElementById('table-select');
            tableSelect.innerHTML = '<option value="">Seleccione una mesa</option>';
            
            tables.forEach(table => {
                const option = document.createElement('option');
                option.value = table.id;
                option.textContent = `Mesa ${table.number}${table.name ? ' - ' + table.name : ''}`;
                tableSelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('[POS] Error loading tables:', error);
            if (!navigator.onLine) {
                showNotification('Cargando mesas desde caché offline...', 'info');
            }
        });
}

// Service Worker Registration
async function registerServiceWorker() {
    if ('serviceWorker' in navigator) {
        try {
            const registration = await navigator.serviceWorker.register('/static/sw.js');
            console.log('[SW] Service Worker registered successfully:', registration);
            
            // Listen for updates
            registration.addEventListener('updatefound', () => {
                const newWorker = registration.installing;
                newWorker.addEventListener('statechange', () => {
                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                        showNotification('Nueva versión disponible - recarga para actualizar', 'info');
                    }
                });
            });
            
            // Cache initial API data
            if (navigator.serviceWorker.controller) {
                refreshProductData();
            }
            
            return registration;
        } catch (error) {
            console.error('[SW] Service Worker registration failed:', error);
        }
    } else {
        console.log('[SW] Service Worker not supported');
    }
}

// Tab Management Functions
function showProductsSection() {
    // Switch tab buttons
    document.getElementById('products-tab').classList.add('active');
    document.getElementById('orders-tab').classList.remove('active');
    
    // Switch sections
    document.getElementById('products-section').classList.remove('d-none');
    document.getElementById('orders-section').classList.add('d-none');
}

function showOrdersSection() {
    // Switch tab buttons
    document.getElementById('orders-tab').classList.add('active');
    document.getElementById('products-tab').classList.remove('active');
    
    // Switch sections
    document.getElementById('orders-section').classList.remove('d-none');
    document.getElementById('products-section').classList.add('d-none');
    
    // Load pending orders
    loadPendingOrders();
}

// Load pending orders from API
async function loadPendingOrders() {
    try {
        const response = await fetch('/api/pending-orders');
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        const orders = data.orders || [];
        
        // Update order count in tab
        document.getElementById('pending-orders-count').textContent = orders.length;
        
        // Display orders
        displayPendingOrders(orders);
        
    } catch (error) {
        console.error('[Orders] Error loading pending orders:', error);
        showNotification('Error cargando órdenes pendientes', 'error');
    }
}

// Display pending orders in the interface
function displayPendingOrders(orders) {
    const container = document.getElementById('pending-orders-container');
    
    if (orders.length === 0) {
        container.innerHTML = `
            <div class="empty-orders text-center py-5">
                <i class="bi bi-inbox" style="font-size: 3rem; color: #ddd;"></i>
                <h6 class="text-muted mt-3">No hay órdenes pendientes</h6>
                <p class="text-muted mb-0">Las órdenes de los meseros aparecerán aquí</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = orders.map(order => `
        <div class="order-card" data-order-id="${order.id}">
            <div class="order-header">
                <div class="order-info">
                    <h6 class="order-title">
                        <i class="bi bi-table me-1"></i>
                        Mesa ${order.table_number || 'Sin asignar'}
                        ${order.table_name ? ` - ${order.table_name}` : ''}
                    </h6>
                    <small class="text-muted">
                        <i class="bi bi-person me-1"></i>
                        Mesero: ${order.waiter_name} • 
                        ${new Date(order.created_at).toLocaleTimeString('es-DO', {hour: '2-digit', minute: '2-digit'})}
                    </small>
                </div>
                <div class="order-status">
                    <span class="badge ${getOrderStatusBadgeClass(order.order_status)}">
                        ${getOrderStatusText(order.order_status)}
                    </span>
                </div>
            </div>
            
            <div class="order-items">
                ${order.items.map(item => `
                    <div class="order-item">
                        <span class="item-name">${item.product_name}</span>
                        <span class="item-quantity">×${item.quantity}</span>
                        <span class="item-price">RD$ ${item.total_price.toFixed(2)}</span>
                    </div>
                `).join('')}
            </div>
            
            <div class="order-footer">
                <div class="order-total">
                    <strong>Total: RD$ ${order.total.toFixed(2)}</strong>
                </div>
                <div class="order-actions">
                    <button class="btn btn-primary btn-sm" onclick="billOrder(${order.id})">
                        <i class="bi bi-receipt me-1"></i>
                        Facturar
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="viewOrderDetails(${order.id})">
                        <i class="bi bi-eye me-1"></i>
                        Ver
                    </button>
                </div>
            </div>
        </div>
    `).join('');
}

// Utility functions for order status
function getOrderStatusBadgeClass(status) {
    switch (status) {
        case 'sent_to_kitchen': return 'bg-info';
        case 'in_preparation': return 'bg-warning';
        case 'ready': return 'bg-success';
        default: return 'bg-secondary';
    }
}

function getOrderStatusText(status) {
    switch (status) {
        case 'not_sent': return 'No enviado';
        case 'sent_to_kitchen': return 'En cocina';
        case 'in_preparation': return 'Preparando';
        case 'ready': return 'Listo';
        default: return 'Pendiente';
    }
}

// Bill an order (load it into the cart for processing)
async function billOrder(orderId) {
    try {
        // Clear current cart first
        cartManager.clearCart();
        
        // Get order details
        const response = await fetch(`/api/sales/${orderId}/details`);
        if (!response.ok) {
            throw new Error('Error obteniendo detalles de la orden');
        }
        
        const orderData = await response.json();
        const order = orderData.sale;
        
        // Add order items to cart
        order.sale_items.forEach(item => {
            cartManager.addItem({
                id: item.product.id,
                name: item.product.name,
                price: item.unit_price,
                quantity: item.quantity,
                category: item.product.category_name || 'General'
            });
        });
        
        // Set table if available
        if (order.table_id) {
            const tableSelect = document.getElementById('table-select');
            tableSelect.value = order.table_id;
        }
        
        // Switch to products tab to show the cart
        showProductsSection();
        
        // Update cart display
        updateCartDisplay();
        
        // Store the order ID for finalization
        window.currentOrderId = orderId;
        
        showNotification(`Orden de Mesa ${order.table?.number || 'Sin asignar'} cargada en el carrito`, 'success');
        
    } catch (error) {
        console.error('[Orders] Error billing order:', error);
        showNotification('Error cargando la orden para facturación', 'error');
    }
}

// View order details (placeholder for now)
function viewOrderDetails(orderId) {
    // TODO: Implement order details modal
    showNotification(`Ver detalles de orden ${orderId} - Por implementar`, 'info');
}

// Toggle cash payment fields based on payment method
function toggleCashFields() {
    const paymentMethod = document.getElementById('payment-method-select').value;
    const cashSection = document.getElementById('cash-payment-section');
    
    if (paymentMethod === 'cash') {
        cashSection.style.display = 'block';
        // Auto-fill cash received with total amount
        const total = cartManager.getTotals().total;
        document.getElementById('cash-received').value = total.toFixed(2);
        calculateChange();
    } else {
        cashSection.style.display = 'none';
        document.getElementById('cash-received').value = '';
        document.getElementById('change-display').textContent = 'RD$ 0.00';
    }
}

// Calculate change to be given
function calculateChange() {
    const cashReceived = parseFloat(document.getElementById('cash-received').value) || 0;
    const total = cartManager.getTotals().total;
    const change = Math.max(0, cashReceived - total);
    
    const changeDisplay = document.getElementById('change-display');
    changeDisplay.textContent = `RD$ ${change.toFixed(2)}`;
    
    // Add visual feedback for insufficient cash
    if (cashReceived > 0 && cashReceived < total) {
        changeDisplay.style.color = '#dc3545';
        changeDisplay.innerHTML = `<i class="bi bi-exclamation-triangle"></i> RD$ ${change.toFixed(2)} (Insuficiente)`;
    } else if (change > 0) {
        changeDisplay.style.color = '#28a745';
        changeDisplay.innerHTML = `<i class="bi bi-check-circle"></i> RD$ ${change.toFixed(2)}`;
    } else {
        changeDisplay.style.color = '#6c757d';
    }
}

// Load existing sale for editing
async function loadSaleForEditing(saleData) {
    console.log('[POS] Loading sale for editing:', saleData);
    
    try {
        // Clear current cart
        cartManager.clear();
        
        // Set table selection if applicable
        if (saleData.table_id) {
            const tableSelect = document.getElementById('table-select');
            if (tableSelect) {
                tableSelect.value = saleData.table_id;
            }
        }
        
        // Set description if available
        if (saleData.description) {
            const descriptionInput = document.getElementById('order-description');
            if (descriptionInput) {
                descriptionInput.value = saleData.description;
            }
        }
        
        // Add items to cart
        for (const item of saleData.items) {
            cartManager.addItemDirectly(
                item.product_id,
                item.product_name,
                item.price,
                item.quantity
            );
        }
        
        // Update cart display
        updateCartDisplay();
        
        showNotification(`Orden #${saleData.id} cargada para edición`, 'info');
        
        console.log('[POS] Sale loaded successfully for editing');
        
    } catch (error) {
        console.error('[POS] Error loading sale for editing:', error);
        showNotification('Error cargando la orden para edición', 'error');
    }
}

// Initialize POS System
async function initializePOS() {
    console.log('[POS] Initializing POS system...');
    
    // Initialize managers
    cartManager = new CartManager();
    connectionManager = new ConnectionManager();
    deviceDetector = new DeviceDetector();
    
    // Log device information for debugging
    deviceDetector.logDeviceInfo();
    
    // Register service worker
    await registerServiceWorker();
    
    // Load initial cart state
    updateCartDisplay();
    
    // Check if we're editing an existing sale
    {% if edit_sale_data %}
    const editSaleData = {{ edit_sale_data | tojson }};
    await loadSaleForEditing(editSaleData);
    {% endif %}
    
    // Load products for the first category (default)
    const firstCategory = document.querySelector('[data-bs-toggle="pill"]');
    if (firstCategory) {
        const categoryId = firstCategory.getAttribute('data-bs-target').replace('#category-', '');
        loadProducts(categoryId);
    } else {
        // Fallback: load products for category 1 if no tabs found
        loadProducts(1);
    }
    
    // Load available tables
    loadTables();
    
    // Load pending orders count
    loadPendingOrders();
    
    console.log('[POS] POS system initialized successfully');
    showNotification('Sistema POS iniciado - Modo offline disponible', 'success');
}

// Document ready event
document.addEventListener('DOMContentLoaded', initializePOS);

// Handle category tab changes
document.addEventListener('shown.bs.tab', function(e) {
    if (e.target.getAttribute('data-bs-toggle') === 'pill') {
        const categoryId = e.target.getAttribute('data-bs-target').replace('#category-', '');
        loadProducts(categoryId);
    }
});

// Handle page visibility change (for better power management)
document.addEventListener('visibilitychange', function() {
    if (document.visibilityState === 'visible') {
        // Page became visible, check connection and refresh if needed
        if (navigator.onLine && connectionManager) {
            connectionManager.onConnectionRestored();
        }
    }
});

// Prevent data loss on page unload
window.addEventListener('beforeunload', function(e) {
    // Cart is automatically saved via localStorage, but let's ensure it
    if (cartManager && cartManager.getItems().length > 0) {
        e.preventDefault();
        e.returnValue = 'Tienes productos en el carrito. ¿Estás seguro de que quieres salir?';
    }
});
</script>
{% endblock %}