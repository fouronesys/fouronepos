{% extends "base.html" %}

{% block title %}Punto de Venta - Four One POS{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pos-style.css') }}?v=20250912065500">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="pos-header fade-in-up">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="mb-0"><i class="bi bi-cash-register me-3"></i> Punto de Venta</h2>
                <p class="mb-0 mt-2 opacity-75">Sistema POS con Cumplimiento Fiscal Dominicano</p>
            </div>
            <div class="d-flex align-items-center gap-3">
                <!-- Connection Status Indicator -->
                <div id="connection-status" class="connection-status online">
                    <i class="bi bi-wifi"></i> En línea
                </div>
                <!-- Offline Queue Status -->
                <div id="sync-status" class="sync-status" style="display: none;">
                    <i class="bi bi-cloud-upload"></i> <span id="sync-count">0</span> pendiente(s)
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- Products Section -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-grid"></i> Productos</h5>
                </div>
                <div class="card-body">
                    <!-- Category Tabs -->
                    <ul class="nav nav-pills mb-3" id="category-tabs">
                        {% for category in categories %}
                        <li class="nav-item">
                            <button class="nav-link {% if loop.first %}active{% endif %}" 
                                    data-bs-toggle="pill" 
                                    data-bs-target="#category-{{ category.id }}">
                                {{ category.name }}
                            </button>
                        </li>
                        {% endfor %}
                    </ul>
                    
                    <!-- Product Grid -->
                    <div class="tab-content">
                        {% for category in categories %}
                        <div class="tab-pane fade {% if loop.first %}show active{% endif %}" 
                             id="category-{{ category.id }}">
                            <div class="row" id="products-{{ category.id }}">
                                <!-- Products will be loaded via JavaScript -->
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Cart Section -->
        <div class="col-md-4">
            <div class="cart-section fade-in-up">
                <h5 class="mb-4"><i class="bi bi-cart me-2"></i> Carrito de Compras</h5>
                    <!-- Table Selection -->
                    <div class="mb-3">
                        <label for="table-select" class="form-label">
                            <i class="bi bi-table"></i> Mesa (Opcional)
                        </label>
                        <select class="form-control" id="table-select">
                            <option value="">Sin mesa asignada</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="ncf-type-select" class="form-label">
                            <i class="bi bi-receipt"></i> Tipo de Comprobante
                        </label>
                        <select class="form-control" id="ncf-type-select" onchange="toggleClientInfo()">
                            <option value="consumo">Consumo</option>
                            <option value="credito_fiscal">Crédito Fiscal</option>
                            <option value="gubernamental">Gubernamental</option>
                        </select>
                    </div>
                    
                    <!-- Client Information for Fiscal/Government Invoices -->
                    <div id="client-info-section" style="display: none;">
                        <div class="mb-3">
                            <label for="client-name" class="form-label">
                                <i class="bi bi-person"></i> Nombre/Empresa
                            </label>
                            <input type="text" class="form-control" id="client-name" placeholder="Nombre o razón social">
                        </div>
                        <div class="mb-3">
                            <label for="client-rnc" class="form-label">
                                <i class="bi bi-card-text"></i> RNC/Cédula
                            </label>
                            <input type="text" class="form-control" id="client-rnc" placeholder="RNC o número de cédula">
                        </div>
                    </div>
                    
                    <div id="cart-items">
                        <p class="text-muted">No hay productos en el carrito</p>
                    </div>
                    
                    <div class="totals-section">
                        <div class="d-flex justify-content-between mb-2">
                            <span><strong>Subtotal:</strong></span>
                            <span id="subtotal" class="fw-bold">RD$ 0.00</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span><strong>ITBIS (18%):</strong></span>
                            <span id="tax" class="fw-bold">RD$ 0.00</span>
                        </div>
                        <div class="d-flex justify-content-between fw-bold">
                            <span>Total:</span>
                            <span id="total">RD$ 0.00</span>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button class="btn btn-success-custom pulse-animation" id="process-sale" onclick="processSale()">
                            <i class="bi bi-check-circle me-2"></i> Procesar Venta
                        </button>
                        <button class="btn btn-warning" id="assign-table" onclick="assignToTable()" style="background: linear-gradient(135deg, #ffa500 0%, #ff8c00 100%); color: #000; font-weight: 600;">
                            <i class="bi bi-table me-2"></i> Asignar a Mesa
                        </button>
                        <button class="btn btn-danger-custom" id="clear-cart" onclick="clearCart()">
                            <i class="bi bi-trash me-2"></i> Limpiar Carrito
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Enhanced POS functionality with offline support and cart persistence

// Cart Management with localStorage
class CartManager {
    constructor() {
        this.storageKey = 'fourone_pos_cart';
        this.cart = this.loadCartFromStorage();
        this.setupCrossTabSync();
        this.setupServiceWorkerCommunication();
    }

    // Load cart from localStorage
    loadCartFromStorage() {
        try {
            const storedCart = localStorage.getItem(this.storageKey);
            const cart = storedCart ? JSON.parse(storedCart) : [];
            console.log('[Cart] Loaded cart from storage:', cart);
            return cart;
        } catch (error) {
            console.error('[Cart] Error loading cart from storage:', error);
            return [];
        }
    }

    // Save cart to localStorage
    saveCartToStorage() {
        try {
            localStorage.setItem(this.storageKey, JSON.stringify(this.cart));
            console.log('[Cart] Cart saved to storage:', this.cart);
            
            // Broadcast cart change for cross-tab sync
            this.broadcastCartChange();
        } catch (error) {
            console.error('[Cart] Error saving cart to storage:', error);
        }
    }

    // Setup cross-tab synchronization
    setupCrossTabSync() {
        // Listen for storage events from other tabs
        window.addEventListener('storage', (e) => {
            if (e.key === this.storageKey && e.newValue !== null) {
                console.log('[Cart] Cart updated in another tab, syncing...');
                this.cart = JSON.parse(e.newValue);
                updateCartDisplay();
                showNotification('Carrito sincronizado desde otra pestaña', 'info');
            }
        });

        // Listen for custom cart change events within the same tab
        window.addEventListener('cartChanged', () => {
            updateCartDisplay();
        });
    }

    // Broadcast cart changes using Broadcast Channel API
    broadcastCartChange() {
        if ('BroadcastChannel' in window) {
            const channel = new BroadcastChannel('cart_sync');
            channel.postMessage({
                type: 'CART_UPDATED',
                cart: this.cart,
                timestamp: Date.now()
            });
        }

        // Dispatch custom event for same-tab components
        window.dispatchEvent(new CustomEvent('cartChanged'));
    }

    // Add item to cart
    addItem(productId, productName, price) {
        const existingItem = this.cart.find(item => item.id === productId);
        
        if (existingItem) {
            existingItem.quantity += 1;
        } else {
            this.cart.push({
                id: productId,
                name: productName,
                price: price,
                quantity: 1,
                addedAt: Date.now()
            });
        }
        
        this.saveCartToStorage();
        showNotification(`${productName} agregado al carrito`, 'success');
    }

    // Remove item from cart
    removeItem(productId) {
        const item = this.cart.find(item => item.id === productId);
        this.cart = this.cart.filter(item => item.id !== productId);
        this.saveCartToStorage();
        
        if (item) {
            showNotification(`${item.name} removido del carrito`, 'warning');
        }
    }

    // Update item quantity
    updateQuantity(productId, quantity) {
        const item = this.cart.find(item => item.id === productId);
        if (item) {
            if (quantity > 0) {
                item.quantity = quantity;
                this.saveCartToStorage();
            } else {
                this.removeItem(productId);
            }
        }
    }

    // Clear cart
    clear() {
        this.cart = [];
        this.saveCartToStorage();
        showNotification('Carrito limpiado', 'info');
    }

    // Get cart items
    getItems() {
        return this.cart;
    }

    // Get cart totals
    getTotals() {
        const subtotal = this.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const tax = subtotal * 0.18;
        const total = subtotal + tax;
        return { subtotal, tax, total };
    }

    // Setup service worker communication
    setupServiceWorkerCommunication() {
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.addEventListener('message', (event) => {
                if (event.data.type === 'offline-request-queued') {
                    showNotification('Operación guardada - se procesará cuando vuelva la conexión', 'warning');
                } else if (event.data.type === 'offline-request-synced') {
                    showNotification('Operación sincronizada exitosamente', 'success');
                }
            });
        }
    }
}

// Connection Status Manager
class ConnectionManager {
    constructor() {
        this.isOnline = navigator.onLine;
        this.setupConnectionListeners();
        this.updateConnectionStatus();
    }

    setupConnectionListeners() {
        window.addEventListener('online', () => {
            this.isOnline = true;
            this.updateConnectionStatus();
            this.onConnectionRestored();
        });

        window.addEventListener('offline', () => {
            this.isOnline = false;
            this.updateConnectionStatus();
            this.onConnectionLost();
        });
    }

    updateConnectionStatus() {
        const statusIndicator = document.getElementById('connection-status');
        if (statusIndicator) {
            if (this.isOnline) {
                statusIndicator.className = 'connection-status online';
                statusIndicator.innerHTML = '<i class="bi bi-wifi"></i> En línea';
            } else {
                statusIndicator.className = 'connection-status offline';
                statusIndicator.innerHTML = '<i class="bi bi-wifi-off"></i> Offline';
            }
        }
    }

    onConnectionRestored() {
        showNotification('Conexión restaurada - sincronizando datos...', 'success');
        
        // Force sync with service worker
        if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
            navigator.serviceWorker.controller.postMessage({ type: 'FORCE_SYNC' });
        }
        
        // Refresh data
        loadTables();
        refreshProductData();
    }

    onConnectionLost() {
        showNotification('Conexión perdida - trabajando offline', 'warning');
    }
}

// Device Detection Class
class DeviceDetector {
    constructor() {
        this.deviceInfo = this.detectDevice();
    }
    
    detectDevice() {
        const userAgent = navigator.userAgent.toLowerCase();
        const touchSupport = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
        const screenWidth = window.screen.width;
        const screenHeight = window.screen.height;
        const pixelRatio = window.devicePixelRatio || 1;
        
        // Check for mobile/tablet indicators
        const isMobile = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(userAgent);
        const isTablet = /(ipad|android(?!.*mobile)|tablet)/i.test(userAgent) || 
                        (touchSupport && Math.min(screenWidth, screenHeight) >= 768);
        
        // Additional checks for touch-capable devices
        const isTouchDevice = touchSupport && (isMobile || isTablet || 
            (screenWidth <= 1024 && screenHeight <= 1366)); // Common tablet resolutions
        
        // Determine receipt format based on device type
        const receiptFormat = (isMobile || (isTablet && Math.min(screenWidth, screenHeight) < 800)) ? '58mm' : '80mm';
        
        return {
            isMobile: isMobile,
            isTablet: isTablet,
            isTouchDevice: isTouchDevice,
            isDesktop: !isMobile && !isTablet && !isTouchDevice,
            receiptFormat: receiptFormat,
            screenWidth: screenWidth,
            screenHeight: screenHeight,
            pixelRatio: pixelRatio,
            userAgent: userAgent,
            touchSupport: touchSupport
        };
    }
    
    getReceiptFormat() {
        return this.deviceInfo.receiptFormat;
    }
    
    getDeviceInfo() {
        return this.deviceInfo;
    }
    
    logDeviceInfo() {
        console.log('[Device] Detected device info:', this.deviceInfo);
    }
}

// Automatic Receipt Printing Function
async function printReceipt(saleData) {
    try {
        // Handle both sale_id and id for robustness
        const saleId = saleData.sale_id || saleData.id;
        if (!saleId) {
            throw new Error('Sale ID is required for receipt printing');
        }
        
        const receiptFormat = deviceDetector.getReceiptFormat();
        const deviceInfo = deviceDetector.getDeviceInfo();
        console.log(`[Receipt] Printing receipt in ${receiptFormat} format for ${deviceInfo.isMobile ? 'mobile' : deviceInfo.isTablet ? 'tablet' : 'desktop'} device`);
        
        // Use existing receipt view endpoint with format parameter
        const viewUrl = `/api/receipts/${saleId}/view?format=${receiptFormat}`;
        
        // For mobile/tablet devices, fetch receipt and trigger auto-print
        if (deviceInfo.isMobile || deviceInfo.isTablet) {
            console.log(`[Receipt] Generating ${receiptFormat} thermal receipt for mobile/tablet`);
            
            try {
                // Fetch the receipt content to verify it's ready
                const response = await fetch(viewUrl);
                if (response.ok) {
                    // On mobile/tablet, redirect with auto_print for automatic printing
                    window.location.href = viewUrl + '&auto_print=true';
                    showNotification(`Recibo t\u00e9rmico ${receiptFormat} generado - redirigiendo para impresi\u00f3n...`, 'success');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (fetchError) {
                console.error('[Receipt] Failed to fetch receipt:', fetchError);
                showNotification(`Error al generar recibo t\u00e9rmico: ${fetchError.message}`, 'error');
                return false;
            }
            
            return true;
        }
        
        // For desktop, avoid popup blocker by redirecting to same tab
        if (deviceInfo.isDesktop) {
            console.log(`[Receipt] Redirecting to ${receiptFormat} receipt for desktop printing`);
            // Redirect to receipt page which will auto-trigger print on load
            window.location.href = viewUrl + '&auto_print=true';
            showNotification(`Recibo ${receiptFormat} generado - redirigiendo para impresión...`, 'success');
            
            return true;
        }
        
        return true;
        
    } catch (error) {
        console.error('[Receipt] Error printing receipt:', error);
        showNotification(`Error al imprimir recibo: ${error.message}`, 'error');
        return false;
    }
}

// Global instances
let cartManager;
let connectionManager;
let deviceDetector;

// Legacy cart variable for backward compatibility
let cart = [];

// Load products for category with offline support
function loadProducts(categoryId) {
    fetch(`/api/products?category_id=${categoryId}`, {
        credentials: 'same-origin'
    })
        .then(response => response.json())
        .then(products => {
            const container = document.getElementById(`products-${categoryId}`);
            container.innerHTML = '';
            
            products.forEach(product => {
                const productCard = `
                    <div class="col-md-4 col-lg-3 mb-3">
                        <div class="product-card fade-in-up" onclick="addToCart(${product.id}, '${product.name}', ${product.price})">
                            <div class="card-body">
                                <div class="product-name">${product.name}</div>
                                <div class="product-price">RD$ ${product.price.toFixed(2)}</div>
                                <small class="opacity-75">Stock: ${product.stock}</small>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += productCard;
            });
        })
        .catch(error => {
            console.error('[POS] Error loading products:', error);
            if (!navigator.onLine) {
                showNotification('Cargando productos desde caché offline...', 'info');
            }
        });
}

// Add product to cart (using CartManager)
function addToCart(productId, productName, price) {
    cartManager.addItem(productId, productName, price);
}

// Update cart display
function updateCartDisplay() {
    const cartItems = document.getElementById('cart-items');
    const items = cartManager.getItems();
    
    if (items.length === 0) {
        cartItems.innerHTML = '<p class="text-muted">No hay productos en el carrito</p>';
        document.getElementById('subtotal').textContent = 'RD$ 0.00';
        document.getElementById('tax').textContent = 'RD$ 0.00';
        document.getElementById('total').textContent = 'RD$ 0.00';
        return;
    }
    
    let html = '';
    const totals = cartManager.getTotals();
    
    items.forEach(item => {
        const itemTotal = item.price * item.quantity;
        
        html += `
            <div class="cart-item d-flex justify-content-between align-items-center mb-2">
                <div>
                    <div class="fw-bold">${item.name}</div>
                    <small class="text-muted">
                        <button class="btn btn-sm btn-outline-secondary me-1" onclick="updateItemQuantity(${item.id}, ${item.quantity - 1})">-</button>
                        ${item.quantity}
                        <button class="btn btn-sm btn-outline-secondary ms-1 me-2" onclick="updateItemQuantity(${item.id}, ${item.quantity + 1})">+</button>
                        x RD$ ${item.price.toFixed(2)}
                    </small>
                </div>
                <div>
                    <span class="me-2">RD$ ${itemTotal.toFixed(2)}</span>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeFromCart(${item.id})">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
        `;
    });
    
    cartItems.innerHTML = html;
    
    document.getElementById('subtotal').textContent = `RD$ ${totals.subtotal.toFixed(2)}`;
    document.getElementById('tax').textContent = `RD$ ${totals.tax.toFixed(2)}`;
    document.getElementById('total').textContent = `RD$ ${totals.total.toFixed(2)}`;
    
    // Update legacy cart variable for backward compatibility
    cart = items;
}

// Remove item from cart (using CartManager)
function removeFromCart(productId) {
    cartManager.removeItem(productId);
}

// Update item quantity
function updateItemQuantity(productId, newQuantity) {
    cartManager.updateQuantity(productId, newQuantity);
}

// Clear cart (using CartManager)
function clearCart() {
    cartManager.clear();
    document.getElementById('table-select').value = '';
    document.getElementById('ncf-type-select').value = 'consumo';
    toggleClientInfo(); // Reset client info section
}

// Show notification to user
function showNotification(message, type = 'info') {
    // Create or update notification element
    let notification = document.getElementById('notification');
    if (!notification) {
        notification = document.createElement('div');
        notification.id = 'notification';
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            z-index: 9999;
            font-weight: 600;
            max-width: 300px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
            transform: translateX(100%);
        `;
        document.body.appendChild(notification);
    }
    
    // Set notification style based on type
    const colors = {
        success: 'background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%); color: #000;',
        error: 'background: linear-gradient(135deg, #ff4757 0%, #ff3742 100%); color: #fff;',
        warning: 'background: linear-gradient(135deg, #ffa500 0%, #ff8c00 100%); color: #000;',
        info: 'background: linear-gradient(135deg, #00d4ff 0%, #0ea5e9 100%); color: #000;'
    };
    
    notification.style.cssText += colors[type] || colors.info;
    notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px;">
            <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'error' ? 'x-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
            <span>${message}</span>
        </div>
    `;
    
    // Show notification
    setTimeout(() => notification.style.transform = 'translateX(0)', 100);
    
    // Hide notification after 5 seconds
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => notification.remove(), 300);
    }, 5000);
}

// Refresh product data for offline caching
function refreshProductData() {
    if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
        const channel = new MessageChannel();
        channel.port1.onmessage = (event) => {
            if (event.data.success) {
                console.log('[POS] Product data cached successfully');
            }
        };
        
        navigator.serviceWorker.controller.postMessage({ 
            type: 'CACHE_API_DATA' 
        }, [channel.port2]);
    }
}

// Process sale (updated for offline support)
function processSale() {
    const items = cartManager.getItems();
    if (items.length === 0) {
        showNotification('El carrito está vacío', 'warning');
        return;
    }
    
    const ncfType = document.getElementById('ncf-type-select').value;
    
    // Validate client info for fiscal/government invoices
    if (ncfType === 'credito_fiscal' || ncfType === 'gubernamental') {
        const clientName = document.getElementById('client-name').value.trim();
        const clientRnc = document.getElementById('client-rnc').value.trim();
        
        if (!clientName || !clientRnc) {
            showNotification('Para comprobantes fiscales y gubernamentales debe completar el nombre/empresa y RNC/cédula', 'error');
            return;
        }
    }
    
    const tableId = document.getElementById('table-select').value || null;
    
    // Disable button during processing
    const processButton = document.getElementById('process-sale');
    const originalText = processButton.innerHTML;
    processButton.disabled = true;
    processButton.innerHTML = '<i class="bi bi-spinner-border me-2"></i> Procesando...';
    
    // Create sale first
    fetch('/api/sales', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        credentials: 'same-origin',
        body: JSON.stringify({
            table_id: tableId
        })
    })
    .then(response => response.json())
    .then(sale => {
        if (sale.error) {
            showNotification('Error al crear venta: ' + sale.error, 'error');
            return Promise.reject(sale.error);
        }
        
        // Add items to sale - using cart items for compatibility
        const promises = items.map(item => 
            fetch(`/api/sales/${sale.id}/items`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin',
                body: JSON.stringify({
                    product_id: item.id,
                    quantity: item.quantity
                })
            })
        );
        
        return Promise.all(promises).then(() => sale);
    })
    .then(sale => {
        // Finalize sale
        const finalizationData = {
            payment_method: 'efectivo',
            ncf_type: ncfType
        };
        
        // Add client info for fiscal/government invoices
        if (ncfType === 'credito_fiscal' || ncfType === 'gubernamental') {
            finalizationData.client_name = document.getElementById('client-name').value.trim();
            finalizationData.client_rnc = document.getElementById('client-rnc').value.trim();
        }
        
        return fetch(`/api/sales/${sale.id}/finalize`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'same-origin',
            body: JSON.stringify(finalizationData)
        });
    })
    .then(response => response.json())
    .then(result => {
        if (result.error) {
            showNotification('Error al finalizar venta: ' + result.error, 'error');
            return;
        }
        
        if (result.offline_queued) {
            showNotification('Venta guardada - se procesará cuando vuelva la conexión', 'warning');
        } else {
            showNotification(`Venta procesada exitosamente. NCF: ${result.ncf}`, 'success');
            
            // Automatically print receipt with appropriate format for device
            if (result.id) {
                const saleData = {
                    sale_id: result.id,  // Use result.id from finalize_sale response
                    table_id: result.table_id || null
                };
                printReceipt(saleData).then(printed => {
                    if (printed) {
                        console.log('[POS] Receipt printed successfully after sale');
                    } else {
                        console.log('[POS] Receipt printing failed, but sale was processed');
                    }
                }).catch(error => {
                    console.error('[POS] Receipt printing error:', error);
                    // Don't show error to user as sale was successful
                });
            }
        }
        
        clearCart();
        loadTables(); // Refresh table list
    })
    .catch(error => {
        console.error('Error processing sale:', error);
        showNotification('Error al procesar la venta', 'error');
    })
    .finally(() => {
        // Re-enable button
        processButton.disabled = false;
        processButton.innerHTML = originalText;
    });
}

// Assign order to table without processing (updated for offline support)
function assignToTable() {
    const items = cartManager.getItems();
    if (items.length === 0) {
        showNotification('El carrito está vacío', 'warning');
        return;
    }
    
    const tableId = document.getElementById('table-select').value;
    if (!tableId) {
        showNotification('Debe seleccionar una mesa', 'warning');
        return;
    }
    
    // Disable button during processing
    const assignButton = document.getElementById('assign-table');
    const originalText = assignButton.innerHTML;
    assignButton.disabled = true;
    assignButton.innerHTML = '<i class="bi bi-spinner-border me-2"></i> Asignando...';
    
    // Create sale first
    fetch('/api/sales', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        credentials: 'same-origin',
        body: JSON.stringify({
            table_id: tableId
        })
    })
    .then(response => response.json())
    .then(sale => {
        if (sale.error) {
            showNotification('Error al crear orden: ' + sale.error, 'error');
            return Promise.reject(sale.error);
        }
        
        // Add items to sale - using cart items for compatibility
        const promises = items.map(item => 
            fetch(`/api/sales/${sale.id}/items`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin',
                body: JSON.stringify({
                    product_id: item.id,
                    quantity: item.quantity
                })
            })
        );
        
        return Promise.all(promises).then(() => sale);
    })
    .then(sale => {
        // Update table status to occupied
        return fetch(`/api/tables/${tableId}/status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'same-origin',
            body: JSON.stringify({
                status: 'occupied'
            })
        }).then(() => sale);
    })
    .then(sale => {
        if (sale.offline_queued) {
            showNotification('Orden guardada - se procesará cuando vuelva la conexión', 'warning');
        } else {
            showNotification(`Orden asignada exitosamente a Mesa ${tableId}. Estado: Pendiente`, 'success');
        }
        clearCart();
        loadTables(); // Refresh table list
    })
    .catch(error => {
        console.error('Error assigning to table:', error);
        showNotification('Error al asignar orden a la mesa', 'error');
    })
    .finally(() => {
        // Re-enable button
        assignButton.disabled = false;
        assignButton.innerHTML = originalText;
    });
}

// Clear cart
function clearCart() {
    cart = [];
    updateCartDisplay();
    document.getElementById('table-select').value = '';
}

// Toggle client information fields based on NCF type
function toggleClientInfo() {
    const ncfType = document.getElementById('ncf-type-select').value;
    const clientInfoSection = document.getElementById('client-info-section');
    
    if (ncfType === 'credito_fiscal' || ncfType === 'gubernamental') {
        clientInfoSection.style.display = 'block';
        // Make fields required
        document.getElementById('client-name').required = true;
        document.getElementById('client-rnc').required = true;
    } else {
        clientInfoSection.style.display = 'none';
        // Remove required attribute
        document.getElementById('client-name').required = false;
        document.getElementById('client-rnc').required = false;
        // Clear values
        document.getElementById('client-name').value = '';
        document.getElementById('client-rnc').value = '';
    }
}

// Load available tables
function loadTables() {
    fetch('/api/tables?status=available', {
        credentials: 'same-origin'
    })
        .then(response => response.json())
        .then(tables => {
            const tableSelect = document.getElementById('table-select');
            tableSelect.innerHTML = '<option value="">Sin mesa asignada</option>';
            
            tables.forEach(table => {
                const option = document.createElement('option');
                option.value = table.id;
                option.textContent = `Mesa ${table.number}${table.name ? ' - ' + table.name : ''}`;
                tableSelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error loading tables:', error);
        });
}

// Load available tables with offline support
function loadTables() {
    fetch('/api/tables?status=available', {
        credentials: 'same-origin'
    })
        .then(response => response.json())
        .then(tables => {
            const tableSelect = document.getElementById('table-select');
            tableSelect.innerHTML = '<option value="">Sin mesa asignada</option>';
            
            tables.forEach(table => {
                const option = document.createElement('option');
                option.value = table.id;
                option.textContent = `Mesa ${table.number}${table.name ? ' - ' + table.name : ''}`;
                tableSelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('[POS] Error loading tables:', error);
            if (!navigator.onLine) {
                showNotification('Cargando mesas desde caché offline...', 'info');
            }
        });
}

// Service Worker Registration
async function registerServiceWorker() {
    if ('serviceWorker' in navigator) {
        try {
            const registration = await navigator.serviceWorker.register('/static/sw.js');
            console.log('[SW] Service Worker registered successfully:', registration);
            
            // Listen for updates
            registration.addEventListener('updatefound', () => {
                const newWorker = registration.installing;
                newWorker.addEventListener('statechange', () => {
                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                        showNotification('Nueva versión disponible - recarga para actualizar', 'info');
                    }
                });
            });
            
            // Cache initial API data
            if (navigator.serviceWorker.controller) {
                refreshProductData();
            }
            
            return registration;
        } catch (error) {
            console.error('[SW] Service Worker registration failed:', error);
        }
    } else {
        console.log('[SW] Service Worker not supported');
    }
}

// Initialize POS System
async function initializePOS() {
    console.log('[POS] Initializing POS system...');
    
    // Initialize managers
    cartManager = new CartManager();
    connectionManager = new ConnectionManager();
    deviceDetector = new DeviceDetector();
    
    // Log device information for debugging
    deviceDetector.logDeviceInfo();
    
    // Register service worker
    await registerServiceWorker();
    
    // Load initial cart state
    updateCartDisplay();
    
    // Load products for the first category (default)
    const firstCategory = document.querySelector('[data-bs-toggle="pill"]');
    if (firstCategory) {
        const categoryId = firstCategory.getAttribute('data-bs-target').replace('#category-', '');
        loadProducts(categoryId);
    } else {
        // Fallback: load products for category 1 if no tabs found
        loadProducts(1);
    }
    
    // Load available tables
    loadTables();
    
    console.log('[POS] POS system initialized successfully');
    showNotification('Sistema POS iniciado - Modo offline disponible', 'success');
}

// Document ready event
document.addEventListener('DOMContentLoaded', initializePOS);

// Handle category tab changes
document.addEventListener('shown.bs.tab', function(e) {
    if (e.target.getAttribute('data-bs-toggle') === 'pill') {
        const categoryId = e.target.getAttribute('data-bs-target').replace('#category-', '');
        loadProducts(categoryId);
    }
});

// Handle page visibility change (for better power management)
document.addEventListener('visibilitychange', function() {
    if (document.visibilityState === 'visible') {
        // Page became visible, check connection and refresh if needed
        if (navigator.onLine && connectionManager) {
            connectionManager.onConnectionRestored();
        }
    }
});

// Prevent data loss on page unload
window.addEventListener('beforeunload', function(e) {
    // Cart is automatically saved via localStorage, but let's ensure it
    if (cartManager && cartManager.getItems().length > 0) {
        e.preventDefault();
        e.returnValue = 'Tienes productos en el carrito. ¿Estás seguro de que quieres salir?';
    }
});
</script>
{% endblock %}