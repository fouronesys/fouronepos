{% extends "base.html" %}

{% block title %}Panel Administrativo - Four One POS{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Modern Header -->
    <div class="row align-items-center mb-5">
        <div class="col">
            <h1 class="display-5 fw-bold mb-2">
                <i class="bi bi-speedometer2 me-3"></i>Panel Administrativo
            </h1>
            <p class="text-muted fs-5 mb-0">Resumen ejecutivo y acceso rápido</p>
        </div>
        <div class="col-auto">
            <div class="d-flex gap-2">
                <a href="{{ url_for('admin.pos') }}" class="btn btn-primary btn-lg px-4">
                    <i class="bi bi-cash-register me-2"></i>Punto de Venta
                </a>
                <a href="{{ url_for('admin.invoices') }}" class="btn btn-outline-primary btn-lg px-4">
                    <i class="bi bi-receipt me-2"></i>Facturas
                </a>
            </div>
        </div>
    </div>
    
    <!-- Enhanced Statistics Cards -->
    <div class="row g-4 mb-5">
        <div class="col-lg-3 col-md-6">
            <div class="stats-card">
                <div class="stats-label">Ventas del Día</div>
                <div class="stats-value">RD$ {{ "%.0f"|format(daily_sales) }}</div>
                <div class="d-flex align-items-center text-success">
                    <i class="bi bi-trending-up me-1"></i>
                    <small>+12% vs ayer</small>
                </div>
                <i class="bi bi-currency-dollar stats-icon"></i>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6">
            <div class="stats-card">
                <div class="stats-label">Transacciones</div>
                <div class="stats-value">{{ daily_transactions }}</div>
                <div class="d-flex align-items-center text-info">
                    <i class="bi bi-activity me-1"></i>
                    <small>{{ daily_transactions }} facturas</small>
                </div>
                <i class="bi bi-receipt stats-icon"></i>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6">
            <div class="stats-card">
                <div class="stats-label">Productos Bajo Stock</div>
                <div class="stats-value">{{ low_stock_products|length }}</div>
                <div class="d-flex align-items-center {% if low_stock_products|length > 0 %}text-warning{% else %}text-success{% endif %}">
                    <i class="bi bi-{% if low_stock_products|length > 0 %}exclamation-triangle{% else %}check-circle{% endif %} me-1"></i>
                    <small>{% if low_stock_products|length > 0 %}Requiere atención{% else %}Stock normal{% endif %}</small>
                </div>
                <i class="bi bi-box stats-icon"></i>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6">
            <div class="stats-card average-sale-card">
                <div class="stats-label">Promedio por Venta</div>
                <div class="stats-value average-sale-value">
                    RD$ {% if daily_transactions > 0 %}{{ "%.0f"|format(daily_sales / daily_transactions) }}{% else %}0{% endif %}
                </div>
                <div class="d-flex align-items-center text-info">
                    <i class="bi bi-calculator me-1"></i>
                    <small>Ticket promedio</small>
                </div>
                <i class="bi bi-graph-up stats-icon"></i>
            </div>
        </div>
    </div>
    
    <!-- Main Content Grid -->
    <div class="row g-4">
        <!-- Low Stock Products -->
        <div class="col-lg-8">
            {% if low_stock_products %}
            <div class="card">
                <div class="card-header d-flex align-items-center justify-content-between">
                    <h5 class="mb-0">
                        <i class="bi bi-exclamation-triangle text-warning me-2"></i>
                        Productos con Stock Bajo
                    </h5>
                    <span class="badge bg-warning text-dark px-3">{{ low_stock_products|length }} productos</span>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th>Stock Actual</th>
                                    <th>Stock Mínimo</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for product in low_stock_products %}
                                <tr>
                                    <td>{{ product.name }}</td>
                                    <td><span class="badge bg-danger">{{ product.stock }}</span></td>
                                    <td>{{ product.min_stock }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="card">
                <div class="card-body text-center py-5">
                    <i class="bi bi-check-circle-fill text-success fs-1 mb-3"></i>
                    <h5 class="text-success">¡Excelente!</h5>
                    <p class="text-muted">Todos los productos tienen stock suficiente</p>
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- Quick Actions Sidebar -->
        <div class="col-lg-4">
            <div class="row g-4">
                <!-- Quick Actions -->
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-lightning me-2"></i>Acciones Rápidas
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-3">
                                <a href="{{ url_for('admin.pos') }}" class="btn btn-primary btn-lg">
                                    <i class="bi bi-cash-register me-2"></i>
                                    Abrir Punto de Venta
                                </a>
                                <a href="{{ url_for('admin.tables') }}" class="btn btn-outline-success">
                                    <i class="bi bi-table me-2"></i>
                                    Gestión de Mesas
                                </a>
                                <a href="{{ url_for('admin.products') }}" class="btn btn-outline-primary">
                                    <i class="bi bi-boxes me-2"></i>
                                    Gestión de Productos
                                </a>
                                <a href="{{ url_for('admin.users') }}" class="btn btn-outline-info">
                                    <i class="bi bi-people me-2"></i>
                                    Gestión de Usuarios
                                </a>
                                <a href="{{ url_for('admin.customers') }}" class="btn btn-outline-success">
                                    <i class="bi bi-person-vcard me-2"></i>
                                    Gestión de Clientes
                                </a>
                                <a href="{{ url_for('admin.suppliers') }}" class="btn btn-outline-warning">
                                    <i class="bi bi-truck me-2"></i>
                                    Gestión de Proveedores
                                </a>
                                <a href="{{ url_for('inventory.purchases') }}" class="btn btn-outline-warning">
                                    <i class="bi bi-cart-plus me-2"></i>
                                    Módulo de Compras
                                </a>
                                <a href="{{ url_for('admin.company_settings') }}" class="btn btn-outline-light">
                                    <i class="bi bi-gear me-2"></i>
                                    Configuración de Empresa
                                </a>
                                <a href="{{ url_for('dgii.reports') }}" class="btn btn-outline-info">
                                    <i class="bi bi-file-earmark-text me-2"></i>
                                    Reportes DGII
                                </a>
                                <a href="{{ url_for('admin.ncf_sequences') }}" class="btn btn-outline-warning">
                                    <i class="bi bi-receipt-cutoff me-2"></i>
                                    Secuencias NCF
                                </a>
                                <a href="{{ url_for('admin.cash_registers') }}" class="btn btn-outline-secondary">
                                    <i class="bi bi-cash-register me-2"></i>
                                    Gestión de Cajas
                                </a>
                                <button class="btn btn-outline-secondary" onclick="showPaymentMethodsConfig()">
                                    <i class="bi bi-credit-card me-2"></i>
                                    Métodos de Pago
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Activity Feed -->
                {% if recent_sales %}
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex align-items-center justify-content-between">
                            <h5 class="mb-0">
                                <i class="bi bi-activity me-2"></i>Actividad Reciente
                            </h5>
                            <a href="{{ url_for('admin.invoices') }}" class="btn btn-sm btn-outline-primary">
                                Ver todas
                            </a>
                        </div>
                        <div class="card-body">
                            <div class="timeline">
                                {% for sale in recent_sales[:5] %}
                                <div class="timeline-item d-flex align-items-center mb-3">
                                    <div class="timeline-marker me-3">
                                        <div class="rounded-circle bg-success d-flex align-items-center justify-content-center" 
                                             style="width: 32px; height: 32px;">
                                            <i class="bi bi-check text-white small"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <div class="fw-medium">Venta #{{ sale.id }}</div>
                                                <small class="text-muted">
                                                    {{ sale.created_at.strftime('%H:%M') }}
                                                    {% if sale.user %}
                                                        • {{ sale.user.name }}
                                                    {% endif %}
                                                </small>
                                            </div>
                                            <span class="badge bg-success-subtle text-success">
                                                RD$ {{ "%.0f"|format(sale.total) }}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- System Status Footer -->
    <div class="row mt-5">
        <div class="col-12">
            <div class="card bg-transparent border-0">
                <div class="card-body text-center py-2">
                    <div class="d-flex justify-content-center align-items-center gap-4 text-muted small">
                        <div class="d-flex align-items-center">
                            <div class="bg-success rounded-circle me-2" style="width: 8px; height: 8px;"></div>
                            Sistema Activo
                        </div>
                        <div class="d-flex align-items-center">
                            <i class="bi bi-shield-check me-1"></i>
                            Cumplimiento DGII
                        </div>
                        <div class="d-flex align-items-center">
                            <i class="bi bi-clock me-1"></i>
                            Última actualización: Ahora
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Payment Methods Configuration Modal -->
<div class="modal fade" id="paymentMethodsModal" tabindex="-1" aria-labelledby="paymentMethodsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="paymentMethodsModalLabel">
                    <i class="bi bi-credit-card"></i> Configuración de Métodos de Pago
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <h6><i class="bi bi-cash-stack"></i> Efectivo</h6>
                                <p class="text-muted mb-3">Configuración para pagos en efectivo</p>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="enableCash" checked>
                                    <label class="form-check-label" for="enableCash">Habilitar pagos en efectivo</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="autoCalculateChange" checked>
                                    <label class="form-check-label" for="autoCalculateChange">Calcular cambio automáticamente</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <h6><i class="bi bi-credit-card"></i> Tarjetas</h6>
                                <p class="text-muted mb-3">Configuración para pagos con tarjeta</p>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="enableCard">
                                    <label class="form-check-label" for="enableCard">Habilitar pagos con tarjeta</label>
                                </div>
                                <div class="mt-2">
                                    <small class="text-muted">Integración con procesador de pagos pendiente</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <h6><i class="bi bi-bank"></i> Transferencias</h6>
                                <p class="text-muted mb-3">Configuración para transferencias bancarias</p>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="enableTransfer">
                                    <label class="form-check-label" for="enableTransfer">Habilitar transferencias bancarias</label>
                                </div>
                                <div class="mt-2">
                                    <input type="text" class="form-control form-control-sm" placeholder="Cuenta bancaria para transferencias">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" onclick="savePaymentMethodsConfig()">Guardar Configuración</button>
            </div>
        </div>
    </div>
</div>

<!-- Cash Management Modal -->
<div class="modal fade" id="cashManagementModal" tabindex="-1" aria-labelledby="cashManagementModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cashManagementModalLabel">
                    <i class="bi bi-cash-coin"></i> Gestión de Caja
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0"><i class="bi bi-unlock"></i> Apertura de Caja</h6>
                            </div>
                            <div class="card-body">
                                <p class="card-text">Registrar el monto inicial de efectivo en caja</p>
                                <div class="mb-3">
                                    <label for="openingAmount" class="form-label">Monto de Apertura</label>
                                    <input type="number" step="0.01" class="form-control" id="openingAmount" placeholder="0.00">
                                </div>
                                <div class="mb-3">
                                    <label for="openingNotes" class="form-label">Observaciones</label>
                                    <textarea class="form-control" id="openingNotes" rows="2"></textarea>
                                </div>
                                <button class="btn btn-success btn-sm w-100" onclick="openCashRegister()">
                                    <i class="bi bi-play-circle"></i> Abrir Caja
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header bg-danger text-white">
                                <h6 class="mb-0"><i class="bi bi-lock"></i> Cierre de Caja</h6>
                            </div>
                            <div class="card-body">
                                <p class="card-text">Realizar arqueo y cerrar caja</p>
                                <div class="mb-3">
                                    <label for="closingAmount" class="form-label">Efectivo Contado</label>
                                    <input type="number" step="0.01" class="form-control" id="closingAmount" placeholder="0.00">
                                </div>
                                <div class="mb-3">
                                    <label for="closingNotes" class="form-label">Observaciones</label>
                                    <textarea class="form-control" id="closingNotes" rows="2"></textarea>
                                </div>
                                <button class="btn btn-danger btn-sm w-100" onclick="closeCashRegister()">
                                    <i class="bi bi-stop-circle"></i> Cerrar Caja
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Cash Register Summary -->
                <div class="col-12 mt-4">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-journal-text"></i> Resumen de Caja del Día</h6>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-md-3">
                                    <div class="border rounded p-3">
                                        <h6 class="text-muted">Ventas en Efectivo</h6>
                                        <h4 class="text-success" id="cashSalesTotal">RD$ 0.00</h4>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="border rounded p-3">
                                        <h6 class="text-muted">Ventas con Tarjeta</h6>
                                        <h4 class="text-info" id="cardSalesTotal">RD$ 0.00</h4>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="border rounded p-3">
                                        <h6 class="text-muted">Transferencias</h6>
                                        <h4 class="text-warning" id="transferSalesTotal">RD$ 0.00</h4>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="border rounded p-3">
                                        <h6 class="text-muted">Total del Día</h6>
                                        <h4 class="text-primary" id="totalSales">RD$ 0.00</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-info" onclick="generateCashReport()">
                    <i class="bi bi-file-earmark-text"></i> Generar Reporte
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Show payment methods configuration modal
function showPaymentMethodsConfig() {
    const modal = new bootstrap.Modal(document.getElementById('paymentMethodsModal'));
    modal.show();
}

// Save payment methods configuration
function savePaymentMethodsConfig() {
    const config = {
        enableCash: document.getElementById('enableCash').checked,
        autoCalculateChange: document.getElementById('autoCalculateChange').checked,
        enableCard: document.getElementById('enableCard').checked,
        enableTransfer: document.getElementById('enableTransfer').checked
    };
    
    // Here you would save to backend
    localStorage.setItem('paymentMethodsConfig', JSON.stringify(config));
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('paymentMethodsModal'));
    modal.hide();
    
    showNotification('Configuración de métodos de pago guardada exitosamente', 'success');
}

// Show cash management - navigate to register assignment page
function showCashManagement() {
    // Navigate to the cash registers management page where users can assign and create registers
    window.location.href = '{{ url_for("admin.cash_registers") }}';
}

// Load cash summary for the day
async function loadCashSummary() {
    try {
        const response = await fetch('/api/sales/cash-summary');
        if (response.ok) {
            const data = await response.json();
            document.getElementById('cashSalesTotal').textContent = `RD$ ${data.cash_total.toFixed(2)}`;
            document.getElementById('cardSalesTotal').textContent = `RD$ ${data.card_total.toFixed(2)}`;
            document.getElementById('transferSalesTotal').textContent = `RD$ ${data.transfer_total.toFixed(2)}`;
            document.getElementById('totalSales').textContent = `RD$ ${data.total_sales.toFixed(2)}`;
        }
    } catch (error) {
        console.error('Error loading cash summary:', error);
    }
}

// Open cash register
function openCashRegister() {
    const amount = parseFloat(document.getElementById('openingAmount').value);
    const notes = document.getElementById('openingNotes').value;
    
    if (!amount || amount <= 0) {
        alert('Por favor ingresa un monto válido para la apertura');
        return;
    }
    
    // Here you would call the backend API
    showNotification(`Caja abierta con RD$ ${amount.toFixed(2)}`, 'success');
    
    // Clear form
    document.getElementById('openingAmount').value = '';
    document.getElementById('openingNotes').value = '';
}

// Close cash register
function closeCashRegister() {
    const amount = parseFloat(document.getElementById('closingAmount').value);
    const notes = document.getElementById('closingNotes').value;
    
    if (!amount || amount < 0) {
        alert('Por favor ingresa un monto válido para el cierre');
        return;
    }
    
    // Here you would call the backend API to close the register
    showNotification(`Caja cerrada con RD$ ${amount.toFixed(2)} en efectivo`, 'info');
    
    // Clear form
    document.getElementById('closingAmount').value = '';
    document.getElementById('closingNotes').value = '';
}

// Generate cash report
function generateCashReport() {
    const today = new Date().toISOString().split('T')[0];
    window.open(`/api/reports/cash-register?date=${today}`, '_blank');
}

// Utility function to show notifications
function showNotification(message, type = 'info') {
    // Simple alert for now - could be replaced with toast notifications
    alert(message);
}

// Load payment methods config on page load
document.addEventListener('DOMContentLoaded', function() {
    const config = localStorage.getItem('paymentMethodsConfig');
    if (config) {
        const settings = JSON.parse(config);
        document.getElementById('enableCash').checked = settings.enableCash !== false;
        document.getElementById('autoCalculateChange').checked = settings.autoCalculateChange !== false;
        document.getElementById('enableCard').checked = settings.enableCard || false;
        document.getElementById('enableTransfer').checked = settings.enableTransfer || false;
    }
});
</script>
{% endblock %}